MODULE MOD_RESIDUALPLOT

USE MOD_RESIDUALPLOT_PAR
USE WINTERACTER
USE MOD_IDF_PAR, ONLY : IDFOBJ
USE MOD_IDF, ONLY : IDFREAD,IDFWRITE,IDFNULLIFY,IDFDEALLOCATE
USE MOD_UTL

CONTAINS

!###===================================
SUBROUTINE RESIDUAL_MAIN(FNAME,IPLOT)
!###===================================
IMPLICIT NONE
INTEGER,INTENT(IN) :: IPLOT
CHARACTER(LEN=*),INTENT(IN) :: FNAME

CALL WindowOpen(FLAGS=HideWindow ) !TITLE='3D surface from (x,y,z) triplets')

!## read in complete txtfile
CALL RESIDUAL_DATA()
!## process txtfile into xyz variables
CALL RESIDUAL_PROC()
!## plot xyz variables
CALL RESIDUAL_PLOT()
!## clean
CALL RESIDUAL_CLEAN()

END SUBROUTINE RESIDUAL_MAIN

!###===================================
SUBROUTINE RESIDUAL_DATA()
!###===================================
IMPLICIT NONE
INTEGER :: I

!## loop 1: to get read all data: amount of ipf-files, get size of ipf-file and allocate arrays
!## loop 2: to fill IDF-object arrays with retrieved data
DO I=1,2 

ENDDO

END SUBROUTINE RESIDUAL_DATA

!###===================================
SUBROUTINE RESIDUAL_PROC()
!###===================================
IMPLICIT NONE

!## ff testset aanmaken
ALLOCATE(X(2),Y(2),Z(2))
X(1)=1.0; X(2)=2.0
Y(1)=2.0; Y(2)=1.0
Z(1)=3.0; Z(2)=4.0

END SUBROUTINE RESIDUAL_PROC

!###===================================
SUBROUTINE RESIDUAL_PLOT()
!###===================================
IMPLICIT NONE
INTEGER :: I,NSETS,IWIDTH,IHEIGHT,IPLOTBMP
INTEGER,DIMENSION(1) :: ICOLR
CHARACTER(LEN=256) :: BMPNAME

!## create bitmap
CALL WBITMAPCREATE(IPLOTBMP,500,500)
CALL IGRSELECT(DRAWBITMAP,IPLOTBMP)
CALL IGRAREA(0.100,0.100,0.900,0.900)

NSETS=1

!## plot data in scatterplot
IF(IPLOT.EQ.1)THEN
 CALL IPGNEWPLOT(PGSCATTERPLOT,NSETS,SIZE(X),PGLAYCOL,1)
 CALL IPGSTYLE(1,1,3,0,32,64,1)
 CALL IPGUNITS(0.0,0.0,1.0,1.0)
!## plot data in histogram
ELSEIF(IPLOT.EQ.2)THEN
 CALL IPGNEWPLOT(PGHISTOGRAM,NSETS,SIZE(X),PGLAYOVERLAP,1)
 CALL IPGSTYLE(1,4,2,0,32,64,1)
 CALL IPGUNITS(-5.0,0.0,5.0,1.0)
ENDIF

CALL IPGCLIPRECTANGLE('G')
CALL IPGAREA(0.100,0.100,0.900,0.900)
 
!## set grahpic layout settings
!## title
CALL WGRTEXTFONT(IFAMILY=FFCOURIER,ISTYLE=0,WIDTH=0.0133,HEIGHT=0.0333)
CALL IGRCOLOURN(223)
CALL IPGTITLEPOS(0.50)
CALL IPGTITLE('TITLE','C')
 
!## x-axis
CALL IPGXLABELPOS(0.70)
CALL IPGXLABEL('X AXIS','C') 
 
!## y-axis
CALL IPGYLABELPOS(0.80)
CALL IPGYLABELLEFT('Y AXIS','CV') 
 
!## draw actual axis
CALL IGRCOLOURN(223)
CALL IPGAXES() 
 
!## Adjust tick position for bottom X Axis
CALL IPGXTICKPOS(1) 
CALL IPGXTICKLENGTH(1.00)
CALL IPGDECIMALPLACES(-1)
CALL IPGXUSERSCALE(NPOINT=0)
CALL IPGXSCALEANGLE(0.00,0.00)
CALL IPGXSCALEPOS(0.38)
CALL IPGXSCALE('NT')
 
!## Adjust tick position for bottom Y Axis
CALL IPGYTICKPOS(1) 
CALL IPGYTICKLENGTH(1.00)
CALL IPGDECIMALPLACES(-1)
CALL IPGYUSERSCALE(NPOINT=0)
CALL IPGYSCALEANGLE(0.00,0.00)
CALL IPGYSCALEPOS(1.50)
CALL IPGYSCALELEFT('NT')
  
!## draw graph
IF(IPLOT.EQ.1)THEN
 CALL IPGSCATTERPLOT(X,Y,SIZE(X))
ELSEIF(IPLOT.EQ.2)THEN
 CALL IPGHISTOGRAM(X)
ENDIF

!## add legend to graph
CALL IPGKEYAREA(0.9,0.9,0.9,0.9) !1.000,1.000,0.000,0.000) 
!CALL IPGKEYALL((/'dataset1'/),'VC')

!## save graph
BMPNAME='d:\test.bmp'
!CALL WBITMAPPUT(IPLOTBMP,1,0)
CALL WBITMAPSAVE(IPLOTBMP,TRIM(BMPNAME))
CALL WBITMAPDESTROY(IPLOTBMP)

END SUBROUTINE RESIDUAL_PLOT

!###===================================
SUBROUTINE RESIDUAL_CLEAN()
!###===================================
IMPLICIT NONE
INTEGER :: I

IF(ALLOCATED(IPF))THEN
 DO I=1,SIZE(IPF)
  IF(ASSOCIATED(IPF(I)%D))DEALLOCATE(IPF(I)%D)
  IF(ASSOCIATED(IPF(I)%X))DEALLOCATE(IPF(I)%X)
  IF(ASSOCIATED(IPF(I)%Y))DEALLOCATE(IPF(I)%Y)
  IF(ASSOCIATED(IPF(I)%Z))DEALLOCATE(IPF(I)%Z)
  IF(ASSOCIATED(IPF(I)%O))DEALLOCATE(IPF(I)%O)
  IF(ASSOCIATED(IPF(I)%W))DEALLOCATE(IPF(I)%W)
  IF(ASSOCIATED(IPF(I)%L))DEALLOCATE(IPF(I)%L)
 ENDDO
 DEALLOCATE(IPF)
ENDIF
IF(ALLOCATED(X))DEALLOCATE(X)
IF(ALLOCATED(X))DEALLOCATE(Y)
IF(ALLOCATED(X))DEALLOCATE(Z)

END SUBROUTINE RESIDUAL_CLEAN

END MODULE MOD_RESIDUALPLOT