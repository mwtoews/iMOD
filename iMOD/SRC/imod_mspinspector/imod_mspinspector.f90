!!  Copyright (C) Stichting Deltares, 2005-2018.
!!
!!  This file is part of iMOD.
!!
!!  This program is free software: you can redistribute it and/or modify
!!  it under the terms of the GNU General Public License as published by
!!  the Free Software Foundation, either version 3 of the License, or
!!  (at your option) any later version.
!!
!!  This program is distributed in the hope that it will be useful,
!!  but WITHOUT ANY WARRANTY; without even the implied warranty of
!!  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
!!  GNU General Public License for more details.
!!
!!  You should have received a copy of the GNU General Public License
!!  along with this program.  If not, see <http://www.gnu.org/licenses/>.
!!
!!  Contact: imod.support@deltares.nl
!!  Stichting Deltares
!!  P.O. Box 177
!!  2600 MH Delft, The Netherlands.
!!
MODULE MOD_MSPINSPECTOR

USE WINTERACTER
USE RESOURCE
USE MOD_COLOURS
USE IMODVAR, ONLY : OFFSETX,OFFSETY
USE MOD_MSPINSPECTOR_PAR
USE MOD_MSPINSPECTOR_UTL
USE MOD_GRAPH
USE MOD_GRAPH_PAR
USE MOD_IDFPLOT, ONLY : IDFPLOT,IDFZOOM
USE MODPLOT, ONLY : MPW
USE MOD_PREF_PAR, ONLY : PREFVAL
USE MOD_DBL, ONLY : DBL_IGRRECTANGLE,DBL_IGRCIRCLE
USE MOD_IDF, ONLY : IDFNULLIFY,IDFALLOCATEX,IDFGETEDGE,IDFIROWICOL,IDFGETDXDY,IDFGETLOC,IDFCOPY,IDFWRITE
USE MOD_UTL, ONLY : UTL_GETUNIT,UTL_CAP,UTL_IMODFILLMENU,ITIMETOGDATE,RTOS,UTL_PLOT1BITMAP,UTL_PLOT2BITMAP,UTL_FILLDATES,LISTNAME,UTL_INVERSECOLOUR,UTL_GDATE
USE MOD_MAIN_UTL, ONLY : MAIN_UTL_INACTMODULE
USE MOD_POLINT, ONLY : POL1LOCATE,POL1LOCATEINT
USE DATEVAR
USE MOD_MANAGER_UTL, ONLY : MANAGER_UTL_ADDFILE
USE MOD_ASC2IDF, ONLY: ASC2IDF_IMPORTASC_MAIN
CONTAINS

 !###======================================================================
 SUBROUTINE MSPINSPECTOR_MAIN(ITYPE,MESSAGE)
 !###======================================================================
 IMPLICIT NONE
 TYPE(WIN_MESSAGE),INTENT(INOUT) :: MESSAGE
 INTEGER,INTENT(IN) :: ITYPE

  SELECT CASE (MESSAGE%WIN)

  CASE (ID_DMSPANALYSER_TAB1); CALL MSPINSPECTOR_TAB1(ITYPE,MESSAGE)

  CASE (ID_DMSPANALYSER_TAB2); CALL MSPINSPECTOR_TAB2(ITYPE,MESSAGE)

  CASE (ID_DMSPANALYSER_TAB3); CALL MSPINSPECTOR_TAB3(ITYPE,MESSAGE)

  CASE (ID_DMSPANALYSER_TAB4); CALL MSPINSPECTOR_TAB4(ITYPE,MESSAGE)

  CASE (ID_DMSPANALYSER_TAB5); CALL MSPINSPECTOR_TAB5(ITYPE,MESSAGE)

  CASE (ID_DMSPANALYSER)
   SELECT CASE (ITYPE)

    !## case tab changed
    CASE (TABCHANGED)
     SELECT CASE (MESSAGE%VALUE1)
     END SELECT

    !## case field changed
    CASE (FIELDCHANGED)
     CALL MSPINSPECTOR_MAIN_FIELDS()

    !## pushbutton
    CASE (PUSHBUTTON)
     SELECT CASE (MESSAGE%VALUE1)
      CASE(IDOK)
       CALL MSPINSPECTOR_GETXY()

      CASE (IDHELP)
          ! CALL UTL_GETHELP('4.4.3.3','MMO.IGO.IE.Search')
      CASE (IDCANCEL)
       CALL MSPINSPECTOR_CLOSE()
     END SELECT
   END SELECT
 END SELECT

 END SUBROUTINE MSPINSPECTOR_MAIN

 !###======================================================================
 SUBROUTINE MSPINSPECTOR_TAB1(ITYPE,MESSAGE)
 !###======================================================================
 IMPLICIT NONE
 TYPE(WIN_MESSAGE),INTENT(INOUT) :: MESSAGE
 INTEGER,INTENT(IN) :: ITYPE
 INTEGER :: I

 SELECT CASE (ITYPE)

  !## case field changed
  CASE (FIELDCHANGED)
   IF(MESSAGE%VALUE1.EQ.MESSAGE%VALUE2)THEN
    SELECT CASE (MESSAGE%VALUE1)
     CASE (IDF_RADIO1,IDF_RADIO2,IDF_STRING1)
      CALL MSPINSPECTOR_TAB1_FIELDS()
     CASE (IDF_MENU1)
      CALL MSPINSPECTOR_OPENFILES_FIELDS(0)
    END SELECT
   ENDIF

  !## pushbutton
  CASE (PUSHBUTTON)

   SELECT CASE (MESSAGE%VALUE1)

    !## select folder
    CASE (ID_SELECT)
     ROOT=TRIM(PREFVAL(1))//'\MODEL\'
     CALL WSELECTDIR(DIRCHANGE,ROOT,'Select Model Result Directory')
     IF(WINFODIALOG(4).EQ.1)THEN
      CALL WDIALOGSELECT(ID_DMSPANALYSER_TAB1); CALL WDIALOGPUTSTRING(IDF_STRING1,TRIM(ROOT))
      CALL MSPINSPECTOR_FILL_FOLDERLIST()
     ENDIF

    !## read files
    CASE (ID_OPEN)
     I=1; IF(.NOT.MSPINSPECTOR_OPENFILES())THEN; I=0; CALL MSPINSPECTOR_DEALLOCATE(); ENDIF
     CALL MSPINSPECTOR_OPENFILES_FIELDS(I)

    !## zoom to full extent
    CASE (ID_ZOOMFULL)
     MPW%XMIN=MSPIDF%XMIN; MPW%XMAX=MSPIDF%XMAX; MPW%YMIN=MSPIDF%YMIN; MPW%YMAX=MSPIDF%YMAX
     CALL IDFZOOM(ID_DGOTOXY,0.0D0,0.0D0,0); CALL IDFPLOT(1)
   END SELECT

 END SELECT

 END SUBROUTINE MSPINSPECTOR_TAB1

 !###======================================================================
 SUBROUTINE MSPINSPECTOR_TAB2(ITYPE,MESSAGE)
 !###======================================================================
 IMPLICIT NONE
 TYPE(WIN_MESSAGE),INTENT(INOUT) :: MESSAGE
 INTEGER,INTENT(IN) :: ITYPE

 SELECT CASE (ITYPE)

  !## case field changed
  CASE (FIELDCHANGED)
   CALL MSPINSPECTOR_TAB2_FIELDS()

  !## pushbutton
  CASE (PUSHBUTTON)
   SELECT CASE (MESSAGE%VALUE1)
   END SELECT
 END SELECT

 END SUBROUTINE MSPINSPECTOR_TAB2

  !###======================================================================
 SUBROUTINE MSPINSPECTOR_TAB3(ITYPE,MESSAGE)
 !###======================================================================
 IMPLICIT NONE
 TYPE(WIN_MESSAGE),INTENT(INOUT) :: MESSAGE
 INTEGER,INTENT(IN) :: ITYPE

 SELECT CASE (ITYPE)

  !## case field changed
  CASE (FIELDCHANGED)
   CALL MSPINSPECTOR_TAB3_FIELDS()

  !## pushbutton
  CASE (PUSHBUTTON)
   SELECT CASE (MESSAGE%VALUE1)
    !## draw graph of selected features
    CASE(ID_GRAPH)
     CALL MSPINSPECTOR_TAB3_GRAPH()
    CASE(ID_CREATEIDF)
     CALL MSPINSPECTOR_TAB3_CREATEIDF()
   END SELECT
 END SELECT

 END SUBROUTINE MSPINSPECTOR_TAB3

  !###======================================================================
 SUBROUTINE MSPINSPECTOR_TAB3_GRAPH()
 !###======================================================================
 IMPLICIT NONE
 INTEGER :: II,I,J,K,M,N,NXG,WID

! IF(ISELECTED.LE.0)THEN
!  CALL WMESSAGEBOX(OKONLY,EXCLAMATIONICON,COMMONOK,'You need to select a borehole first.','Error')
!  RETURN
! ENDIF

 WID=WINFODIALOG(CURRENTDIALOG)

 !## call stuff to be plotted

 !## number of lines to be combined
 M=1
 !## number of graphs/groups - seperate of at the same moment (all or not all)
 N=1
 !# number of serie points
 NXG=10
 CALL GRAPH_DEALLOCATE(); CALL GRAPH_ALLOCATE(M,N)
 DO J=1,N
  DO I=1,M
   ALLOCATE(GRAPH(I,J)%RX(NXG),GRAPH(I,J)%RY(NXG))
   GRAPH(I,J)%RX=0.0D0; GRAPH(I,J)%RY=0.0D0; GRAPH(I,J)%NP=NXG; GRAPH(I,J)%CTYPE=''; GRAPH(I,J)%ICLR=0; GRAPH(I,J)%GTYPE=4
   DO K=1,NXG
    GRAPH(I,J)%RX(K)=DBLE(K)
    CALL RANDOM_NUMBER(GRAPH(I,J)%RY(K))
   ENDDO
   GRAPH(I,J)%ICLR=COLOUR_RANDOM()
   GRAPH(I,J)%LEGTXT='LEGEND '//TRIM(ITOS(I))//':'//TRIM(ITOS(J))
   GRAPH(I,J)%GTYPE=2
  ENDDO
  GRAPHDIM(J)%GRAPHNAMES='Graph '//TRIM(ITOS(II))
 ENDDO

 !## add custom predefined axes titles
 GRAPHDIM(1)%IFIXX=0; GRAPHDIM(1)%IFIXY=0
! ALLOCATE(GRAPHDIM(1)%XTXT(NXG),GRAPHDIM(1)%YTXT(NXG),GRAPHDIM(1)%XPOS(NXG)); GRAPHDIM(1)%XPOS=0.0D0; GRAPHDIM(1)%IFIXX=1

! !## set axes dimensions
! GRAPHDIM(1)%XINT=1.0D0; GRAPHDIM(1)%XMIN=GRAPHDIM(1)%XPOS(1)-1.0D0; GRAPHDIM(1)%XMAX=GRAPHDIM(1)%XPOS(NXG)+1.0D0

! GRAPH(1,1)%RX=0.0D0
! GRAPH(1,1)%RY=0.0D0

! END DO

! !## make sure last is equal to final-least
! GRAPH(1,1)%NP=1
 GRAPH%IGRAPH=1
 GRAPHDIM(1)%XTITLE='[-]'; GRAPHDIM(1)%YTITLE='Depth (m+MSL)'; GRAPHDIM(1)%LDATE=.FALSE.
 GRAPHDIM(1)%GRAPHNAMES='DSDS'
 CALL GRAPH_INIT(LMULT=.TRUE.)
! CALL GRAPH_PLOT(LMULT=.TRUE.)

! CALL GRAPH_DEALLOCATE()
 CALL WDIALOGSELECT(WID)

 END SUBROUTINE MSPINSPECTOR_TAB3_GRAPH

  !###======================================================================
 SUBROUTINE MSPINSPECTOR_TAB3_CREATEIDF()
 !###======================================================================
 IMPLICIT NONE
 INTEGER :: I,J,JCOL,JROW,NPRGS,IPRGS

 !## open progress bar
 NPRGS= 10
 CALL WDIALOGLOAD(ID_DIRPROGRESS,ID_DIRPROGRESS)
 CALL WDIALOGSELECT(ID_DIRPROGRESS)
 CALL WDIALOGPUTSTRING(IDF_GROUP1,'Creating IDF files')
 CALL WDIALOGRANGEPROGRESSBAR(IDF_PROGRESS1,0,NPRGS)
 CALL WDIALOGPUTPROGRESSBAR(IDF_PROGRESS1,0,ABSOLUTE)
 CALL WDIALOGSHOW(-1,-1,0,3)
 
 IPRGS=0
 IPRGS=IPRGS+1 ; CALL WDIALOGSELECT(ID_DIRPROGRESS) ; CALL WDIALOGPUTPROGRESSBAR(IDF_PROGRESS1,IPRGS,0) ; CALL WDIALOGPUTSTRING(IDF_LABEL1,'file .....')

 IF(.NOT.IDFWRITE(SVATRU,TRIM(ROOT)//'\'//TRIM(MNAME)//'\SVATRU.idf',1))THEN ; ENDIF
 IF(.NOT.IDFWRITE(SVATUR,TRIM(ROOT)//'\'//TRIM(MNAME)//'\SVATUR.idf',1))THEN ; ENDIF
 IF(.NOT.IDFWRITE(SVATIR,TRIM(ROOT)//'\'//TRIM(MNAME)//'\SVATIR.idf',1))THEN ; ENDIF

 !## irigation
 CALL IDFCOPY(MSPIDF,MSPSCAPSVAT)
 MSPSCAPSVAT%X=0
 ! reuse script
 ! from   SUBROUTINE IMODBATCH_CREATEIDF_MAIN()   
 ! --> roept aan  CALL ASC2IDF_IMPORTASC_MAIN(DIRNAME,TOPWC,BOTEL,MULT,ADD,1)
! --> roept aan        ASC2IDF_IMPORTASC(IDFNAMES(I),TOP,BOT,IERROR,IBATCH)
 ! --> ASC2IDF_IMPORTASC_TYPE1(IU,IDFNAME,TOP,BOT,IBATCH)

 !IF(SCAPSVAT%INFO(N)%NUND.GT.0)THEN ;   CALL MSPINSPECTOR_SVAT2ROWCOL(SCAPSVAT%INFO(N)%NUND,JROW,JCOL,J)   ; MSPSCAPSVAT%X(JCOL,JROW)=MSPSCAPSVAT%X(JCOL,JROW) + 1.   ; ENDIF
 !IF(SCAPSVAT%INFO(N)%SVATAB.GT.0)THEN ; CALL MSPINSPECTOR_SVAT2ROWCOL(SCAPSVAT%INFO(N)%SVATAB,JROW,JCOL,J) ; MSPSCAPSVAT%X(JCOL,JROW)=MSPSCAPSVAT%X(JCOL,JROW) + 100. ; ENDIF
 !idf%x=info(:,:,1)%area

 IF(.NOT.IDFWRITE(MSPSCAPSVAT,TRIM(ROOT)//'\'//TRIM(MNAME)//'\MSPSCAPSVAT.idf',1))THEN ; ENDIF

 !## landuse
 CALL IDFCOPY(MSPIDF,MSPLUSE)
 MSPLUSE%X=0
 DO I=1,AREASVAT%MXID
   DO J=AREASVAT%INFO(I)%NUND,MODSVAT%MXID           !NB diferent start point to speed up the search 
     IF(AREASVAT%INFO(I)%NUND.EQ.MODSVAT%INFO(J)%SVATID)THEN
         JROW=MODSVAT%INFO(J)%IROW
         JCOL=MODSVAT%INFO(J)%ICOL
         IF(MSPLUSE%X(JCOL,JROW).EQ.0) MSPLUSE%X(JCOL,JROW)=AREASVAT%INFO(I)%LUSE 
         EXIT
     ENDIF    
   ENDDO      
 ENDDO        

 IF(.NOT.IDFWRITE(MSPLUSE,TRIM(ROOT)//'\'//TRIM(MNAME)//'\MSPLUSE.idf',1))THEN ; ENDIF
 CALL WDIALOGUNLOAD()
 CALL MANAGER_UTL_ADDFILE(IDFNAMEGIVEN=TRIM(ROOT)//'\'//TRIM(MNAME)//'\MSPLUSE.idf')

 !## Meteo

 IF(.NOT.IDFWRITE(METEO,TRIM(ROOT)//'\'//TRIM(MNAME)//'\METEO_DIM.idf',1))THEN ; ENDIF
 CALL MANAGER_UTL_ADDFILE(IDFNAMEGIVEN=TRIM(ROOT)//'\'//TRIM(MNAME)//'\METEO_DIM.idf')

 END SUBROUTINE MSPINSPECTOR_TAB3_CREATEIDF

 !###======================================================================
 SUBROUTINE MSPINSPECTOR_TAB4(ITYPE,MESSAGE)
 !###======================================================================
 IMPLICIT NONE
 TYPE(WIN_MESSAGE),INTENT(INOUT) :: MESSAGE
 INTEGER,INTENT(IN) :: ITYPE

 SELECT CASE (ITYPE)

  !## case field changed
  CASE (FIELDCHANGED)
   CALL MSPINSPECTOR_TAB4_FIELDS()

  !## pushbutton
  CASE (PUSHBUTTON)
   SELECT CASE (MESSAGE%VALUE1)
   END SELECT
 END SELECT

 END SUBROUTINE MSPINSPECTOR_TAB4

  !###======================================================================
 SUBROUTINE MSPINSPECTOR_TAB5(ITYPE,MESSAGE)
 !###======================================================================
 IMPLICIT NONE
 TYPE(WIN_MESSAGE),INTENT(INOUT) :: MESSAGE
 INTEGER,INTENT(IN) :: ITYPE

  SELECT CASE (ITYPE)

  !## case field changed
  CASE (FIELDCHANGED)
   IF(MESSAGE%VALUE1.EQ.MESSAGE%VALUE2)THEN
    SELECT CASE (MESSAGE%VALUE1)
     CASE (IDF_RADIO1,IDF_RADIO2,IDF_INTEGER2,IDF_MENU5,IDF_INTEGER1,IDF_INTEGER12,IDF_MENU6,IDF_INTEGER11)
      CALL MSPINSPECTOR_TAB5_FIELDS()
     CASE (IDF_MENU1)
      CALL MSPINSPECTOR_TAB5_PUTPARAMLIST()
     CASE (IDF_MENU2)
      CALL MSPINSPECTOR_TAB5_GETPARAMLIST()
      CALL MSPINSPECTOR_TAB3_PUTPARAMLIST()
    END SELECT
   ENDIF

  !## pushbutton
  CASE (PUSHBUTTON)
   SELECT CASE (MESSAGE%VALUE1)
    !## load en save van settings file
     CASE (ID_OPEN,ID_SAVE)
       CALL MSPINSPECTOR_TAB5_SETTINGS(MESSAGE%VALUE1)       
       CALL MSPINSPECTOR_TAB3_PUTPARAMLIST()
   END SELECT
 END SELECT

 END SUBROUTINE MSPINSPECTOR_TAB5

  !###======================================================================
 SUBROUTINE MSPINSPECTOR_TAB5_SETTINGS(CODE,FNAME)
 !###======================================================================
 IMPLICIT NONE
 INTEGER,INTENT(IN) :: CODE
 CHARACTER(LEN=*),INTENT(IN),OPTIONAL :: FNAME
 CHARACTER(LEN=256) :: NAMES
 INTEGER :: IU,IOS,TOS,ILIST,I
 LOGICAL :: LEX

 !## save
 IF(CODE.EQ.ID_SAVE)THEN

  IF(.NOT.PRESENT(FNAME))THEN
   NAMES=TRIM(PREFVAL(1))//'\settings\*.ims'
   IF(.NOT.UTL_WSELECTFILE('iMOD metaSWAP Settings File (*.ims)|*.ims|',&
                   SAVEDIALOG+PROMPTON+DIRCHANGE+APPENDEXT,NAMES,&
                     'Save metaSWAP Settings File (*.ims)'))RETURN
  ELSE
   NAMES=FNAME
  ENDIF

  IU=UTL_GETUNIT()
  CALL OSD_OPEN(IU,FILE=NAMES,STATUS='UNKNOWN')
  WRITE(IU,'(A)') 'Settings file for the metaSWAP analyser containing KEY words' 

  WRITE(IU,'(/A)') ' *******  File settings *******' 
  CALL WDIALOGSELECT(ID_DMSPANALYSER_TAB5)
  CALL WDIALOGGETMENU(IDF_MENU3,ILIST)
  WRITE(IU,'(A)') 'METEO= '//TRIM(ITOS(ILIST))//'           !## Handling Meteo Data'
  CALL WDIALOGGETMENU(IDF_MENU4,ILIST)
  WRITE(IU,'(A)') 'SCREENDUMP= '//TRIM(ITOS(ILIST))//'      !## Screendump format'

  WRITE(IU,'(/A)') ' *******  Date settings *******' 
  CALL WDIALOGGETINTEGER(IDF_INTEGER1,ILIST)
  WRITE(IU,'(A)') 'SDAY= '//TRIM(ITOS(ILIST))//'            !## Start Day'
  CALL WDIALOGGETMENU(IDF_MENU5,ILIST)
  WRITE(IU,'(A)') 'SMONTH= '//TRIM(ITOS(ILIST))//'          !## Start Month'
  CALL WDIALOGGETINTEGER(IDF_INTEGER2,ILIST)
  WRITE(IU,'(A)') 'SYEAR= '//TRIM(ITOS(ILIST))//'           !## Start Year'

  CALL WDIALOGGETINTEGER(IDF_INTEGER11,ILIST)
  WRITE(IU,'(A)') 'EDAY= '//TRIM(ITOS(ILIST))//'            !## End Day'
  CALL WDIALOGGETMENU(IDF_MENU6,ILIST)
  WRITE(IU,'(A)') 'EMONTH= '//TRIM(ITOS(ILIST))//'          !## End Month'
  CALL WDIALOGGETINTEGER(IDF_INTEGER12,ILIST)
  WRITE(IU,'(A)') 'EYEAR= '//TRIM(ITOS(ILIST))//'           !## End Year'
  
  WRITE(IU,'(/A)') ' *******  Parameter settings *******' 
  !## NB this block changes whenever order MSFILES changes!
  DO I=1,SIZE(DXC%IACT)      ; WRITE(IU,'(A)') TRIM(MSFILES(1))//'_'//TRIM(ITOS(I))//' = '//TRIM(ITOS(DXC%IACT(I)))  ; END DO
  DO I=1,SIZE(IDFSVAT%IACT)  ; WRITE(IU,'(A)') TRIM(MSFILES(2))//'_'//TRIM(ITOS(I))//' = '//TRIM(ITOS(IDFSVAT%IACT(I)))  ; END DO
  DO I=1,SIZE(MODSVAT%IACT)  ; WRITE(IU,'(A)') TRIM(MSFILES(3))//'_'//TRIM(ITOS(I))//' = '//TRIM(ITOS(MODSVAT%IACT(I)))  ; END DO
  DO I=1,SIZE(AREASVAT%IACT) ; WRITE(IU,'(A)') TRIM(MSFILES(4))//'_'//TRIM(ITOS(I))//' = '//TRIM(ITOS(AREASVAT%IACT(I)))  ; END DO
  DO I=1,SIZE(LUSESVAT%IACT) ; WRITE(IU,'(A)') TRIM(MSFILES(5))//'_'//TRIM(ITOS(I))//' = '//TRIM(ITOS(LUSESVAT%IACT(I)))  ; END DO
  DO I=1,SIZE(FACTSVAT%IACT) ; WRITE(IU,'(A)') TRIM(MSFILES(6))//'_'//TRIM(ITOS(I))//' = '//TRIM(ITOS(FACTSVAT%IACT(I)))  ; END DO
  DO I=1,SIZE(INFISVAT%IACT) ; WRITE(IU,'(A)') TRIM(MSFILES(7))//'_'//TRIM(ITOS(I))//' = '//TRIM(ITOS(INFISVAT%IACT(I)))  ; END DO
  DO I=1,SIZE(SCAPSVAT%IACT) ; WRITE(IU,'(A)') TRIM(MSFILES(8))//'_'//TRIM(ITOS(I))//' = '//TRIM(ITOS(SCAPSVAT%IACT(I)))  ; END DO
  DO I=1,SIZE(METEGRID%IACT) ; WRITE(IU,'(A)') TRIM(MSFILES(9))//'_'//TRIM(ITOS(I))//' = '//TRIM(ITOS(METEGRID%IACT(I)))  ; END DO

  CLOSE(IU)

 !## read
 ELSEIF(CODE.EQ.ID_OPEN)THEN

  IF(.NOT.PRESENT(FNAME))THEN
   NAMES=TRIM(PREFVAL(1))//'\settings\*.ims'
   IF(.NOT.UTL_WSELECTFILE('iMOD metaSWAP Settings File (*.ims)|*.ims|',&
                  LOADDIALOG+MUSTEXIST+PROMPTON+DIRCHANGE+APPENDEXT+MULTIFILE,NAMES,&
                    'Load metaSWAP Settings File (*.ims)'))RETURN
  ELSE
   NAMES=FNAME
   INQUIRE(FILE=NAMES,EXIST=LEX)
   IF(.NOT.LEX)RETURN
  ENDIF

  IU=UTL_GETUNIT()
  CALL OSD_OPEN(IU,FILE=NAMES,STATUS='UNKNOWN')

  CALL WDIALOGSELECT(ID_DMSPANALYSER_TAB5)

  IF(UTL_READINITFILE('METEO',LINE,IU,1))       READ(LINE,*) ILIST ;   CALL WDIALOGPUTOPTION(IDF_MENU3,ILIST)
  IF(UTL_READINITFILE('SCREENDUMP',LINE,IU,1))  READ(LINE,*) ILIST ;   CALL WDIALOGPUTOPTION(IDF_MENU4,ILIST)

  IF(UTL_READINITFILE('SDAY',LINE,IU,1))        READ(LINE,*) ILIST ;   CALL WDIALOGPUTINTEGER(IDF_INTEGER1,ILIST)
  IF(UTL_READINITFILE('SMONTH',LINE,IU,1))      READ(LINE,*) ILIST ;   CALL WDIALOGPUTOPTION(IDF_MENU5,ILIST)
  IF(UTL_READINITFILE('SYEAR',LINE,IU,1))       READ(LINE,*) ILIST ;   CALL WDIALOGPUTINTEGER(IDF_INTEGER2,ILIST)
  IF(UTL_READINITFILE('EDAY',LINE,IU,1))        READ(LINE,*) ILIST ;   CALL WDIALOGPUTINTEGER(IDF_INTEGER11,ILIST)
  IF(UTL_READINITFILE('EMONTH',LINE,IU,1))      READ(LINE,*) ILIST ;   CALL WDIALOGPUTOPTION(IDF_MENU6,ILIST)
  IF(UTL_READINITFILE('EYEAR',LINE,IU,1))       READ(LINE,*) ILIST ;   CALL WDIALOGPUTINTEGER(IDF_INTEGER12,ILIST)

  !## NB this block changes whenever order MSFILES changes!
  DO I=1,SIZE(DXC%IACT)      ; IF(UTL_READINITFILE(TRIM(MSFILES(1))//'_'//TRIM(ITOS(I)),LINE,IU,1)) READ(LINE,*) DXC%IACT(I) ; END DO
  DO I=1,SIZE(MODSVAT%IACT)  ; IF(UTL_READINITFILE(TRIM(MSFILES(2))//'_'//TRIM(ITOS(I)),LINE,IU,1)) READ(LINE,*) MODSVAT%IACT(I) ; END DO
  DO I=1,SIZE(IDFSVAT%IACT)  ; IF(UTL_READINITFILE(TRIM(MSFILES(3))//'_'//TRIM(ITOS(I)),LINE,IU,1)) READ(LINE,*) IDFSVAT%IACT(I) ; END DO
  DO I=1,SIZE(AREASVAT%IACT) ; IF(UTL_READINITFILE(TRIM(MSFILES(4))//'_'//TRIM(ITOS(I)),LINE,IU,1)) READ(LINE,*) AREASVAT%IACT(I) ; END DO
  DO I=1,SIZE(LUSESVAT%IACT) ; IF(UTL_READINITFILE(TRIM(MSFILES(5))//'_'//TRIM(ITOS(I)),LINE,IU,1)) READ(LINE,*) LUSESVAT%IACT(I) ; END DO
  DO I=1,SIZE(FACTSVAT%IACT) ; IF(UTL_READINITFILE(TRIM(MSFILES(6))//'_'//TRIM(ITOS(I)),LINE,IU,1)) READ(LINE,*) FACTSVAT%IACT(I) ; END DO
  DO I=1,SIZE(INFISVAT%IACT) ; IF(UTL_READINITFILE(TRIM(MSFILES(7))//'_'//TRIM(ITOS(I)),LINE,IU,1)) READ(LINE,*) INFISVAT%IACT(I) ; END DO
  DO I=1,SIZE(SCAPSVAT%IACT) ; IF(UTL_READINITFILE(TRIM(MSFILES(8))//'_'//TRIM(ITOS(I)),LINE,IU,1)) READ(LINE,*) SCAPSVAT%IACT(I) ; END DO
  DO I=1,SIZE(METEGRID%IACT) ; IF(UTL_READINITFILE(TRIM(MSFILES(9))//'_'//TRIM(ITOS(I)),LINE,IU,1)) READ(LINE,*) METEGRID%IACT(I) ; END DO

  CLOSE(IU)

  CALL MSPINSPECTOR_TAB5_PUTPARAMLIST
  
 ENDIF

 END SUBROUTINE MSPINSPECTOR_TAB5_SETTINGS

 
 !###======================================================================
 SUBROUTINE MSPINSPECTOR_FILL_FOLDERLIST()
 !###======================================================================
 IMPLICIT NONE
 INTEGER :: N,I

 CALL WDIALOGSELECT(ID_DMSPANALYSER_TAB1)

 CALL WDIALOGGETRADIOBUTTON(IDF_RADIO1,I)
 IF(I.EQ.1)THEN
  CALL WDIALOGGETSTRING(IDF_STRING1,ROOT)
 ELSE
  !## defaut root in iMOD is models
  ROOT=TRIM(PREFVAL(1))//'\MODELS'
 ENDIF

 CALL UTL_IMODFILLMENU(IDF_MENU1,TRIM(ROOT),'*','D',N,0,0)

 !## disable fields
 N=MAX(0,MIN(1,N)); CALL WDIALOGFIELDSTATE(ID_OPEN,N)

 END SUBROUTINE MSPINSPECTOR_FILL_FOLDERLIST

 !###======================================================================
 SUBROUTINE MSPINSPECTOR_TAB3_PUTPARAMLIST()
 !###======================================================================
 IMPLICIT NONE
 INTEGER :: N,I,J,K

 CALL WDIALOGSELECT(ID_DMSPANALYSER_TAB3)
 CALL WGRIDCLEAR(IDF_GRID1)

 !## Time dependant parameters: METEGRID (PRECGRID,ETREFGRID) / FACTSVAT (all) / LUSESVAT (Feddes Function?) / 
 !## determine number of rows active
 DO K=1,2

  N=0; J=0 ; TAB3GRIDSIZE=0
  !## same order as in MSFILES
  DO I=1,SIZE(DXC%LABEL);      IF(DXC%IACT(I).EQ.0)CYCLE      ; N=N+1; J=J+1; 
     IF(K.EQ.2)THEN ; CALL WGRIDPUTCELLSTRING(IDF_GRID1,1,J,DXC%LABEL(I))     ; CALL WGRIDPUTCELLSTRING(IDF_GRID1,3,J,DXC%UNIT(I))     ; CALL WGRIDPUTCELLOPTION(IDF_GRID1,4,J,0); ENDIF ; END DO
  DO I=1,SIZE(MODSVAT%LABEL);  IF(MODSVAT%IACT(I).EQ.0)CYCLE  ; N=N+1; J=J+1;  
     IF(K.EQ.2)THEN ; CALL WGRIDPUTCELLSTRING(IDF_GRID1,1,J,MODSVAT%LABEL(I)) ; CALL WGRIDPUTCELLSTRING(IDF_GRID1,3,J,MODSVAT%UNIT(I))  ; CALL WGRIDPUTCELLOPTION(IDF_GRID1,4,J,0); ENDIF ; END DO
  DO I=1,SIZE(IDFSVAT%LABEL);  IF(IDFSVAT%IACT(I).EQ.0)CYCLE  ; N=N+1; J=J+1; 
     IF(K.EQ.2)THEN ; CALL WGRIDPUTCELLSTRING(IDF_GRID1,1,J,IDFSVAT%LABEL(I)) ; CALL WGRIDPUTCELLSTRING(IDF_GRID1,3,J,IDFSVAT%UNIT(I))  ; CALL WGRIDPUTCELLOPTION(IDF_GRID1,4,J,0); ENDIF ; END DO
  DO I=1,SIZE(AREASVAT%LABEL); IF(AREASVAT%IACT(I).EQ.0)CYCLE ; N=N+1; J=J+1; 
     IF(K.EQ.2)THEN ; CALL WGRIDPUTCELLSTRING(IDF_GRID1,1,J,AREASVAT%LABEL(I)); CALL WGRIDPUTCELLSTRING(IDF_GRID1,3,J,AREASVAT%UNIT(I)) ; CALL WGRIDPUTCELLOPTION(IDF_GRID1,4,J,0); ENDIF ; END DO
  DO I=1,SIZE(LUSESVAT%LABEL); IF(LUSESVAT%IACT(I).EQ.0)CYCLE ; N=N+1; J=J+1; 
     IF(K.EQ.2)THEN ; CALL WGRIDPUTCELLSTRING(IDF_GRID1,1,J,LUSESVAT%LABEL(I)); CALL WGRIDPUTCELLSTRING(IDF_GRID1,3,J,LUSESVAT%UNIT(I)) ; CALL WGRIDPUTCELLOPTION(IDF_GRID1,4,J,0); ENDIF ; END DO
  DO I=1,SIZE(FACTSVAT%LABEL); IF(FACTSVAT%IACT(I).EQ.0)CYCLE ; N=N+1; J=J+1; 
     IF(K.EQ.2)THEN ; CALL WGRIDPUTCELLSTRING(IDF_GRID1,1,J,FACTSVAT%LABEL(I)); CALL WGRIDPUTCELLSTRING(IDF_GRID1,3,J,FACTSVAT%UNIT(I)) 
                      CALL WGRIDSTATECELL(IDF_GRID1,4,J,MAX((0-FACTSVAT%GRAPH(I)),-1)+2) ; CALL WGRIDPUTCELLOPTION(IDF_GRID1,4,J,FACTSVAT%GRAPH(I)); ENDIF ; END DO
  DO I=1,SIZE(INFISVAT%LABEL); IF(INFISVAT%IACT(I).EQ.0)CYCLE ; N=N+1; J=J+1; 
     IF(K.EQ.2)THEN ; CALL WGRIDPUTCELLSTRING(IDF_GRID1,1,J,INFISVAT%LABEL(I)); CALL WGRIDPUTCELLSTRING(IDF_GRID1,3,J,INFISVAT%UNIT(I)) ; CALL WGRIDPUTCELLOPTION(IDF_GRID1,4,J,0); ENDIF ; END DO
  DO I=1,SIZE(SCAPSVAT%LABEL); IF(SCAPSVAT%IACT(I).EQ.0)CYCLE ; N=N+1; J=J+1; 
     IF(K.EQ.2)THEN ; CALL WGRIDPUTCELLSTRING(IDF_GRID1,1,J,SCAPSVAT%LABEL(I)); CALL WGRIDPUTCELLSTRING(IDF_GRID1,3,J,SCAPSVAT%UNIT(I)) ; CALL WGRIDPUTCELLOPTION(IDF_GRID1,4,J,0); ENDIF ; END DO
  DO I=1,SIZE(METEGRID%LABEL); IF(METEGRID%IACT(I).EQ.0)CYCLE ; N=N+1; J=J+1; 
     IF(K.EQ.2)THEN ; CALL WGRIDPUTCELLSTRING(IDF_GRID1,1,J,METEGRID%LABEL(I)); CALL WGRIDPUTCELLSTRING(IDF_GRID1,3,J,METEGRID%UNIT(I)) ; 
                      CALL WGRIDSTATECELL(IDF_GRID1,4,J,MAX((0-METEGRID%GRAPH(I)),-1)+2)  ; CALL WGRIDPUTCELLOPTION(IDF_GRID1,4,J,METEGRID%GRAPH(I)); ENDIF ; END DO
  TAB3GRIDSIZE=J
  IF(K.EQ.1) THEN ; CALL WGRIDROWS(IDF_GRID1,N) ; CALL WGRIDSTATE(IDF_GRID1,4,DialogReadOnly) ; ENDIF

 ENDDO

 END SUBROUTINE MSPINSPECTOR_TAB3_PUTPARAMLIST


 !###======================================================================
 SUBROUTINE MSPINSPECTOR_TAB3_PUTPARAMVALUE()
 !###======================================================================
 IMPLICIT NONE
 INTEGER :: N,I,J,K

 CALL WDIALOGSELECT(ID_DMSPANALYSER_TAB3)
 
 !## Time dependant parameters: METEGRID (PRECGRID,ETREFGRID) / FACTSVAT (all) / LUSESVAT (Feddes Function?) / 
 !## determine number of rows active
 DO K=1,2
  N=0; J=0 ; TAB3GRIDSIZE=0
  !## same order as in MSFILES
  DO I=1,SIZE(DXC%LABEL);      IF(DXC%IACT(I).EQ.0)CYCLE      ; N=N+1; J=J+1;  IF(K.EQ.2) CALL WGRIDPUTCELLSTRING(IDF_GRID1,2,J,DXC%INSPVAL(I))     ; END DO
  DO I=1,SIZE(MODSVAT%LABEL);  IF(MODSVAT%IACT(I).EQ.0)CYCLE  ; N=N+1; J=J+1;  IF(K.EQ.2) CALL WGRIDPUTCELLSTRING(IDF_GRID1,2,J,MODSVAT%INSPVAL(I)) ; END DO
  DO I=1,SIZE(IDFSVAT%LABEL);  IF(IDFSVAT%IACT(I).EQ.0)CYCLE  ; N=N+1; J=J+1;  IF(K.EQ.2) CALL WGRIDPUTCELLSTRING(IDF_GRID1,2,J,IDFSVAT%INSPVAL(I)) ; END DO
  DO I=1,SIZE(AREASVAT%LABEL); IF(AREASVAT%IACT(I).EQ.0)CYCLE ; N=N+1; J=J+1;  IF(K.EQ.2) CALL WGRIDPUTCELLSTRING(IDF_GRID1,2,J,AREASVAT%INSPVAL(I)); END DO
  DO I=1,SIZE(LUSESVAT%LABEL); IF(LUSESVAT%IACT(I).EQ.0)CYCLE ; N=N+1; J=J+1;  IF(K.EQ.2) CALL WGRIDPUTCELLSTRING(IDF_GRID1,2,J,LUSESVAT%INSPVAL(I)); END DO
  DO I=1,SIZE(FACTSVAT%LABEL); IF(FACTSVAT%IACT(I).EQ.0)CYCLE ; N=N+1; J=J+1;  IF(K.EQ.2) CALL WGRIDPUTCELLSTRING(IDF_GRID1,2,J,FACTSVAT%INSPVAL(I)); END DO
  DO I=1,SIZE(INFISVAT%LABEL); IF(INFISVAT%IACT(I).EQ.0)CYCLE ; N=N+1; J=J+1;  IF(K.EQ.2) CALL WGRIDPUTCELLSTRING(IDF_GRID1,2,J,INFISVAT%INSPVAL(I)); END DO
  DO I=1,SIZE(SCAPSVAT%LABEL); IF(SCAPSVAT%IACT(I).EQ.0)CYCLE ; N=N+1; J=J+1;  IF(K.EQ.2) CALL WGRIDPUTCELLSTRING(IDF_GRID1,2,J,SCAPSVAT%INSPVAL(I)); END DO
  DO I=1,SIZE(METEGRID%LABEL); IF(METEGRID%IACT(I).EQ.0)CYCLE ; N=N+1; J=J+1;  IF(K.EQ.2) CALL WGRIDPUTCELLSTRING(IDF_GRID1,2,J,METEGRID%INSPVAL(I)); END DO
  TAB3GRIDSIZE=J
  IF(K.EQ.1) THEN ; CALL WGRIDROWS(IDF_GRID1,N) ; CALL WGRIDSTATE(IDF_GRID1,4,DialogReadOnly) ; ENDIF

 ENDDO

 END SUBROUTINE MSPINSPECTOR_TAB3_PUTPARAMVALUE


!###======================================================================
 SUBROUTINE MSPINSPECTOR_TAB3_GETPARAMLIST()
 !###======================================================================
 IMPLICIT NONE
 INTEGER :: N,I,J,K

 CALL WDIALOGSELECT(ID_DMSPANALYSER_TAB3)

  N=0; J=0
  !## same order as in MSFILES
  !## get selection code for drawing graphs
  DO I=1,SIZE(DXC%LABEL);      IF(DXC%IACT(I).EQ.0)CYCLE      ; N=N+1; J=J+1; END DO
  DO I=1,SIZE(MODSVAT%LABEL);  IF(MODSVAT%IACT(I).EQ.0)CYCLE  ; N=N+1; J=J+1; END DO
  DO I=1,SIZE(IDFSVAT%LABEL);  IF(IDFSVAT%IACT(I).EQ.0)CYCLE  ; N=N+1; J=J+1; END DO
  DO I=1,SIZE(AREASVAT%LABEL); IF(AREASVAT%IACT(I).EQ.0)CYCLE ; N=N+1; J=J+1; END DO
  DO I=1,SIZE(LUSESVAT%LABEL); IF(LUSESVAT%IACT(I).EQ.0)CYCLE ; N=N+1; J=J+1; END DO
  DO I=1,SIZE(FACTSVAT%LABEL); IF(FACTSVAT%IACT(I).EQ.0)CYCLE ; N=N+1; J=J+1; CALL WGRIDGETCELLMENU(IDF_GRID1,4,J,FACTSVAT%GRAPH(I)); END DO
  DO I=1,SIZE(INFISVAT%LABEL); IF(INFISVAT%IACT(I).EQ.0)CYCLE ; N=N+1; J=J+1; END DO
  DO I=1,SIZE(SCAPSVAT%LABEL); IF(SCAPSVAT%IACT(I).EQ.0)CYCLE ; N=N+1; J=J+1; END DO
  DO I=1,SIZE(METEGRID%LABEL); IF(METEGRID%IACT(I).EQ.0)CYCLE ; N=N+1; J=J+1; CALL WGRIDGETCELLMENU(IDF_GRID1,4,J,METEGRID%GRAPH(I)); END DO


 END SUBROUTINE MSPINSPECTOR_TAB3_GETPARAMLIST

 !###======================================================================
 SUBROUTINE MSPINSPECTOR_TAB5_PUTPARAMLIST()
 !###======================================================================
 IMPLICIT NONE
 INTEGER :: I

 CALL WDIALOGSELECT(ID_DMSPANALYSER_TAB5)
 CALL WDIALOGGETMENU(IDF_MENU1,I)

 SELECT CASE (I)
  !## NB this block changes whenever order MSFILES changes!
  CASE (1)
   CALL WDIALOGPUTMENU(IDF_MENU2,DXC%LABEL,SIZE(DXC%LABEL),DXC%IACT)
  CASE (2)
   CALL WDIALOGPUTMENU(IDF_MENU2,MODSVAT%LABEL,SIZE(MODSVAT%LABEL),MODSVAT%IACT)
  CASE (3)
   CALL WDIALOGPUTMENU(IDF_MENU2,IDFSVAT%LABEL,SIZE(IDFSVAT%LABEL),IDFSVAT%IACT)
  CASE (4)
   CALL WDIALOGPUTMENU(IDF_MENU2,AREASVAT%LABEL,SIZE(AREASVAT%LABEL),AREASVAT%IACT)
  CASE (5)
   CALL WDIALOGPUTMENU(IDF_MENU2,LUSESVAT%LABEL,SIZE(LUSESVAT%LABEL),LUSESVAT%IACT)
  CASE (6)
   CALL WDIALOGPUTMENU(IDF_MENU2,FACTSVAT%LABEL,SIZE(FACTSVAT%LABEL),FACTSVAT%IACT)
  CASE (7)
   CALL WDIALOGPUTMENU(IDF_MENU2,INFISVAT%LABEL,SIZE(INFISVAT%LABEL),INFISVAT%IACT)
  CASE (8)
   CALL WDIALOGPUTMENU(IDF_MENU2,SCAPSVAT%LABEL,SIZE(SCAPSVAT%LABEL),SCAPSVAT%IACT)
  CASE (9)
   CALL WDIALOGPUTMENU(IDF_MENU2,METEGRID%LABEL,SIZE(METEGRID%LABEL),METEGRID%IACT)
  END SELECT
  
 CALL MSPINSPECTOR_TAB3_PUTPARAMLIST
 
 END SUBROUTINE MSPINSPECTOR_TAB5_PUTPARAMLIST

 !###======================================================================
 SUBROUTINE MSPINSPECTOR_TAB5_GETPARAMLIST()
 !###======================================================================
 IMPLICIT NONE
 INTEGER :: I

 CALL WDIALOGSELECT(ID_DMSPANALYSER_TAB5)
 CALL WDIALOGGETMENU(IDF_MENU1,I)

 SELECT CASE (I)
  !## NB this block changes whenever order MSFILES changes!
  CASE (1)
   CALL WDIALOGGETMENU(IDF_MENU2,DXC%IACT)
  CASE (2)
   CALL WDIALOGGETMENU(IDF_MENU2,MODSVAT%IACT)
  CASE (3)
   CALL WDIALOGGETMENU(IDF_MENU2,IDFSVAT%IACT)
  CASE (4)
   CALL WDIALOGGETMENU(IDF_MENU2,AREASVAT%IACT)
  CASE (5)
   CALL WDIALOGGETMENU(IDF_MENU2,LUSESVAT%IACT)
  CASE (6)
   CALL WDIALOGGETMENU(IDF_MENU2,FACTSVAT%IACT)
  CASE (7)
   CALL WDIALOGGETMENU(IDF_MENU2,INFISVAT%IACT)
  CASE (8)
   CALL WDIALOGGETMENU(IDF_MENU2,SCAPSVAT%IACT)
  CASE (9)
   CALL WDIALOGGETMENU(IDF_MENU2,METEGRID%IACT)
  END SELECT

 END SUBROUTINE MSPINSPECTOR_TAB5_GETPARAMLIST

 !###======================================================================
 LOGICAL FUNCTION MSPINSPECTOR_OPENFILES()
 !###======================================================================
 IMPLICIT NONE
 INTEGER :: IU,I,N
 LOGICAL :: LEX
 REAL(KIND=DP_KIND) :: X

 MSPINSPECTOR_OPENFILES=.FALSE.

 !## get foldername
 CALL WDIALOGSELECT(ID_DMSPANALYSER_TAB1)
 CALL WDIALOGGETMENU(IDF_MENU1,I,CVALUE=MNAME)

 !## open progress bar
 CALL WDIALOGLOAD(ID_DIRPROGRESS,ID_DIRPROGRESS)
 CALL WDIALOGSELECT(ID_DIRPROGRESS)
 CALL WDIALOGPUTSTRING(IDF_GROUP1,'Progress Reading metaSWAP Files')
 CALL WDIALOGRANGEPROGRESSBAR(IDF_PROGRESS1,0,12)
 CALL WDIALOGPUTPROGRESSBAR(IDF_PROGRESS1,0,ABSOLUTE)
 CALL WDIALOGSHOW(-1,-1,0,3)
 
 I=1 
 !## get modelname
 N=1; CALL UTL_IMODFILLMENU(0,TRIM(ROOT)//'\'//TRIM(MNAME)//'\MF2005_TMP','*.DXC','F',N,0,1)
 IF(N.EQ.1)THEN
  MFNAME=LISTNAME(1)
 ELSE
  CALL WMESSAGEBOX(OKONLY,EXCLAMATIONICON,COMMONOK,'iMOD cannot find file '//CHAR(13)//TRIM(ROOT)//'\'//TRIM(MNAME)//'\MF2005_TMP\*.DXC','Error'); CALL WDIALOGUNLOAD() ;RETURN 
 ENDIF
 IF(ALLOCATED(LISTNAME))DEALLOCATE(LISTNAME)

 CALL MSPINSPECTOR_DEALLOCATE();

 !## open files
 FNAME='\'//TRIM(MNAME)//'\MF2005_TMP\'//TRIM(MFNAME)
 I=I+1 ; CALL WDIALOGSELECT(ID_DIRPROGRESS) ; CALL WDIALOGPUTPROGRESSBAR(IDF_PROGRESS1,I,0) ; CALL WDIALOGPUTSTRING(IDF_LABEL1,TRIM(FNAME))
 IF(.NOT.MSPINSPECTOR_OPENFILES_DXC(IU))THEN
  INQUIRE(UNIT=IU,OPENED=LEX); IF(LEX)CLOSE(IU)
  CALL WMESSAGEBOX(OKONLY,EXCLAMATIONICON,COMMONOK,'iMOD cannot open file '//CHAR(13)//TRIM(ROOT)//TRIM(FNAME),'Error'); CALL WDIALOGUNLOAD() ;RETURN
 ENDIF
 
 FNAME='\'//TRIM(MNAME)//'\AREA_SVAT.INP'
 I=I+1 ; CALL WDIALOGSELECT(ID_DIRPROGRESS) ; CALL WDIALOGPUTPROGRESSBAR(IDF_PROGRESS1,I,0) ; CALL WDIALOGPUTSTRING(IDF_LABEL1,TRIM(FNAME))
 IF(.NOT.MSPINSPECTOR_OPENFILES_AREASVAT(IU))THEN
  INQUIRE(UNIT=IU,OPENED=LEX); IF(LEX)CLOSE(IU)
  CALL WMESSAGEBOX(OKONLY,EXCLAMATIONICON,COMMONOK,'iMOD cannot open file '//CHAR(13)//TRIM(ROOT)//TRIM(FNAME),'Error'); CALL WDIALOGUNLOAD() ;RETURN
 ENDIF

 FNAME='\'//TRIM(MNAME)//'\PARA_SIM.INP'
 I=I+1 ; CALL WDIALOGSELECT(ID_DIRPROGRESS) ; CALL WDIALOGPUTPROGRESSBAR(IDF_PROGRESS1,I,0) ; CALL WDIALOGPUTSTRING(IDF_LABEL1,TRIM(FNAME))
 IF(.NOT.MSPINSPECTOR_OPENFILES_PARASIM(IU))THEN
  INQUIRE(UNIT=IU,OPENED=LEX); IF(LEX)CLOSE(IU)
  CALL WMESSAGEBOX(OKONLY,EXCLAMATIONICON,COMMONOK,'iMOD cannot open file '//CHAR(13)//TRIM(ROOT)//TRIM(FNAME),'Error'); CALL WDIALOGUNLOAD() ;RETURN
 ENDIF

 FNAME='\'//TRIM(MNAME)//'\IDF_SVAT.INP'
 I=I+1 ; CALL WDIALOGSELECT(ID_DIRPROGRESS) ; CALL WDIALOGPUTPROGRESSBAR(IDF_PROGRESS1,I,0) ; CALL WDIALOGPUTSTRING(IDF_LABEL1,TRIM(FNAME))
 IF(.NOT.MSPINSPECTOR_OPENFILES_IDF2SVAT(IU))THEN
  INQUIRE(UNIT=IU,OPENED=LEX); IF(LEX)CLOSE(IU)
  CALL WMESSAGEBOX(OKONLY,EXCLAMATIONICON,COMMONOK,'iMOD cannot open file '//CHAR(13)//TRIM(ROOT)//TRIM(FNAME),'Error'); CALL WDIALOGUNLOAD() ;RETURN
 ENDIF

 FNAME='\'//TRIM(MNAME)//'\INFI_SVAT.INP'
 I=I+1 ; CALL WDIALOGSELECT(ID_DIRPROGRESS) ; CALL WDIALOGPUTPROGRESSBAR(IDF_PROGRESS1,I,0) ; CALL WDIALOGPUTSTRING(IDF_LABEL1,TRIM(FNAME))
 IF(.NOT.MSPINSPECTOR_OPENFILES_INFISVAT(IU))THEN
  INQUIRE(UNIT=IU,OPENED=LEX); IF(LEX)CLOSE(IU)
  CALL WMESSAGEBOX(OKONLY,EXCLAMATIONICON,COMMONOK,'iMOD cannot open file '//CHAR(13)//TRIM(ROOT)//TRIM(FNAME),'Error'); CALL WDIALOGUNLOAD() ;RETURN
 ENDIF

 FNAME='\'//TRIM(MNAME)//'\SCAP_SVAT.INP'
 I=I+1 ; CALL WDIALOGSELECT(ID_DIRPROGRESS) ; CALL WDIALOGPUTPROGRESSBAR(IDF_PROGRESS1,I,0) ; CALL WDIALOGPUTSTRING(IDF_LABEL1,TRIM(FNAME))
 IF(.NOT.MSPINSPECTOR_OPENFILES_SCAPSVAT(IU))THEN
  INQUIRE(UNIT=IU,OPENED=LEX); IF(LEX)CLOSE(IU)
  CALL WMESSAGEBOX(OKONLY,EXCLAMATIONICON,COMMONOK,'iMOD cannot open file '//CHAR(13)//TRIM(ROOT)//TRIM(FNAME),'Error'); CALL WDIALOGUNLOAD() ;RETURN
 ENDIF

 FNAME='\'//TRIM(MNAME)//'\LUSE_SVAT.INP'
 I=I+1 ; CALL WDIALOGSELECT(ID_DIRPROGRESS) ; CALL WDIALOGPUTPROGRESSBAR(IDF_PROGRESS1,I,0) ; CALL WDIALOGPUTSTRING(IDF_LABEL1,TRIM(FNAME))
 IF(.NOT.MSPINSPECTOR_OPENFILES_LUSESVAT(IU))THEN
  INQUIRE(UNIT=IU,OPENED=LEX); IF(LEX)CLOSE(IU)
  CALL WMESSAGEBOX(OKONLY,EXCLAMATIONICON,COMMONOK,'iMOD cannot open file '//CHAR(13)//TRIM(ROOT)//TRIM(FNAME),'Error'); CALL WDIALOGUNLOAD() ;RETURN
 ENDIF

 FNAME='\'//TRIM(MNAME)//'\METE_GRID.INP'
 I=I+1 ; CALL WDIALOGSELECT(ID_DIRPROGRESS) ; CALL WDIALOGPUTPROGRESSBAR(IDF_PROGRESS1,I,0) ; CALL WDIALOGPUTSTRING(IDF_LABEL1,TRIM(FNAME))
 IF(.NOT.MSPINSPECTOR_OPENFILES_METEGRID(IU))THEN
  INQUIRE(UNIT=IU,OPENED=LEX); IF(LEX)CLOSE(IU)
  CALL WMESSAGEBOX(OKONLY,EXCLAMATIONICON,COMMONOK,'iMOD cannot open file '//CHAR(13)//TRIM(ROOT)//TRIM(FNAME),'Error'); CALL WDIALOGUNLOAD() ;RETURN
 ENDIF

 FNAME='\'//TRIM(MNAME)//'\FACT_SVAT.INP'
 I=I+1 ; CALL WDIALOGSELECT(ID_DIRPROGRESS) ; CALL WDIALOGPUTPROGRESSBAR(IDF_PROGRESS1,I,0) ; CALL WDIALOGPUTSTRING(IDF_LABEL1,TRIM(FNAME))
 IF(.NOT.MSPINSPECTOR_OPENFILES_FACTSVAT(IU))THEN
  INQUIRE(UNIT=IU,OPENED=LEX); IF(LEX)CLOSE(IU)
  CALL WMESSAGEBOX(OKONLY,EXCLAMATIONICON,COMMONOK,'iMOD cannot open file '//CHAR(13)//TRIM(ROOT)//TRIM(FNAME),'Error'); CALL WDIALOGUNLOAD() ;RETURN
 ENDIF

 FNAME='\'//TRIM(MNAME)//'\TIOP_SIM.INP'
 I=I+1 ; CALL WDIALOGSELECT(ID_DIRPROGRESS) ; CALL WDIALOGPUTPROGRESSBAR(IDF_PROGRESS1,I,0) ; CALL WDIALOGPUTSTRING(IDF_LABEL1,TRIM(FNAME))
 IF(.NOT.MSPINSPECTOR_OPENFILES_TIOPSIM(IU))THEN
  INQUIRE(UNIT=IU,OPENED=LEX); IF(LEX)CLOSE(IU)
  CALL WMESSAGEBOX(OKONLY,EXCLAMATIONICON,COMMONOK,'iMOD cannot open file '//CHAR(13)//TRIM(ROOT)//TRIM(FNAME),'Error'); CALL WDIALOGUNLOAD() ;RETURN
 ENDIF

 FNAME='\'//TRIM(MNAME)//'\MOD2SVAT.INP'
 I=I+1 ; CALL WDIALOGSELECT(ID_DIRPROGRESS) ; CALL WDIALOGPUTPROGRESSBAR(IDF_PROGRESS1,I,0) ; CALL WDIALOGPUTSTRING(IDF_LABEL1,TRIM(FNAME))
 IF(.NOT.MSPINSPECTOR_OPENFILES_MOD2SVAT(IU))THEN
  INQUIRE(UNIT=IU,OPENED=LEX); IF(LEX)CLOSE(IU)
  CALL WMESSAGEBOX(OKONLY,EXCLAMATIONICON,COMMONOK,'iMOD cannot open file '//CHAR(13)//TRIM(ROOT)//TRIM(FNAME),'Error'); CALL WDIALOGUNLOAD() ;RETURN
 ENDIF
 
 IF(.NOT.MSPINSPECTOR_PROCESSFILES())THEN ; CALL WDIALOGUNLOAD() ; RETURN ; ENDIF

 CALL WDIALOGUNLOAD()

 MSPINSPECTOR_OPENFILES=.TRUE.

 END FUNCTION MSPINSPECTOR_OPENFILES

 !###======================================================================
 SUBROUTINE MSPINSPECTOR_OPENFILES_FIELDS(I)
 !###======================================================================
 IMPLICIT NONE
 INTEGER,INTENT(IN) :: I

 !## enable fields and activate tabs
 CALL WDIALOGSELECT(ID_DMSPANALYSER_TAB1)
 CALL WDIALOGFIELDSTATE(ID_ZOOMFULL,I)
 CALL WDIALOGFIELDSTATE(IDF_LABEL1,I)

 CALL WDIALOGSELECT(ID_DMSPANALYSER)
 CALL WDIALOGFIELDSTATE(IDOK,I)
 CALL WDIALOGTABSTATE(IDF_TAB1,ID_DMSPANALYSER_TAB2,I)
 CALL WDIALOGTABSTATE(IDF_TAB1,ID_DMSPANALYSER_TAB3,I)
 CALL WDIALOGTABSTATE(IDF_TAB1,ID_DMSPANALYSER_TAB4,I)
 CALL WDIALOGTABSTATE(IDF_TAB1,ID_DMSPANALYSER_TAB5,I)
 IF(I.EQ.1)THEN
  CALL MSPINSPECTOR_TAB3_PUTPARAMLIST()
  CALL MSPINSPECTOR_TAB5_PUTPARAMLIST()
 ENDIF

 
 !## clear fields from former activities
 CALL MSPINSPECTOR_CLEANGRIDS()

 END SUBROUTINE MSPINSPECTOR_OPENFILES_FIELDS

 !###======================================================================
 LOGICAL FUNCTION MSPINSPECTOR_OPENFILES_DXC(IU)
 !###======================================================================
 IMPLICIT NONE
 INTEGER,INTENT(OUT) :: IU
 INTEGER :: I,IOS

 MSPINSPECTOR_OPENFILES_DXC=.FALSE.

 !## allocate memory - mainly number of svats
 IU=UTL_GETUNIT(); OPEN(IU,FILE=TRIM(ROOT)//'\'//TRIM(MNAME)//'\MF2005_TMP\'//TRIM(MFNAME),STATUS='OLD',ACTION='READ',IOSTAT=IOS)
 IF(IOS.NE.0)RETURN

 READ(IU,*,IOSTAT=IOS) DXC%MXID; IF(IOS.NE.0)RETURN
 READ(IU,*,IOSTAT=IOS) DXC%MXID; IF(IOS.NE.0)RETURN
 ALLOCATE(DXC%INFO(DXC%MXID),STAT=IOS); IF(IOS.NE.0)RETURN
 DO I=1,DXC%MXID
  READ(IU,*,IOSTAT=IOS) DXC%INFO(I)%ILAY,DXC%INFO(I)%IROW,DXC%INFO(I)%ICOL,DXC%INFO(I)%MFID
  IF(IOS.NE.0)RETURN
 ENDDO
 CLOSE(IU)

 ALLOCATE(DXC%LABEL(4),DXC%UNIT(4),DXC%IACT(4),DXC%INSPVAL(4),DXC%DXCIREC(2))
 DXC%LABEL(1)='layer number' ;  DXC%UNIT(1)='-'
 DXC%LABEL(2)='row number' ;  DXC%UNIT(2)='-'
 DXC%LABEL(3)='column number' ;  DXC%UNIT(3)='-'
 DXC%LABEL(4)='Modflow-ID' ;  DXC%UNIT(4)='-'
 DXC%IACT=1 ;  DXC%INSPVAL=''

 MSPINSPECTOR_OPENFILES_DXC=.TRUE.

 END FUNCTION MSPINSPECTOR_OPENFILES_DXC

 !###======================================================================
 LOGICAL FUNCTION MSPINSPECTOR_OPENFILES_PARASIM(IU)
 !###======================================================================
 IMPLICIT NONE
 INTEGER,INTENT(OUT) :: IU
 INTEGER :: IOS

 MSPINSPECTOR_OPENFILES_PARASIM=.FALSE.

 !## read netwerk from paramsim.inp
 IU=UTL_GETUNIT(); OPEN(IU,FILE=TRIM(ROOT)//'\'//TRIM(MNAME)//'\PARA_SIM.INP',STATUS='OLD',ACTION='READ',IOSTAT=IOS)
 IF(IOS.NE.0)RETURN

 CALL IDFNULLIFY(MSPIDF)
 DO
  READ(IU,'(A)',IOSTAT=IOS) LINE; IF(IOS.NE.0)EXIT
  IF(INDEX(UTL_CAP(LINE,'U'),'IDF_XMIN').GT.0)READ(LINE(INDEX(LINE,'=',.TRUE.)+1:),*) MSPIDF%XMIN
  IF(INDEX(UTL_CAP(LINE,'U'),'IDF_YMIN').GT.0)READ(LINE(INDEX(LINE,'=',.TRUE.)+1:),*) MSPIDF%YMIN
  IF(INDEX(UTL_CAP(LINE,'U'),'IDF_DX').GT.0)  READ(LINE(INDEX(LINE,'=',.TRUE.)+1:),*) MSPIDF%DX
  IF(INDEX(UTL_CAP(LINE,'U'),'IDF_DY').GT.0)  READ(LINE(INDEX(LINE,'=',.TRUE.)+1:),*) MSPIDF%DY
  IF(INDEX(UTL_CAP(LINE,'U'),'IDF_NCOL').GT.0)READ(LINE(INDEX(LINE,'=',.TRUE.)+1:),*) MSPIDF%NCOL
  IF(INDEX(UTL_CAP(LINE,'U'),'IDF_NROW').GT.0)READ(LINE(INDEX(LINE,'=',.TRUE.)+1:),*) MSPIDF%NROW
  IF(INDEX(UTL_CAP(LINE,'U'),'IYBG').GT.0)    READ(LINE(INDEX(LINE,'=',.TRUE.)+1:),*) IYBG
  IF(INDEX(UTL_CAP(LINE,'U'),'TDBG ').GT.0)   READ(LINE(INDEX(LINE,'=',.TRUE.)+1:),*) TDBG  
 ENDDO
 CLOSE(IU)

 MSPIDF%XMAX=MSPIDF%XMIN+MSPIDF%DX*MSPIDF%NCOL
 MSPIDF%YMAX=MSPIDF%YMIN+MSPIDF%DY*MSPIDF%NROW
 MSPIDF%NODATA=HUGE(1.0D0)
 IF(.NOT.IDFALLOCATEX(MSPIDF))RETURN; MSPIDF%X=0.0D0

 MSPINSPECTOR_OPENFILES_PARASIM=.TRUE.

 END FUNCTION MSPINSPECTOR_OPENFILES_PARASIM

 !###======================================================================
 LOGICAL FUNCTION MSPINSPECTOR_OPENFILES_MOD2SVAT(IU)
 !###======================================================================
 IMPLICIT NONE
 INTEGER,INTENT(OUT) :: IU
 INTEGER :: I,J,N,IOS,IROW,ICOL,NPRGS,IPRGS

 MSPINSPECTOR_OPENFILES_MOD2SVAT=.FALSE.

 !## allocate memory - mainly number of svats
 IU=UTL_GETUNIT(); OPEN(IU,FILE=TRIM(ROOT)//'\'//TRIM(MNAME)//'\MOD2SVAT.INP',STATUS='OLD',ACTION='READ',IOSTAT=IOS)
 IF(IOS.NE.0)RETURN

 ALLOCATE(MODSVAT%INFO(1),STAT=IOS); IF(IOS.NE.0)RETURN
 MODSVAT%MXID=0
 DO I=1,2
  N=1
  DO
   READ(IU,'(I10,2X,I10,I5)',IOSTAT=IOS) MODSVAT%INFO(N)%MFID,MODSVAT%INFO(N)%SVATID,MODSVAT%INFO(N)%LYBE
   IF(IOS.NE.0)EXIT
   IF(I.EQ.2)THEN ; N=N+1 ; IF(N.GT.MODSVAT%MXID)EXIT ; ELSE ; MODSVAT%MXID=MODSVAT%MXID+1 ; ENDIF
  ENDDO
  IF(I.EQ.1)THEN; DEALLOCATE(MODSVAT%INFO); ALLOCATE(MODSVAT%INFO(MODSVAT%MXID),STAT=IOS); IF(IOS.NE.0)RETURN; ENDIF
  REWIND(IU)
 ENDDO
 CLOSE(IU)

 ALLOCATE(MODSVAT%LABEL(3),MODSVAT%UNIT(3),MODSVAT%IACT(3),MODSVAT%INSPVAL(3))
 MODSVAT%LABEL(1)='Modflow-ID' ;  MODSVAT%UNIT(1)='-'
 MODSVAT%LABEL(2)='SVAT-ID'    ;  MODSVAT%UNIT(2)='-'
 MODSVAT%LABEL(3)='layer'      ;  MODSVAT%UNIT(3)='-'
 MODSVAT%IACT=1 
 MODSVAT%INSPVAL=''
 
 MSPINSPECTOR_OPENFILES_MOD2SVAT=.TRUE.

 END FUNCTION MSPINSPECTOR_OPENFILES_MOD2SVAT

 !###======================================================================
 LOGICAL FUNCTION MSPINSPECTOR_PROCESSFILES()
 !###======================================================================
 IMPLICIT NONE
 INTEGER :: I,J,N,IOS,NPRGS,IPRGS,IROW,ICOL

 MSPINSPECTOR_PROCESSFILES=.FALSE.

 !## add model row/col from dxc file
 DO N=1,MODSVAT%MXID
   !CALL POL1LOCATEINT(DXC%INFO%ID,DXC%MXID,MODSVAT%INFO(N)%MFID,I)
   I=MODSVAT%INFO(N)%MFID  ! assumption: recordnumber is 
   IF(DXC%INFO(I)%MFID.NE.I)THEN ; 
       CALL WMESSAGEBOX(OKONLY,EXCLAMATIONICON,COMMONOK,'Expected MFID='//TRIM(ITOS(I))//' on element '//TRIM(ITOS(I))//' of file DXC.INP','Error'); EXIT ; ENDIF
   MODSVAT%INFO(N)%IROW=DXC%INFO(I)%IROW
   MODSVAT%INFO(N)%ICOL=DXC%INFO(I)%ICOL
 ENDDO

 !## fill 3 IDFs with 3 SVAT types (rural,urban,irrigation) 
 ! read from modsvat, check in areasvat and scapsvat
 CALL IDFCOPY(MSPIDF,SVATRU) ;  CALL IDFCOPY(MSPIDF,SVATUR) ;  CALL IDFCOPY(MSPIDF,SVATIR)
 CALL IDFCOPY(MSPIDF,MFwID)  ;  CALL IDFCOPY(MSPIDF,LYBE) 
 
 NPRGS=50 ; IPRGS=0
 CALL WDIALOGSELECT(ID_DIRPROGRESS) ; CALL WDIALOGPUTSTRING(IDF_LABEL1,'Process all metaSWAP data........')
 CALL WDIALOGRANGEPROGRESSBAR(IDF_PROGRESS1,0,NPRGS) 

 DO N=1,MODSVAT%MXID
   IF(INT(N*NPRGS/MODSVAT%MXID).GT.IPRGS) THEN ; IPRGS = INT(N*NPRGS/MODSVAT%MXID) ; CALL WDIALOGPUTPROGRESSBAR(IDF_PROGRESS1,IPRGS,ABSOLUTE) ; ENDIF
   IROW=MODSVAT%INFO(N)%IROW ;  ICOL=MODSVAT%INFO(N)%ICOL  
   IF(MFWID%X(ICOL,IROW).EQ.0) MFWID%X(ICOL,IROW)=FLOAT(MODSVAT%INFO(N)%MFID)
   IF(LYBE%X(ICOL,IROW).EQ.0)  LYBE%X(ICOL,IROW)=FLOAT(MODSVAT%INFO(N)%LYBE)
   
   I=MODSVAT%INFO(N)%SVATID    !## assumption, AREA_SVAT file has svat nummer equal to line number
   IF(AREASVAT%INFO(I)%NUND.NE.I)THEN ; 
       CALL WMESSAGEBOX(OKONLY,EXCLAMATIONICON,COMMONOK,'Expected SVATID='//TRIM(ITOS(I))//' on record '//TRIM(ITOS(I))//' of file AREA_SVAT.INP','Error'); EXIT ; ENDIF
   IF(AREASVAT%INFO(I)%LUSE.EQ.18)THEN ;  SVATUR%X(ICOL,IROW)=FLOAT(MODSVAT%INFO(N)%SVATID)
   ELSE ;  SVATRU%X(ICOL,IROW)=FLOAT(MODSVAT%INFO(N)%SVATID) ;  ENDIF 
   !I=0 ; CALL POL1LOCATEINT(SCAPSVAT%INFO%NUND,SCAPSVAT%MXID,MODSVAT%INFO(N)%SVATID,I)
   !IF(I.GT.0) then 
   !    SVATIR%X(ICOL,IROW)=FLOAT(MODSVAT%INFO(N)%SVATID)
   ! ENDIF   
       
   !## find and fill irrigation cel       
   DO J=1,SCAPSVAT%MXID
      IF(MODSVAT%INFO(N)%SVATID.EQ.SCAPSVAT%INFO(J)%NUND)THEN
        IF(SVATIR%X(ICOL,IROW).EQ.0) SVATIR%X(ICOL,IROW)=FLOAT(SCAPSVAT%INFO(J)%NUND)
        EXIT
      ENDIF    
   ENDDO
 ENDDO
 
 !## Read meteo dimensions
 CALL IDFNULLIFY(METEO)
 	
 CALL  MSPINSPECTOR_READASC(METEGRID%INFO(1)%PRECGRID,METEO%NCOL,METEO%NROW,METEO%XMIN,METEO%YMIN,METEO%DX,METEO%NODATA)
 METEO%DY = METEO%DX
 METEO%XMAX=METEO%XMIN+METEO%DX*METEO%NCOL
 METEO%YMAX=METEO%YMIN+METEO%DY*METEO%NROW
 IF(.NOT.IDFALLOCATEX(METEO))RETURN; METEO%X=0.0D0
 
   !  TOPWC=''; BOTEL=0.0D0; MULT =1.0D0; ADD=0.0D0
   ! CALL ASC2IDF_IMPORTASC_MAIN(DIRNAME,TOPWC,BOTEL,MULT,ADD,0)
!   CALL ASC2IDF_IMPORTASC_MAIN('d:\roelofs_fs\_projecten\imod\version-develop\IMOD_USER\MODELS\MetaswapAnalyser_01\meteo\','MAK_20050101.asc',0.0D0,1.0D0,0.0D0,0)
   ! CALL ASC2IDF_IMPORTASC(IDFNAMES(I),TOP,BOT,IERROR,IBATCH)
!     IF(.NOT.ASC2IDF_IMPORTASC_TYPE3(IU,IDFNAME))IERROR=0

 MSPINSPECTOR_PROCESSFILES=.TRUE.

 END FUNCTION MSPINSPECTOR_PROCESSFILES

 !###======================================================================
 LOGICAL FUNCTION MSPINSPECTOR_OPENFILES_IDF2SVAT(IU)
 !###======================================================================
 IMPLICIT NONE
 INTEGER,INTENT(OUT) :: IU
 INTEGER :: I,N,IOS

 MSPINSPECTOR_OPENFILES_IDF2SVAT=.FALSE.

 !## allocate memory - mainly number of svats
 IU=UTL_GETUNIT(); OPEN(IU,FILE=TRIM(ROOT)//'\'//TRIM(MNAME)//'\IDF_SVAT.INP',STATUS='OLD',ACTION='READ',IOSTAT=IOS)
 IF(IOS.NE.0)RETURN

 ALLOCATE(IDFSVAT%INFO(1),STAT=IOS); IF(IOS.NE.0)RETURN
 IDFSVAT%MXID=0
 DO I=1,2
  N=1
  DO
   READ(IU,'(3I10)',IOSTAT=IOS) IDFSVAT%INFO(N)%NUND,IDFSVAT%INFO(N)%IROW,IDFSVAT%INFO(N)%ICOL 
   IF(IOS.NE.0)EXIT
   IF(I.EQ.2)THEN ; N=N+1 ; IF(N.GT.IDFSVAT%MXID)EXIT ; ELSE ; IDFSVAT%MXID=IDFSVAT%MXID+1 ; ENDIF
  ENDDO
  IF(I.EQ.1)THEN; DEALLOCATE(IDFSVAT%INFO); ALLOCATE(IDFSVAT%INFO(IDFSVAT%MXID),STAT=IOS); IF(IOS.NE.0)RETURN; ENDIF
  REWIND(IU)
 ENDDO
 CLOSE(IU)

 ALLOCATE(IDFSVAT%LABEL(3),IDFSVAT%UNIT(3),IDFSVAT%IACT(3),IDFSVAT%INSPVAL(3))

 IDFSVAT%LABEL(1)='SVAT-ID' ;  IDFSVAT%UNIT(1)='-'
 IDFSVAT%LABEL(2)='row number (MODFLOW style)' ;  IDFSVAT%UNIT(2)='-'
 IDFSVAT%LABEL(3)='column number (MODFLOW style)' ;  IDFSVAT%UNIT(3)='-'
 IDFSVAT%IACT=1 
 IDFSVAT%INSPVAL=''

 MSPINSPECTOR_OPENFILES_IDF2SVAT=.TRUE.

 END FUNCTION MSPINSPECTOR_OPENFILES_IDF2SVAT

 !###======================================================================
 LOGICAL FUNCTION MSPINSPECTOR_OPENFILES_AREASVAT(IU)
 !###======================================================================
 IMPLICIT NONE
 INTEGER,INTENT(OUT) :: IU
 INTEGER :: I,IOS,N

 MSPINSPECTOR_OPENFILES_AREASVAT=.FALSE.

 !## allocate memory - mainly number of svats
 IU=UTL_GETUNIT(); OPEN(IU,FILE=TRIM(ROOT)//'\'//TRIM(MNAME)//'\AREA_SVAT.INP',STATUS='OLD',ACTION='READ',IOSTAT=IOS)
 IF(IOS.NE.0)RETURN

 ALLOCATE(AREASVAT%INFO(1),STAT=IOS); IF(IOS.NE.0)RETURN
 AREASVAT%MXID=0
 DO I=1,2
  N=1
  DO
   READ(IU,'(I10,F10.1,2F8.3,I6,16X,I6,F8.3,I10,2F8.3)',IOSTAT=IOS) AREASVAT%INFO(N)%NUND,AREASVAT%INFO(N)%ARK, &
     AREASVAT%INFO(N)%SURF,AREASVAT%INFO(N)%TEMP,AREASVAT%INFO(N)%SOIL,AREASVAT%INFO(N)%LUSE,AREASVAT%INFO(N)%RZ, &
     AREASVAT%INFO(N)%METE,AREASVAT%INFO(N)%LCFPREP,AREASVAT%INFO(N)%LCFPOT
    
   IF(IOS.NE.0)EXIT
   IF(I.EQ.2)THEN ; N=N+1 ; IF(N.GT.AREASVAT%MXID)EXIT ; ELSE ; AREASVAT%MXID=AREASVAT%MXID+1 ; ENDIF
  ENDDO
  IF(I.EQ.1)THEN; DEALLOCATE(AREASVAT%INFO); ALLOCATE(AREASVAT%INFO(AREASVAT%MXID),STAT=IOS); IF(IOS.NE.0)RETURN; ENDIF
  REWIND(IU)
 ENDDO
 CLOSE(IU)

 ALLOCATE(AREASVAT%LABEL(10),AREASVAT%UNIT(10),AREASVAT%IACT(10),AREASVAT%INSPVAL(10))
 AREASVAT%LABEL(1)='SVAT-SVAT-ID' ;  AREASVAT%UNIT(1)='-'
 AREASVAT%LABEL(2)='ARK-area' ;  AREASVAT%UNIT(2)='m2'
 AREASVAT%LABEL(3)='GLK-soil surface elevation' ;  AREASVAT%UNIT(3)='m+MSL'
 AREASVAT%LABEL(4)='TEMP-temp. at bottom of soil profile' ;  AREASVAT%UNIT(4)='C'
 AREASVAT%LABEL(5)='SLK-soil physical unit number / or /' ;  AREASVAT%UNIT(5)='-'
 AREASVAT%LABEL(6)='LUK-land use type' ;  AREASVAT%UNIT(6)='-'
 AREASVAT%LABEL(7)='DPRZK-root zone thickness / maximum' ;  AREASVAT%UNIT(7)='m'
 AREASVAT%LABEL(8)='NM-meteorological region code number' ;  AREASVAT%UNIT(8)='-'
 AREASVAT%LABEL(9)='CFPM-local calibration factor for precipitation' ;  AREASVAT%UNIT(9)='-'
 AREASVAT%LABEL(10)='CFETREF-local calibration factor for potential' ;  AREASVAT%UNIT(10)='-'
 AREASVAT%IACT=1
 AREASVAT%IACT(1)=0 
 AREASVAT%INSPVAL=''

 MSPINSPECTOR_OPENFILES_AREASVAT=.TRUE.

END FUNCTION MSPINSPECTOR_OPENFILES_AREASVAT

 !###======================================================================
 LOGICAL FUNCTION MSPINSPECTOR_OPENFILES_INFISVAT(IU)
 !###======================================================================
 IMPLICIT NONE
 INTEGER,INTENT(OUT) :: IU
 INTEGER :: I,IOS,N

 MSPINSPECTOR_OPENFILES_INFISVAT=.FALSE.

 !## allocate memory - .......
 IU=UTL_GETUNIT(); OPEN(IU,FILE=TRIM(ROOT)//'\'//TRIM(MNAME)//'\INFI_SVAT.INP',STATUS='OLD',ACTION='READ',IOSTAT=IOS)
 IF(IOS.NE.0)RETURN

 ALLOCATE(INFISVAT%INFO(1),STAT=IOS); IF(IOS.NE.0)RETURN
 INFISVAT%MXID=0
 DO I=1,2
  N=1
  DO
   READ(IU,'(I10,5F8.0)',IOSTAT=IOS) INFISVAT%INFO(N)%NUND,INFISVAT%INFO(N)%QINBASIC,INFISVAT%INFO(N)%CTOP_DOWN, & 
                                    INFISVAT%INFO(N)%CTOP_UP,INFISVAT%INFO(N)%CBOT,INFISVAT%INFO(N)%SC2
   IF(IOS.NE.0)EXIT
   IF(I.EQ.2)THEN ; N=N+1 ; IF(N.GT.INFISVAT%MXID)EXIT ; ELSE ; INFISVAT%MXID=INFISVAT%MXID+1 ; ENDIF
  ENDDO
  IF(I.EQ.1)THEN; DEALLOCATE(INFISVAT%INFO); ALLOCATE(INFISVAT%INFO(INFISVAT%MXID),STAT=IOS); IF(IOS.NE.0)RETURN; ENDIF
  REWIND(IU)
 ENDDO
 CLOSE(IU)

 ALLOCATE(INFISVAT%LABEL(6),INFISVAT%UNIT(6),INFISVAT%IACT(6),INFISVAT%INSPVAL(6))

 INFISVAT%LABEL(1)='SVAT-ID' ;  INFISVAT%UNIT(1)='-'
 INFISVAT%LABEL(2)='QINFBASIC-infiltration capacity' ;  INFISVAT%UNIT(2)='m/d'
 INFISVAT%LABEL(3)='CTOP_DOWN-downward flow resistance' ;  INFISVAT%UNIT(3)='d'
 INFISVAT%LABEL(4)='CTOP_UP-upward flow resistance' ;  INFISVAT%UNIT(4)='d'
 INFISVAT%LABEL(5)='CBOT-flow resistance bottom flux link' ;  INFISVAT%UNIT(5)='d'
 INFISVAT%LABEL(6)='SC2-extra storage coefficient phreatic layer' ;  INFISVAT%UNIT(6)='m3/m2/m'
 INFISVAT%IACT=1
 INFISVAT%IACT(1)=0
 INFISVAT%INSPVAL=''

 MSPINSPECTOR_OPENFILES_INFISVAT=.TRUE.

 END FUNCTION MSPINSPECTOR_OPENFILES_INFISVAT

 !###======================================================================
 LOGICAL FUNCTION MSPINSPECTOR_OPENFILES_SCAPSVAT(IU)
 !###======================================================================
 IMPLICIT NONE
 INTEGER,INTENT(OUT) :: IU
 INTEGER :: I,J,IOS,N,JROW,JCOL


 MSPINSPECTOR_OPENFILES_SCAPSVAT=.FALSE.

 !## allocate memory - .......
 IU=UTL_GETUNIT(); OPEN(IU,FILE=TRIM(ROOT)//'\'//TRIM(MNAME)//'\SCAP_SVAT.INP',STATUS='OLD',ACTION='READ',IOSTAT=IOS)
 IF(IOS.NE.0)RETURN

 ALLOCATE(SCAPSVAT%INFO(1),STAT=IOS); IF(IOS.NE.0)RETURN
 SCAPSVAT%MXID=0
 DO I=1,2
  N=1
  DO
   READ(IU,'(I10,4F8.0,I10,I6,I10)',IOSTAT=IOS) SCAPSVAT%INFO(N)%NUND,SCAPSVAT%INFO(N)%FMMXABGW,SCAPSVAT%INFO(N)%FMMXABSW,&
     SCAPSVAT%INFO(N)%FXABGW,SCAPSVAT%INFO(N)%FXABSW,SCAPSVAT%INFO(N)%SVATAB,SCAPSVAT%INFO(N)%LYAB,SCAPSVAT%INFO(N)%SWNRAB
   IF(IOS.NE.0)EXIT
   IF(I.EQ.2)THEN  
     N=N+1 ; IF(N.GT.SCAPSVAT%MXID)EXIT ; ELSE ; SCAPSVAT%MXID=SCAPSVAT%MXID+1 ; ENDIF
  ENDDO
  IF(I.EQ.1)THEN; DEALLOCATE(SCAPSVAT%INFO); ALLOCATE(SCAPSVAT%INFO(SCAPSVAT%MXID),STAT=IOS); IF(IOS.NE.0)RETURN; ENDIF
  REWIND(IU)
 ENDDO
 CLOSE(IU)

 ALLOCATE(SCAPSVAT%LABEL(8),SCAPSVAT%UNIT(8),SCAPSVAT%IACT(8),SCAPSVAT%INSPVAL(8))

 SCAPSVAT%LABEL(1)='SVAT-SVAT-ID' ;  SCAPSVAT%UNIT(1)='-'
 SCAPSVAT%LABEL(2)='FMMXABGW-max. gw abstraction' ;  SCAPSVAT%UNIT(2)='mm/d'
 SCAPSVAT%LABEL(3)='FMMXABSW-max. sw abstraction' ;  SCAPSVAT%UNIT(3)='mm/d'
 SCAPSVAT%LABEL(4)='FXABGW-max. gw abstraction' ;  SCAPSVAT%UNIT(4)='m3/d'
 SCAPSVAT%LABEL(5)='FXABSW-max. sw abstraction' ;  SCAPSVAT%UNIT(5)='m3/d'
 SCAPSVAT%LABEL(6)='SVATAB-SVAT unit source gw abstraction' ;  SCAPSVAT%UNIT(6)='-'
 SCAPSVAT%LABEL(7)='LYAB-layer number for abstraction' ;  SCAPSVAT%UNIT(7)='-'
 SCAPSVAT%LABEL(8)='SWNRAB-trajectory ID surface water abstraction' ;  SCAPSVAT%UNIT(8)='-'

 SCAPSVAT%IACT=1 
 SCAPSVAT%IACT(1)=0
 SCAPSVAT%INSPVAL=''
 
 MSPINSPECTOR_OPENFILES_SCAPSVAT=.TRUE.

 END FUNCTION MSPINSPECTOR_OPENFILES_SCAPSVAT

 !###======================================================================
 LOGICAL FUNCTION MSPINSPECTOR_OPENFILES_LUSESVAT(IU)
 !###======================================================================
 IMPLICIT NONE
 INTEGER,INTENT(OUT) :: IU
 INTEGER :: I,IOS,N

 MSPINSPECTOR_OPENFILES_LUSESVAT=.FALSE.

 !## allocate memory - .......
 IU=UTL_GETUNIT(); OPEN(IU,FILE=TRIM(ROOT)//'\'//TRIM(MNAME)//'\LUSE_SVAT.INP',STATUS='OLD',ACTION='READ',IOSTAT=IOS)
 IF(IOS.NE.0)RETURN

 ALLOCATE(LUSESVAT%INFO(1),STAT=IOS); IF(IOS.NE.0)RETURN
 LUSESVAT%MXID=0
 DO I=1,2
  N=1
  DO
    READ(IU,'(I6,1X,A19,I6,F6.0,10F8.0,1F8.2,3F6.0)',IOSTAT=IOS) LUSESVAT%INFO(N)%LU,LUSESVAT%INFO(N)%LUNA,LUSESVAT%INFO(N)%VGLU,&
       LUSESVAT%INFO(N)%ALPHACRIT,LUSESVAT%INFO(N)%P1FD,LUSESVAT%INFO(N)%P2FD,LUSESVAT%INFO(N)%P3HFD,LUSESVAT%INFO(N)%P3LFD,&
       LUSESVAT%INFO(N)%P4FD,LUSESVAT%INFO(N)%T3HFD,LUSESVAT%INFO(N)%T3LFD,LUSESVAT%INFO(N)%PBGSPLU,LUSESVAT%INFO(N)%FREVSPLU,&
       LUSESVAT%INFO(N)%GISPLU,LUSESVAT%INFO(N)%TIGISPLU,LUSESVAT%INFO(N)%RPSPLU,LUSESVAT%INFO(N)%TDBGSPLU,LUSESVAT%INFO(N)%TDEDSPLU
   IF(IOS.NE.0)EXIT
   IF(I.EQ.2)THEN ; N=N+1 ; IF(N.GT.LUSESVAT%MXID)EXIT ; ELSE ; LUSESVAT%MXID=LUSESVAT%MXID+1 ; ENDIF
  ENDDO
  IF(I.EQ.1)THEN; DEALLOCATE(LUSESVAT%INFO); ALLOCATE(LUSESVAT%INFO(LUSESVAT%MXID),STAT=IOS); IF(IOS.NE.0)RETURN; ENDIF
  REWIND(IU)
 ENDDO
 CLOSE(IU)

 ALLOCATE(LUSESVAT%LABEL(18),LUSESVAT%UNIT(18),LUSESVAT%IACT(18),LUSESVAT%GRAPH(18),LUSESVAT%INSPVAL(18))

 LUSESVAT%LABEL(1)='LU-index of land use type' ;  LUSESVAT%UNIT(1)='-'
 LUSESVAT%LABEL(2)='LUNA-name of land use type' ;  LUSESVAT%UNIT(2)='-'
 LUSESVAT%LABEL(3)='VGLU-index of vegetation type' ;  LUSESVAT%UNIT(3)='-'
 LUSESVAT%LABEL(4)='ALPHACRIT-parameter of Jarvis(1989)' ;  LUSESVAT%UNIT(4)='-'
 LUSESVAT%LABEL(5)='P1FD-p1 Feddes function' ;  LUSESVAT%UNIT(5)='m'
 LUSESVAT%LABEL(6)='P2FD-p2 Feddes function' ;  LUSESVAT%UNIT(6)='m'
 LUSESVAT%LABEL(7)='P3HFD-p3h Feddes function' ;  LUSESVAT%UNIT(7)='m'
 LUSESVAT%LABEL(8)='P3LFD-p3l Feddes function' ;  LUSESVAT%UNIT(8)='m'
 LUSESVAT%LABEL(9)='P4FD-p4 Feddes function' ;  LUSESVAT%UNIT(9)='m'
 LUSESVAT%LABEL(10)='T3HFD-t3 Feddes function' ;  LUSESVAT%UNIT(10)='mm'
 LUSESVAT%LABEL(11)='T3LFD-t3 Feddes function' ;  LUSESVAT%UNIT(11)='mm'
 LUSESVAT%LABEL(12)='PBGSPLU-pressure head begin sprinkling' ;  LUSESVAT%UNIT(12)='m'
 LUSESVAT%LABEL(13)='FREVSPLU-fraction evaporated sprinkling water' ;  LUSESVAT%UNIT(13)='-'
 LUSESVAT%LABEL(14)='GISPLU-gift in rotational period' ;  LUSESVAT%UNIT(14)='mm'
 LUSESVAT%LABEL(15)='TIGISPLU-duration gift' ;  LUSESVAT%UNIT(15)='d'
 LUSESVAT%LABEL(16)='RPSPLU-rotational period' ;  LUSESVAT%UNIT(16)='d'
 LUSESVAT%LABEL(17)='TDBGSPLU-beginning of sprinkling period' ;  LUSESVAT%UNIT(17)='d'
 LUSESVAT%LABEL(18)='TDEDSPLU-end of sprinkling period' ;  LUSESVAT%UNIT(18)='d'
 LUSESVAT%IACT=1 ;  LUSESVAT%GRAPH=0 ; LUSESVAT%INSPVAL=''

 MSPINSPECTOR_OPENFILES_LUSESVAT=.TRUE.

 END FUNCTION MSPINSPECTOR_OPENFILES_LUSESVAT

 !###======================================================================
 LOGICAL FUNCTION MSPINSPECTOR_OPENFILES_METEGRID(IU)
 !###======================================================================
 IMPLICIT NONE
 INTEGER,INTENT(OUT) :: IU
 INTEGER :: I,IOS,N

 MSPINSPECTOR_OPENFILES_METEGRID=.FALSE.

 !## allocate memory - .......
 IU=UTL_GETUNIT(); OPEN(IU,FILE=TRIM(ROOT)//'\'//TRIM(MNAME)//'\METE_GRID.INP',STATUS='OLD',ACTION='READ',IOSTAT=IOS)
 IF(IOS.NE.0)RETURN

 ALLOCATE(METEGRID%INFO(1),STAT=IOS); IF(IOS.NE.0)RETURN
 METEGRID%MXID=0
 DO I=1,2
  N=1
  DO
    READ(IU,*,IOSTAT=IOS) METEGRID%INFO(N)%TD,METEGRID%INFO(N)%IY,METEGRID%INFO(N)%PRECGRID,METEGRID%INFO(N)%ETREFGRID
   IF(IOS.NE.0)EXIT
   IF(I.EQ.2)THEN ; N=N+1 ; IF(N.GT.METEGRID%MXID)EXIT ; ELSE ; METEGRID%MXID=METEGRID%MXID+1 ; ENDIF
  ENDDO
  IF(I.EQ.1)THEN; DEALLOCATE(METEGRID%INFO); ALLOCATE(METEGRID%INFO(METEGRID%MXID),STAT=IOS); IF(IOS.NE.0)RETURN; ENDIF
  REWIND(IU)
 ENDDO
 CLOSE(IU)

 ALLOCATE(METEGRID%LABEL(4),METEGRID%UNIT(4),METEGRID%IACT(4),METEGRID%GRAPH(4),METEGRID%INSPVAL(4))

 METEGRID%LABEL(1)='TD-day from 00:00:00' ;  METEGRID%UNIT(1)='d'
 METEGRID%LABEL(2)='IY-year number' ;  METEGRID%UNIT(2)='-'
 METEGRID%LABEL(3)='PRECGRID-precipitation' ;  METEGRID%UNIT(3)='mm/d'
 METEGRID%LABEL(4)='ETREFGRID-evapotranspiration' ;  METEGRID%UNIT(4)='mm/d'

 METEGRID%GRAPH=0  ; METEGRID%INSPVAL='' 
 METEGRID%IACT=1   ; METEGRID%GRAPH(3)=1 ; METEGRID%GRAPH(4)=1

 MSPINSPECTOR_OPENFILES_METEGRID=.TRUE.

  END FUNCTION MSPINSPECTOR_OPENFILES_METEGRID

 !###======================================================================
 LOGICAL FUNCTION MSPINSPECTOR_OPENFILES_FACTSVAT(IU)
 !###======================================================================
 IMPLICIT NONE
 INTEGER,INTENT(OUT) :: IU
 INTEGER :: I,IOS,N

 MSPINSPECTOR_OPENFILES_FACTSVAT=.FALSE.

 !## allocate memory - .......
 IU=UTL_GETUNIT(); OPEN(IU,FILE=TRIM(ROOT)//'\'//TRIM(MNAME)//'\FACT_SVAT.INP',STATUS='OLD',ACTION='READ',IOSTAT=IOS)
 IF(IOS.NE.0)RETURN

 ALLOCATE(FACTSVAT%INFO(1),STAT=IOS); IF(IOS.NE.0)RETURN
 FACTSVAT%MXID=0
 DO I=1,2
  N=1
  DO
    READ(IU,'(2I6,9F8.0)',IOSTAT=IOS) FACTSVAT%INFO(N)%VG,FACTSVAT%INFO(N)%DY,FACTSVAT%INFO(N)%CSVG,FACTSVAT%INFO(N)%LAIVG, &
                          FACTSVAT%INFO(N)%VXICVG,FACTSVAT%INFO(N)%FAEVVG,FACTSVAT%INFO(N)%FAEIVG,FACTSVAT%INFO(N)%FAEBSVG,    &
                          FACTSVAT%INFO(N)%FAEPDVG,FACTSVAT%INFO(N)%CHVG,FACTSVAT%INFO(N)%DRPZVG
   IF(IOS.NE.0)EXIT
   IF(I.EQ.2)THEN ; N=N+1 ; IF(N.GT.FACTSVAT%MXID)EXIT ; ELSE ; FACTSVAT%MXID=FACTSVAT%MXID+1 ; ENDIF
  ENDDO
  IF(I.EQ.1)THEN; DEALLOCATE(FACTSVAT%INFO); ALLOCATE(FACTSVAT%INFO(FACTSVAT%MXID),STAT=IOS); IF(IOS.NE.0)RETURN; ENDIF
  REWIND(IU)
 ENDDO
 CLOSE(IU)

 ALLOCATE(FACTSVAT%LABEL(11),FACTSVAT%UNIT(11),FACTSVAT%IACT(11),FACTSVAT%GRAPH(11),FACTSVAT%INSPVAL(11))

 FACTSVAT%LABEL(1)='VG-vegetation type' ;  FACTSVAT%UNIT(1)='-'
 FACTSVAT%LABEL(2)='DY-day number' ;  FACTSVAT%UNIT(2)='-'
 FACTSVAT%LABEL(3)='CSVG-soil cover' ;  FACTSVAT%UNIT(3)='m2/m2'
 FACTSVAT%LABEL(4)='LAIVG-leaf area index' ;  FACTSVAT%UNIT(4)='m2/m2'
 FACTSVAT%LABEL(5)='VXICVG-interception capacity' ;  FACTSVAT%UNIT(5)='m3/m2'
 FACTSVAT%LABEL(6)='FAEVVG-vegetation factor' ;  FACTSVAT%UNIT(6)='-'
 FACTSVAT%LABEL(7)='FAEIVG-factor for interception evaporation' ;  FACTSVAT%UNIT(7)='-'
 FACTSVAT%LABEL(8)='FAEBSVG-factor for bare soil evaporation' ;  FACTSVAT%UNIT(8)='-'
 FACTSVAT%LABEL(9)='FAEPDVG-factor for ponding' ;  FACTSVAT%UNIT(9)='-'
 FACTSVAT%LABEL(10)='CHVG-crop height' ;  FACTSVAT%UNIT(10)='m'
 FACTSVAT%LABEL(11)='DRPZVG-dynamic root zone depth' ;  FACTSVAT%UNIT(11)='m'
 FACTSVAT%IACT=1  ; FACTSVAT%INSPVAL=''
 FACTSVAT%GRAPH=1 ; FACTSVAT%GRAPH(1)=0 ; FACTSVAT%GRAPH(2)=0
 

 MSPINSPECTOR_OPENFILES_FACTSVAT=.TRUE.

 END FUNCTION MSPINSPECTOR_OPENFILES_FACTSVAT

 !###======================================================================
 LOGICAL FUNCTION MSPINSPECTOR_OPENFILES_TIOPSIM(IU)
 !###======================================================================
 IMPLICIT NONE
 INTEGER,INTENT(OUT) :: IU
 INTEGER :: I,IOS,N
 INTEGER :: YEAR,MONTH,DAY

 MSPINSPECTOR_OPENFILES_TIOPSIM=.FALSE.

 !## allocate memory - .......
 IU=UTL_GETUNIT(); OPEN(IU,FILE=TRIM(ROOT)//'\'//TRIM(MNAME)//'\TIOP_SIM.INP',STATUS='OLD',ACTION='READ',IOSTAT=IOS)
 IF(IOS.NE.0)RETURN

 ALLOCATE(TIOPSIM%INFO(1),STAT=IOS); IF(IOS.NE.0)RETURN
 TIOPSIM%MXID=0
 DO I=1,2
  N=1
  DO
    READ(IU,'(F15.0,3I6)',IOSTAT=IOS) TIOPSIM%INFO(N)%TD,TIOPSIM%INFO(N)%IY,TIOPSIM%INFO(N)%IO,TIOPSIM%INFO(N)%IP
   IF(IOS.NE.0)EXIT
   IF(I.EQ.2)THEN ; N=N+1 ; IF(N.GT.TIOPSIM%MXID)EXIT ; ELSE ; TIOPSIM%MXID=TIOPSIM%MXID+1 ; ENDIF
  ENDDO
  IF(I.EQ.1)THEN; DEALLOCATE(TIOPSIM%INFO); ALLOCATE(TIOPSIM%INFO(TIOPSIM%MXID),STAT=IOS); IF(IOS.NE.0)RETURN; ENDIF
  REWIND(IU)
 ENDDO
 CLOSE(IU)

 ALLOCATE(TIOPSIM%LABEL(2),TIOPSIM%UNIT(2),TIOPSIM%IACT(2))

 TIOPSIM%LABEL(1)='Day from beginning year'
 TIOPSIM%LABEL(1)='Year'
 TIOPSIM%IACT=1 

 !## fill dates in TAB5
 CALL WDIALOGSELECT(ID_DMSPANALYSER_TAB5)
 CALL WDIALOGPUTSTRING(IDF_RADIO1,'Use timeserie based on ALL vailable METEO datafiles)')

 MSPSDATE= JD(IYBG,1,1)
 MSPSDATE = MSPSDATE + TDBG
 CALL UTL_GDATE(MSPSDATE,YEAR,MONTH,DAY)
 CALL WDIALOGPUTINTEGER(IDF_INTEGER1,DAY)
 CALL WDIALOGPUTMENU(IDF_MENU5,CDATE,12,MONTH)
 CALL WDIALOGPUTINTEGER(IDF_INTEGER2,YEAR)
 
 YEAR=TIOPSIM%INFO(TIOPSIM%MXID)%IY
 DAY=INT(TIOPSIM%INFO(TIOPSIM%MXID)%TD)
 MSPEDATE=JD(YEAR,1,1)
 MSPEDATE = MSPEDATE + DAY   
 CALL UTL_GDATE(MSPEDATE,YEAR,MONTH,DAY)
 CALL WDIALOGPUTINTEGER(IDF_INTEGER11,DAY)
 CALL WDIALOGPUTMENU(IDF_MENU6,CDATE,12,MONTH)
 CALL WDIALOGPUTINTEGER(IDF_INTEGER12,YEAR)

 MSPINSPECTOR_OPENFILES_TIOPSIM=.TRUE.

 END FUNCTION MSPINSPECTOR_OPENFILES_TIOPSIM

 !###======================================================================
 SUBROUTINE MSPINSPECTOR_GETXY()
 !###======================================================================
 IMPLICIT NONE
 TYPE(WIN_MESSAGE) :: MESSAGE
 INTEGER :: ITYPE,ICOL,IROW,JROW,JCOL,ICURSOR,JCURSOR
 REAL(KIND=DP_KIND) :: MOUSEX,MOUSEY,X1,Y1,X2,Y2
 LOGICAL :: LEX

 CALL WCURSORSHAPE(ID_CURSORIDFVALUE)
 CALL IGRLINETYPE(OUTLINE); CALL IGRLINEWIDTH(3); CALL IGRCOLOURN(UTL_INVERSECOLOUR(WRGB(255,0,0))); CALL IGRPLOTMODE(MODEXOR)

 IROW=0; ICOL=0; LEX=.FALSE.; JCURSOR=ID_CURSORIDFVALUE

 CALL MSPINSPECTOR_CLEANGRIDS()

 DO
  CALL WMESSAGE(ITYPE,MESSAGE)

  ICURSOR=WINFOMOUSE(MOUSECURSOR)
  SELECT CASE (MESSAGE%WIN)
   CASE (1);               JCURSOR=ID_CURSORIDFVALUE
   CASE (ID_DMSPANALYSER); JCURSOR=CURARROW
  END SELECT
  IF(ICURSOR.NE.JCURSOR)CALL WCURSORSHAPE(ID_CURSORIDFVALUE)

  !## shift mouse coordinates
  MOUSEX=DBLE(MESSAGE%GX)+OFFSETX
  MOUSEY=DBLE(MESSAGE%GY)+OFFSETY

  SELECT CASE (ITYPE)

   !## mouse-move
   CASE (MOUSEMOVE)

    CALL WINDOWSELECT(0)
    CALL WINDOWOUTSTATUSBAR(1,'x = '//TRIM(RTOS(MOUSEX,'F',3))//' m; y = '//TRIM(RTOS(MOUSEY,'F',3))//' m')

    CALL WDIALOGSELECT(ID_DMSPANALYSER_TAB2)
    CALL WGRIDPUTCELLDOUBLE(IDF_GRID3,2,2,MOUSEX,'(F15.3)')
    CALL WGRIDPUTCELLDOUBLE(IDF_GRID3,3,2,MOUSEY,'(F15.3)')

    IF(MOUSEX.GE.MSPIDF%XMIN.AND.MOUSEX.LE.MSPIDF%XMAX.AND.MOUSEY.GE.MSPIDF%YMIN.AND.MOUSEY.LE.MSPIDF%YMAX) THEN
      CALL IDFIROWICOL(MSPIDF,JROW,JCOL,MOUSEX,MOUSEY)
      IF(ICOL.NE.JCOL.OR.IROW.NE.JROW)THEN
        CALL IGRCOLOURN(UTL_INVERSECOLOUR(WRGB(255,0,0)))
        CALL UTL_PLOT1BITMAP()
       !## remove drawn rectangle
       IF(LEX)THEN
         CALL IDFGETEDGE(MSPIDF,IROW,ICOL,X1,Y1,X2,Y2)
         CALL DBL_IGRRECTANGLE(X1,Y1,X2,Y2,IOFFSET=1)
       ENDIF
      !## drawn new rectangle
       CALL IDFGETEDGE(MSPIDF,JROW,JCOL,X1,Y1,X2,Y2)
       CALL DBL_IGRRECTANGLE(X1,Y1,X2,Y2,IOFFSET=1)
       CALL UTL_PLOT2BITMAP()
       IROW=JROW; ICOL=JCOL; LEX=.TRUE.
       !## fill GRID only if MF cell contains SVAT
       CALL MSPINSPECTOR_GETXY_PUTVALUES(JROW,JCOL)
      ENDIF
    ELSE
      !## remove drawn rectangle
      IF(LEX)THEN
        CALL IGRCOLOURN(UTL_INVERSECOLOUR(WRGB(255,0,0)))
        CALL UTL_PLOT1BITMAP()
        CALL IDFGETEDGE(MSPIDF,IROW,ICOL,X1,Y1,X2,Y2)
        CALL DBL_IGRRECTANGLE(X1,Y1,X2,Y2,IOFFSET=1)
        CALL UTL_PLOT2BITMAP()
        CALL MSPINSPECTOR_CLEANGRIDS()
        LEX=.FALSE.
      ENDIF
    ENDIF

   !## mouse button pressed
   CASE (MOUSEBUTDOWN)
    SELECT CASE (MESSAGE%VALUE1)
     CASE (RIGHTBUTTON,LEFTBUTTON)
      !## remove drawn rectangle
      IF(LEX)THEN
       CALL IGRCOLOURN(UTL_INVERSECOLOUR(WRGB(255,0,0)))
       CALL UTL_PLOT1BITMAP()
       CALL IDFGETEDGE(MSPIDF,IROW,ICOL,X1,Y1,X2,Y2)
       CALL DBL_IGRRECTANGLE(X1,Y1,X2,Y2,IOFFSET=1)
       CALL UTL_PLOT2BITMAP()
      ENDIF
      EXIT
    END SELECT

   !## bitmap scrolled, renew top-left pixel coordinates
   CASE (BITMAPSCROLLED)
    MPW%IX=MESSAGE%VALUE1
    MPW%IY=MESSAGE%VALUE2

  END SELECT
 ENDDO

 CALL WCURSORSHAPE(CURARROW)
 CALL IGRLINETYPE(OUTLINE); CALL IGRLINEWIDTH(1); CALL IGRCOLOURN((WRGB(0,0,0))); CALL IGRPLOTMODE(MODECOPY)

 END SUBROUTINE MSPINSPECTOR_GETXY

 !###======================================================================
 SUBROUTINE MSPINSPECTOR_GETXY_PUTVALUES(IROW,ICOL)
 !###======================================================================
 IMPLICIT NONE
 INTEGER,INTENT(IN) :: IROW,ICOL
 REAL(KIND=DP_KIND) :: X1,Y1,X2,Y2,NOPP,DX,DY,R
 INTEGER :: JROW,JCOL,T,I,J,K,N,IREXIST,SVATID,IMF
 INTEGER,DIMENSION(2) :: MFID  ! Modflow ID's, max 2. 1) first svat 2) optional irrigation svat
 INTEGER,DIMENSION(3) :: SVATINDEX_MOD  ! Position of rural/irrigation/urban svat in MOD2SVAT
 INTEGER,DIMENSION(2) :: SVATINDEX_AREA ! Position of rural/urban svat in 2) AreaSVAT
 INTEGER :: LUSEINDEX,SCAPINDEX
 LOGICAL :: LEX

 LEX=.FALSE. ; SCAPINDEX=0
 
 !## No SVAT? exit routine, empty GRID fields and remove irrigation rectangles
 IF(SVATRU%X(ICOL,IROW).EQ.0.AND.SVATUR%X(ICOL,IROW).EQ.0)THEN
   CALL WDIALOGSELECT(ID_DMSPANALYSER_TAB2)
   IF(WInfoGridCell(IDF_GRID2,1,1,1).EQ.0)THEN
    RETURN  !# no data in fields, no cleanup
   ELSE
    CALL MSPINSPECTOR_CLEANGRIDS() ; RETURN
   ENDIF
 ENDIF

 !!## Get unique Modflow ID for this cell (from DXC file)
 DO I=1,DXC%MXID
  IF(IROW.EQ.DXC%INFO(I)%IROW.AND.ICOL.EQ.DXC%INFO(I)%ICOL)THEN
    DXC%INSPVAL(1)=ITOS(DXC%INFO(I)%ILAY)  !## first ILAY in DXC file
    DXC%INSPVAL(2)=ITOS(DXC%INFO(I)%IROW)
    DXC%INSPVAL(3)=ITOS(DXC%INFO(I)%ICOL)
    DXC%INSPVAL(4)=ITOS(DXC%INFO(I)%MFID)  !## first MFID in DXC file
    EXIT
  ENDIF
 ENDDO

 SVATINDEX_AREA(1)=SVATRU%X(ICOL,IROW)  ! rural
 SVATINDEX_AREA(2)=SVATUR%X(ICOL,IROW)  ! urban

 !!## Find all SVAT ID's (max 2) from MOD2SVAT file
 SVATINDEX_MOD=0 
 DO I=1,MODSVAT%MXID
   IF(SVATINDEX_AREA(1).EQ.MODSVAT%INFO(I)%SVATID.AND.SVATINDEX_MOD(1).EQ.0)THEN
       SVATINDEX_MOD(1)=I    ! rural
       IF(I.EQ.MODSVAT%MXID) EXIT
       IF(SVATINDEX_AREA(1).EQ.MODSVAT%INFO(I+1)%SVATID) SVATINDEX_MOD(2)=I+1  ! irrigation
   ENDIF    
   DO J=I,MODSVAT%MXID
      IF(SVATINDEX_AREA(2).EQ.MODSVAT%INFO(J)%SVATID) SVATINDEX_MOD(3)=J  ! urban
      EXIT
   ENDDO
 ENDDO
  
 !## start filling grids
 CALL MSPINSPECTOR_CLEANGRIDS()

 CALL IDFGETLOC(MSPIDF,IROW,ICOL,X1,Y1)
 CALL WDIALOGSELECT(ID_DMSPANALYSER_TAB2)
 CALL WGRIDPUTCELLDOUBLE(IDF_GRID3,2,1,X1,'(F15.3)')
 CALL WGRIDPUTCELLDOUBLE(IDF_GRID3,3,1,Y1,'(F15.3)')

 !## fill Rural data (TAB2)
 IF(SVATINDEX_MOD(1).NE.0)THEN
  CALL WDIALOGSELECT(ID_DMSPANALYSER_TAB2)
  CALL WGridPutCellINTEGER(IDF_GRID1,2,1,MODSVAT%INFO(SVATINDEX_MOD(1))%SVATID)
  CALL WGridPutCellINTEGER(IDF_GRID1,3,1,MODSVAT%INFO(SVATINDEX_MOD(1))%MFID)
  CALL WGridPutCellINTEGER(IDF_GRID1,4,1,IROW)
  CALL WGridPutCellINTEGER(IDF_GRID1,5,1,ICOL)
  CALL WGridPutCellINTEGER(IDF_GRID1,6,1,MODSVAT%INFO(SVATINDEX_MOD(1))%LYBE)
 ENDIF

 !## fill Irrigation data (TAB2/(TAB4))
 IF(SVATINDEX_MOD(2).NE.0)THEN
  CALL WDIALOGSELECT(ID_DMSPANALYSER_TAB2)
  CALL WGridPutCellINTEGER(IDF_GRID1,2,2,MODSVAT%INFO(SVATINDEX_MOD(2))%SVATID)
  CALL WGridPutCellINTEGER(IDF_GRID1,3,2,MODSVAT%INFO(SVATINDEX_MOD(2))%MFID)
  CALL WGridPutCellINTEGER(IDF_GRID1,4,2,IROW)
  CALL WGridPutCellINTEGER(IDF_GRID1,5,2,ICOL)
  CALL WGridPutCellINTEGER(IDF_GRID1,6,2,MODSVAT%INFO(SVATINDEX_MOD(2))%LYBE)
  CALL WDIALOGSELECT(ID_DMSPANALYSER_TAB4)
  CALL WGridPutCellINTEGER(IDF_GRID1,1,1,IROW)
  CALL WGridPutCellINTEGER(IDF_GRID1,2,1,ICOL)
  CALL WGridPutCellINTEGER(IDF_GRID1,3,1,MODSVAT%INFO(SVATINDEX_MOD(2))%SVATID)
  CALL WGridPutCellINTEGER(IDF_GRID1,4,1,MODSVAT%INFO(SVATINDEX_MOD(2))%MFID)
  CALL WGridPutCellINTEGER(IDF_GRID1,5,1,MODSVAT%INFO(SVATINDEX_MOD(2))%LYBE)
  CALL WDIALOGSELECT(ID_DMSPANALYSER_TAB2)
 ENDIF

 !## fill Urban data (TAB2)
 IF(SVATINDEX_MOD(3).NE.0)THEN
  CALL WDIALOGSELECT(ID_DMSPANALYSER_TAB2)
  CALL WGridPutCellINTEGER(IDF_GRID1,2,3,MODSVAT%INFO(SVATINDEX_MOD(3))%SVATID)
  CALL WGridPutCellINTEGER(IDF_GRID1,3,3,MODSVAT%INFO(SVATINDEX_MOD(3))%MFID)
  CALL WGridPutCellINTEGER(IDF_GRID1,4,3,IROW)
  CALL WGridPutCellINTEGER(IDF_GRID1,5,3,ICOL)
  CALL WGridPutCellINTEGER(IDF_GRID1,6,3,MODSVAT%INFO(SVATINDEX_MOD(3))%LYBE)
 ENDIF

 !## fill grid with IDF_Svat data (TAB2)
 SVATID=0
 IF(SVATINDEX_MOD(1).NE.0)   THEN !## get Urban or Rural svat
   SVATID=MODSVAT%INFO(SVATINDEX_MOD(1))%SVATID ; ELSE
   SVATID=MODSVAT%INFO(SVATINDEX_MOD(3))%SVATID ; ENDIF

 DO I=1,IDFSVAT%MXID
  IF(SVATID.EQ.IDFSVAT%INFO(I)%NUND)THEN
    CALL WDIALOGSELECT(ID_DMSPANALYSER_TAB2)
    CALL WGridPutCellInteger(IDF_GRID2,1,1,IDFSVAT%INFO(I)%NUND)
    CALL WGridPutCellInteger(IDF_GRID2,2,1,IDFSVAT%INFO(I)%IROW)
    CALL WGridPutCellInteger(IDF_GRID2,3,1,IDFSVAT%INFO(I)%ICOL)
    !   alternative
    IDFSVAT%INSPVAL(1)=ITOS(IDFSVAT%INFO(I)%NUND)  
    IDFSVAT%INSPVAL(2)=ITOS(IDFSVAT%INFO(I)%IROW)
    IDFSVAT%INSPVAL(3)=ITOS(IDFSVAT%INFO(I)%ICOL)
    EXIT
   ENDIF
 ENDDO

 !## start put AREA data (TAB2)
 SVATINDEX_AREA=0
 CALL IDFGETDXDY(MSPIDF,ICOL,IROW,DX,DY) ; NOPP=DX*DY
 CALL WDIALOGSELECT(ID_DMSPANALYSER_TAB2)
 IF(SVATINDEX_MOD(1).NE.0)THEN
   DO I=1,AREASVAT%MXID
     IF(MODSVAT%INFO(SVATINDEX_MOD(1))%SVATID.EQ.AREASVAT%INFO(I)%NUND)THEN
       CALL WGridPutCellDOUBLE(IDF_GRID1,7,1,AREASVAT%INFO(I)%ARK,'(F8.1)')
       NOPP=NOPP-AREASVAT%INFO(I)%ARK
       SVATINDEX_AREA(1)=I
       IF(SVATINDEX_MOD(3).NE.0.AND.I+1.LE.AREASVAT%MXID)THEN   ! assumption : if present, the Urban SVAT always follows the rural svat directely
            IF(MODSVAT%INFO(SVATINDEX_MOD(3))%SVATID.EQ.AREASVAT%INFO(I+1)%NUND)THEN
               CALL WGridPutCellDOUBLE(IDF_GRID1,7,3,AREASVAT%INFO(I+1)%ARK,'(F8.1)')
               NOPP=NOPP-AREASVAT%INFO(I+1)%ARK
               SVATINDEX_AREA(2)=I+1
            ENDIF
        ENDIF
        EXIT
     ENDIF
   ENDDO
 ENDIF
 CALL WGridPutCellDOUBLE(IDF_GRID1,7,4,NOPP,'(F8.1)')

 !## fill grid with METEO data (TAB2)
 CALL WDIALOGSELECT(ID_DMSPANALYSER_TAB2)
 CALL WGRIDGETCELLDOUBLE(IDF_GRID3,2,2,X1)
 CALL WGRIDGETCELLDOUBLE    (IDF_GRID3,3,2,Y1)
 CALL IDFIROWICOL(METEO,JROW,JCOL,X1,Y1)
 CALL WGRIDPUTCELLINTEGER(IDF_GRID4,2,1,JROW)
 CALL WGRIDPUTCELLINTEGER(IDF_GRID4,3,1,JCOL)

 
 IF(SVATINDEX_MOD(1).NE.0)   THEN !## get Urban or Rural svat
   SVATID=MODSVAT%INFO(SVATINDEX_MOD(1))%SVATID ; ELSE
   SVATID=MODSVAT%INFO(SVATINDEX_MOD(3))%SVATID ; ENDIF

 
 
 !## start put data (TAB3)

 !## find modsvat parameters
 !CALL WDialogGetTab(ID_DMSPANALYSER_TAB3,I)
 CALL WDIALOGSELECT(ID_DMSPANALYSER_TAB3)
 CALL WDIALOGGETRADIOBUTTON(IDF_RADIO1,I)
 N=0 
 MODSVAT%INSPVAL(1)=UTL_REALTOSTRING(MFWID%X(ICOL,IROW))
 IF(I.EQ.1)THEN ; MODSVAT%INSPVAL(2)=UTL_REALTOSTRING(SVATRU%X(ICOL,IROW)) ; N=INT(SVATRU%X(ICOL,IROW))
           ELSE ; MODSVAT%INSPVAL(2)=UTL_REALTOSTRING(SVATUR%X(ICOL,IROW)) ; N=INT(SVATUR%X(ICOL,IROW)); ENDIF
 MODSVAT%INSPVAL(3)=UTL_REALTOSTRING(LYBE%X(ICOL,IROW))

 !## find areasvat parameters
 IF(AREASVAT%INFO(N)%NUND.NE.N)THEN ; 
    CALL WMESSAGEBOX(OKONLY,EXCLAMATIONICON,COMMONOK,'Expected SVAT='//TRIM(ITOS(N))//' on element '//TRIM(ITOS(N))//' of file AREA_SVAT.INP','Error'); RETURN ; ENDIF
 AREASVAT%INSPVAL(1)=ITOS(AREASVAT%INFO(N)%NUND)
 AREASVAT%INSPVAL(2)=UTL_REALTOSTRING(AREASVAT%INFO(N)%ARK)
 AREASVAT%INSPVAL(3)=UTL_REALTOSTRING(AREASVAT%INFO(N)%SURF)
 AREASVAT%INSPVAL(4)=UTL_REALTOSTRING(AREASVAT%INFO(N)%TEMP)
 AREASVAT%INSPVAL(5)=ITOS(AREASVAT%INFO(N)%SOIL)
 AREASVAT%INSPVAL(6)=ITOS(AREASVAT%INFO(N)%LUSE)
 AREASVAT%INSPVAL(7)=UTL_REALTOSTRING(AREASVAT%INFO(N)%RZ)
 AREASVAT%INSPVAL(8)=ITOS(AREASVAT%INFO(N)%METE)
 AREASVAT%INSPVAL(9)=UTL_REALTOSTRING(AREASVAT%INFO(N)%LCFPREP)
 AREASVAT%INSPVAL(10)=UTL_REALTOSTRING(AREASVAT%INFO(N)%LCFPOT)

 !## find LUSE_SVAT parameters
 DO N=1,LUSESVAT%MXID
  IF(TRIM(AREASVAT%INSPVAL(6)).EQ.ITOS(LUSESVAT%INFO(N)%LU))THEN
     LUSESVAT%INSPVAL(1)=ITOS(LUSESVAT%INFO(N)%LU)
     LUSESVAT%INSPVAL(2)=TRIM(LUSESVAT%INFO(N)%LUNA)
     LUSESVAT%INSPVAL(3)=ITOS(LUSESVAT%INFO(N)%VGLU)
     LUSESVAT%INSPVAL(4)=UTL_REALTOSTRING(LUSESVAT%INFO(N)%ALPHACRIT)
     LUSESVAT%INSPVAL(5)=UTL_REALTOSTRING(LUSESVAT%INFO(N)%P1FD)
     LUSESVAT%INSPVAL(6)=UTL_REALTOSTRING(LUSESVAT%INFO(N)%P2FD)
     LUSESVAT%INSPVAL(7)=UTL_REALTOSTRING(LUSESVAT%INFO(N)%P3HFD)
     LUSESVAT%INSPVAL(8)=UTL_REALTOSTRING(LUSESVAT%INFO(N)%P3LFD)
     LUSESVAT%INSPVAL(9)=UTL_REALTOSTRING(LUSESVAT%INFO(N)%P4FD)
     LUSESVAT%INSPVAL(10)=UTL_REALTOSTRING(LUSESVAT%INFO(N)%T3HFD)
     LUSESVAT%INSPVAL(11)=UTL_REALTOSTRING(LUSESVAT%INFO(N)%T3LFD)
     LUSESVAT%INSPVAL(12)=UTL_REALTOSTRING(LUSESVAT%INFO(N)%PBGSPLU)
     LUSESVAT%INSPVAL(13)=UTL_REALTOSTRING(LUSESVAT%INFO(N)%FREVSPLU)
     LUSESVAT%INSPVAL(14)=UTL_REALTOSTRING(LUSESVAT%INFO(N)%GISPLU)
     LUSESVAT%INSPVAL(15)=UTL_REALTOSTRING(LUSESVAT%INFO(N)%TIGISPLU)
     LUSESVAT%INSPVAL(16)=UTL_REALTOSTRING(LUSESVAT%INFO(N)%RPSPLU)
     LUSESVAT%INSPVAL(17)=UTL_REALTOSTRING(LUSESVAT%INFO(N)%TDBGSPLU)
     LUSESVAT%INSPVAL(18)=UTL_REALTOSTRING(LUSESVAT%INFO(N)%TDEDSPLU)
     EXIT
  ENDIF
 ENDDO

 !## find FACT_SVAT parameters
 FACTSVAT%INSPVAL='NB only graph'
 FACTSVAT%INSPVAL(1)=LUSESVAT%INSPVAL(3)

 !## find INFI_SVAT parameters
 CALL WDIALOGGETRADIOBUTTON(IDF_RADIO1,I)
 N=0 
 IF(I.EQ.1)THEN ; N=INT(SVATRU%X(ICOL,IROW)) ; ELSE ; N=INT(SVATUR%X(ICOL,IROW)); ENDIF   ! assumption: recordnumber is line number
 IF(INT(N).NE.INFISVAT%INFO(N)%NUND)THEN   
    CALL WMESSAGEBOX(OKONLY,EXCLAMATIONICON,COMMONOK,'Expected SVAT='//TRIM(ITOS(N))//' on line '//TRIM(ITOS(N))//' of file INFI_SVAT.INP','Error'); RETURN ; ENDIF
 INFISVAT%INSPVAL(1)=ITOS(INFISVAT%INFO(N)%NUND) 
 INFISVAT%INSPVAL(2)=UTL_REALTOSTRING(INFISVAT%INFO(N)%QINBASIC)
 INFISVAT%INSPVAL(3)=UTL_REALTOSTRING(INFISVAT%INFO(N)%CTOP_DOWN)
 INFISVAT%INSPVAL(4)=UTL_REALTOSTRING(INFISVAT%INFO(N)%CTOP_UP)
 INFISVAT%INSPVAL(5)=UTL_REALTOSTRING(INFISVAT%INFO(N)%CBOT)
 INFISVAT%INSPVAL(6)=UTL_REALTOSTRING(INFISVAT%INFO(N)%SC2)
     
 !## find SCAP_SVAT parameters
 IF(SVATIR%X(ICOL,IROW).GT.0)THEN
   DO N=1,SCAPSVAT%MXID
     IF(SCAPSVAT%INFO(N)%NUND.EQ.INT(SVATIR%X(ICOL,IROW)))THEN
       SCAPSVAT%INSPVAL(1)=ITOS(SCAPSVAT%INFO(N)%NUND)
       SCAPSVAT%INSPVAL(2)=UTL_REALTOSTRING(SCAPSVAT%INFO(N)%FMMXABGW)
       SCAPSVAT%INSPVAL(3)=UTL_REALTOSTRING(SCAPSVAT%INFO(N)%FMMXABSW)
       SCAPSVAT%INSPVAL(4)=UTL_REALTOSTRING(SCAPSVAT%INFO(N)%FXABGW)
       SCAPSVAT%INSPVAL(5)=UTL_REALTOSTRING(SCAPSVAT%INFO(N)%FXABSW)
       SCAPSVAT%INSPVAL(6)=ITOS(SCAPSVAT%INFO(N)%SVATAB)
       SCAPSVAT%INSPVAL(7)=ITOS(SCAPSVAT%INFO(N)%LYAB)
       SCAPSVAT%INSPVAL(8)=ITOS(SCAPSVAT%INFO(N)%SWNRAB)
       EXIT
     ENDIF    
   ENDDO   
 ELSE
     SCAPSVAT%INSPVAL=' '
 ENDIF  

 !## find METE_GRID parameters
 METEGRID%INSPVAL='NB only graph'
     
CALL MSPINSPECTOR_TAB3_PUTPARAMVALUE

!## Handle irrigation data (TAB 4)
IF(SVATINDEX_MOD(2).NE.0)THEN   !## cell contains irigation svat

  CALL WDIALOGSELECT(ID_DMSPANALYSER_TAB4)
  SVATID=MODSVAT%INFO(SVATINDEX_MOD(2))%SVATID
  LUSEINDEX=AREASVAT%INFO(SVATINDEX_AREA(1))%LUSE
  DO I=1,LUSESVAT%MXID   !## search for applicable landuse parameters
   IF(LUSEINDEX.EQ.LUSESVAT%INFO(I)%LU)THEN
     CALL WGridPutCellDOUBLE(IDF_GRID2,1,1,LUSESVAT%INFO(I)%TDBGSPLU,'(F6.0)')
     CALL WGridPutCellDOUBLE(IDF_GRID2,2,1,LUSESVAT%INFO(I)%TDEDSPLU,'(F6.0)')
     CALL WGridPutCellDOUBLE(IDF_GRID2,3,1,LUSESVAT%INFO(I)%RPSPLU,'(F6.0)')
     CALL WGridPutCellDOUBLE(IDF_GRID2,4,1,LUSESVAT%INFO(I)%PBGSPLU,'(F8.0)')
     CALL WGridPutCellDOUBLE(IDF_GRID2,5,1,LUSESVAT%INFO(I)%TIGISPLU,UTL_GETFORMAT(LUSESVAT%INFO(I)%TIGISPLU))
     CALL WGridPutCellDOUBLE(IDF_GRID2,6,1,LUSESVAT%INFO(I)%GISPLU,'(F8.0)')
     EXIT
   ENDIF
  ENDDO
  DO I=1,SCAPSVAT%MXID  !## search irrigated cell
   IF(SVATID.EQ.SCAPSVAT%INFO(I)%NUND)THEN
    SCAPINDEX=I
    IF(SCAPSVAT%INFO(I)%FMMXABSW.GT.0) CALL WGridPutCellSTRING(IDF_GRID1,6,1,'SW')
    IF(SCAPSVAT%INFO(I)%FMMXABGW.GT.0) CALL WGridPutCellSTRING(IDF_GRID1,6,1,'GW')
    EXIT
   ENDIF
  ENDDO
  !## Handle irrigation rectangles
  CALL WDIALOGGETCHECKBOX(IDF_CHECK1,IREXIST) !## check if irrigation should be plot/
  IF(IREXIST.EQ.1.AND.SCAPINDEX.NE.0)THEN  !## checkbox is on and irrigation source is available, no Surface Water
    CALL WDIALOGSELECT(ID_DMSPANALYSER_TAB4)
    CALL MSPINSPECTOR_CLEANSCAPPOINTER()     !## remove drawn irrigation rectangles
    CALL UTL_PLOT1BITMAP()
    MSPIDF%X=0. ; T=0

    !## fill and draw irrigation source
    SVATID=SCAPSVAT%INFO(SCAPINDEX)%SVATAB
    CALL MSPINSPECTOR_SVAT2ROWCOL(SVATID,JROW,JCOL,IMF)
    CALL WGridPutCellInteger(IDF_GRID3,1,1,JROW)
    CALL WGridPutCellInteger(IDF_GRID3,2,1,JCOL)
    CALL WGridPutCellInteger(IDF_GRID3,3,1,SVATID)
    CALL WGridPutCellInteger(IDF_GRID3,4,1,IMF)
    CALL IGRFILLPATTERN(SOLID)
    CALL IDFGETLOC(MSPIDF,JROW,JCOL,X1,Y1) ; R=0.5*DX ; CALL DBL_IGRCIRCLE(X1,Y1,R,IOFFSET=1)
    X2=X1 ; Y2=Y1

    DO I=1,SCAPSVAT%MXID  !## search for irrigated cells from same source
     IF(SVATID.EQ.SCAPSVAT%INFO(I)%SVATAB)then
       CALL MSPINSPECTOR_SVAT2ROWCOL(SCAPSVAT%INFO(I)%NUND,JROW,JCOL,IMF)
       T=T+1
       CALL WGridPutCellInteger(IDF_GRID4,1,T,JROW)
       CALL WGridPutCellInteger(IDF_GRID4,2,T,JCOL)
       CALL WGridPutCellInteger(IDF_GRID4,3,T,SCAPSVAT%INFO(I)%NUND)
       CALL WGridPutCellInteger(IDF_GRID4,4,T,IMF)

       MSPIDF%X(JCOL,JROW)=MSPIDF%X(JCOL,JROW) + 1.
       IF(MSPIDF%X(JCOL,JROW).EQ.1)THEN
           !## drawn new rectangles
        !   script to draw circle
        !   CALL IGRLINEWIDTH(1); CALL IGRFILLPATTERN(SOLID); CALL IGRCOLOURN(WRGB(50,50,50))
        !   CALL DBL_IGRCIRCLE(DATISC2(J,I)%DISTANCE,DATISC2(J,I)%BOTTOM,DX/2.0D0)
        !  SUBROUTINE DBL_IGRCIRCLE(X,Y,R,IOFFSET)    wellicht cirkel om gebied te tekenen rond te irrigeren cellen.
        !    SUBROUTINE DBL_IGRLINETO(X,Y,IOFFSET)  of ook leuk, verbinding leggen tussen bron en doel cel.
         CALL IDFGETLOC(MSPIDF,JROW,JCOL,X1,Y1)
         CALL DBL_IGRJOIN(X1,Y1,X2,Y2,IOFFSET=1)
         CALL IGRCOLOURN(UTL_INVERSECOLOUR(WRGB(0,0,255))) !## blue rectancle for irrigation cells
         CALL IGRFILLPATTERN(OUTLINE)
         CALL IDFGETLOC(MSPIDF,JROW,JCOL,X1,Y1) ; R=0.4*DX ; CALL DBL_IGRCIRCLE(X1,Y1,R,IOFFSET=1)
       ENDIF
     ENDIF
    ENDDO ! I loop
    CALL UTL_PLOT2BITMAP()
    CALL IGRFILLPATTERN(OUTLINE)
  ENDIF ! draw irrigation data
ENDIF

END SUBROUTINE MSPINSPECTOR_GETXY_PUTVALUES

 !###======================================================================
 SUBROUTINE MSPINSPECTOR_MAIN_FIELDS()
 !###======================================================================
 IMPLICIT NONE

 END SUBROUTINE MSPINSPECTOR_MAIN_FIELDS

 !###======================================================================
 SUBROUTINE MSPINSPECTOR_TAB1_FIELDS()
 !###======================================================================
 IMPLICIT NONE
 INTEGER :: I

 CALL MSPINSPECTOR_OPENFILES_FIELDS(0)

 CALL WDIALOGSELECT(ID_DMSPANALYSER_TAB1)
 CALL WDIALOGGETRADIOBUTTON(IDF_RADIO1,I)
 CALL WDIALOGFIELDSTATE(IDF_STRING1,I)
 CALL WDIALOGFIELDSTATE(ID_SELECT,I)

  !## refill menu of folders
 CALL MSPINSPECTOR_FILL_FOLDERLIST()

 END SUBROUTINE MSPINSPECTOR_TAB1_FIELDS

 !###======================================================================
 SUBROUTINE MSPINSPECTOR_TAB2_FIELDS()
 !###======================================================================
 IMPLICIT NONE

 END SUBROUTINE MSPINSPECTOR_TAB2_FIELDS

 !###======================================================================
 SUBROUTINE MSPINSPECTOR_TAB3_FIELDS()
 !###======================================================================
 IMPLICIT NONE

 CALL MSPINSPECTOR_TAB3_GETPARAMLIST()
 
 END SUBROUTINE MSPINSPECTOR_TAB3_FIELDS

 !###======================================================================
 SUBROUTINE MSPINSPECTOR_TAB4_FIELDS()
 !###======================================================================
 IMPLICIT NONE

 END SUBROUTINE MSPINSPECTOR_TAB4_FIELDS

 !###======================================================================
 SUBROUTINE MSPINSPECTOR_TAB5_FIELDS()
 !###======================================================================
 IMPLICIT NONE
 INTEGER :: I,J
 INTEGER,DIMENSION(14) :: ID
 DATA ID/IDF_LABEL1,IDF_LABEL2,IDF_MENU5,IDF_MENU6,IDF_INTEGER1,IDF_INTEGER2,IDF_INTEGER3,IDF_INTEGER4,IDF_INTEGER5, &
   IDF_INTEGER11,IDF_INTEGER12,IDF_INTEGER13,IDF_INTEGER14,IDF_INTEGER15/

 CALL WDIALOGSELECT(ID_DMSPANALYSER_TAB5)
 CALL WDIALOGGETRADIOBUTTON(IDF_RADIO1,J)

 DO I=1,SIZE(ID); CALL WDIALOGFIELDSTATE(ID(I),ABS(J-1)); ENDDO

 !## from date
 CALL UTL_FILLDATES(IDF_INTEGER2, IDF_MENU5,IDF_INTEGER1,MSPSDATE)
 !## to date
 CALL UTL_FILLDATES(IDF_INTEGER12,IDF_MENU6,IDF_INTEGER11,MSPEDATE)

 END SUBROUTINE MSPINSPECTOR_TAB5_FIELDS

 !###======================================================================
 SUBROUTINE MSPINSPECTOR_INIT()
 !###======================================================================
 IMPLICIT NONE
 INTEGER :: IROW,ICOL

 CALL WINDOWSELECT(0)
 IF(WMENUGETSTATE(ID_MSPANALYSER,2).EQ.1)THEN
  CALL MSPINSPECTOR_CLOSE(); RETURN
 ENDIF

 CALL MAIN_UTL_INACTMODULE(ID_MSPANALYSER)

 !## other module not closed, no approvement given to start this functionality
 IF(IDIAGERROR.EQ.1)RETURN

 CALL WMENUSETSTATE(ID_MSPANALYSER,2,1)
 CALL WDIALOGLOAD(ID_DMSPANALYSER,ID_DMSPANALYSER)

 !## fill front tab
 CALL WDIALOGSELECT(ID_DMSPANALYSER_TAB1)
 CALL WDIALOGPUTIMAGE(ID_SELECT,ID_ICONOPEN)      ; CALL WDIALOGTOOLTIP(ID_SELECT,'Open non-default MODEL location')
 CALL WDIALOGPUTIMAGE(ID_ZOOMFULL,ID_ICONZOOMFULL); CALL WDIALOGTOOLTIP(ID_ZOOMFULL,'Zoom to modelwindow')
 CALL WDIALOGFIELDOPTIONS(IDF_STRING1,EDITFIELDCHANGED,ENABLED)

 CALL MSPINSPECTOR_TAB1_FIELDS()

 !## initial outgrey tabs
 CALL WDIALOGSELECT(ID_DMSPANALYSER)
 CALL WDIALOGFIELDSTATE(IDOK,0) ; CALL WDIALOGTOOLTIP(IDOK,'Start hoovering to inspect parameter values')
 CALL WDIALOGTABSTATE(IDF_TAB1,ID_DMSPANALYSER_TAB2,0)
 CALL WDIALOGTABSTATE(IDF_TAB1,ID_DMSPANALYSER_TAB3,0)
 CALL WDIALOGTABSTATE(IDF_TAB1,ID_DMSPANALYSER_TAB4,0)
 CALL WDIALOGTABSTATE(IDF_TAB1,ID_DMSPANALYSER_TAB5,0)

 !## fill tabs 2
 CALL WDIALOGSELECT(ID_DMSPANALYSER_TAB2)
 DO IROW=1,4 ; DO ICOL=2,7 ;  CALL WGRIDSTATECELL(IDF_GRID1,ICOL,IROW,DIALOGREADONLY) ; ENDDO ; ENDDO
 DO IROW=1,2 ; DO ICOL=2,3 ;  CALL WGRIDSTATECELL(IDF_GRID2,ICOL,IROW,DIALOGREADONLY) ; ENDDO ; ENDDO
 DO IROW=1,2 ; DO ICOL=2,3 ;  CALL WGRIDSTATECELL(IDF_GRID3,ICOL,IROW,DIALOGREADONLY) ; ENDDO ; ENDDO
 DO IROW=1,2 ; DO ICOL=2,3 ;  CALL WGRIDSTATECELL(IDF_GRID4,ICOL,IROW,DIALOGREADONLY) ; ENDDO ; ENDDO
 DO IROW=1,2 ; DO ICOL=2,3 ;  CALL WGRIDSTATECELL(IDF_GRID5,ICOL,IROW,DIALOGREADONLY) ; ENDDO ; ENDDO


 !## fill tabs 3
 CALL WDIALOGSELECT(ID_DMSPANALYSER_TAB3)
 DO IROW=1,4 ; DO ICOL=2,2 ;  CALL WGRIDSTATECELL(IDF_GRID1,ICOL,IROW,DIALOGREADONLY) ; ENDDO ; ENDDO

 !## fill tabs 4
 CALL WDIALOGSELECT(ID_DMSPANALYSER_TAB4)
 CALL WDIALOGPUTIMAGE(IDF_PICTURE1,ID_ICONIRRIGATION1,1)
 CALL WDIALOGPUTIMAGE(IDF_PICTURE2,ID_ICONIRRIGATION2,1)
 CALL WDIALOGPUTIMAGE(IDF_PICTURE3,ID_ICONIRRIGATION3,1)
 !CALL WDialogFieldState(IDF_GRID1,0)
 !CALL WDialogFieldState(IDF_GRID2,0)
 !CALL WDialogFieldState(IDF_GRID3,0)
 !CALL WDialogFieldState(IDF_GRID4,0)
 !
 !## fill tabs 5
 CALL WDIALOGSELECT(ID_DMSPANALYSER_TAB5)
 CALL WDIALOGPUTIMAGE(ID_OPEN,ID_ICONOPEN,1)     ; CALL WDIALOGTOOLTIP(ID_OPEN,'Save selected parameterset to file')
 CALL WDIALOGPUTIMAGE(ID_SAVE,ID_ICONSAVEAS,1)   ; CALL WDIALOGTOOLTIP(ID_SAVE,'Load selected parameterset from file')

 CALL WDIALOGPUTMENU(IDF_MENU1,MSFILES,SIZE(MSFILES),1)
 
 CALL WDIALOGSELECT(ID_DMSPANALYSER); CALL WDIALOGSHOW(-1,-1,0,2)

 END SUBROUTINE MSPINSPECTOR_INIT

END MODULE MOD_MSPINSPECTOR
