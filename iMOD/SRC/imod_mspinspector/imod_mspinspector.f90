!!  Copyright (C) Stichting Deltares, 2005-2018.
!!
!!  This file is part of iMOD.
!!
!!  This program is free software: you can redistribute it and/or modify
!!  it under the terms of the GNU General Public License as published by
!!  the Free Software Foundation, either version 3 of the License, or
!!  (at your option) any later version.
!!
!!  This program is distributed in the hope that it will be useful,
!!  but WITHOUT ANY WARRANTY; without even the implied warranty of
!!  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
!!  GNU General Public License for more details.
!!
!!  You should have received a copy of the GNU General Public License
!!  along with this program.  If not, see <http://www.gnu.org/licenses/>.
!!
!!  Contact: imod.support@deltares.nl
!!  Stichting Deltares
!!  P.O. Box 177
!!  2600 MH Delft, The Netherlands.
!!
MODULE MOD_MSPINSPECTOR

USE WINTERACTER
USE RESOURCE
USE MOD_MSPINSPECTOR_PAR
USE MOD_MSPINSPECTOR_UTL
USE MOD_PREF_PAR, ONLY : PREFVAL
USE MOD_IDF, ONLY : IDFNULLIFY,IDFALLOCATEX
USE MOD_UTL, ONLY : UTL_GETUNIT,UTL_CAP,UTL_IMODFILLMENU,ITIMETOGDATE
USE MOD_MAIN_UTL, ONLY : MAIN_UTL_INACTMODULE

CONTAINS

 !###======================================================================
 SUBROUTINE MSPINSPECTOR_MAIN(ITYPE,MESSAGE)
 !###======================================================================
 IMPLICIT NONE
 TYPE(WIN_MESSAGE),INTENT(INOUT) :: MESSAGE
 INTEGER,INTENT(IN) :: ITYPE

 SELECT CASE (MESSAGE%WIN)

  CASE (ID_DMSPANALYSER_TAB1); CALL MSPINSPECTOR_TAB1(ITYPE,MESSAGE)

  CASE (ID_DMSPANALYSER_TAB2); CALL MSPINSPECTOR_TAB2(ITYPE,MESSAGE)

  CASE (ID_DMSPANALYSER_TAB3); CALL MSPINSPECTOR_TAB3(ITYPE,MESSAGE)

  CASE (ID_DMSPANALYSER_TAB4); CALL MSPINSPECTOR_TAB4(ITYPE,MESSAGE)

  CASE (ID_DMSPANALYSER_TAB5); CALL MSPINSPECTOR_TAB5(ITYPE,MESSAGE)

  CASE (ID_DMSPANALYSER)
   SELECT CASE (ITYPE)

     !## case tab changed
     CASE (TABCHANGED)
       SELECT CASE (MESSAGE%VALUE1)
       END SELECT

     !## case field changed
     CASE (FIELDCHANGED)
       CALL MSPINSPECTOR_MAIN_FIELDS()

     !## pushbutton
     CASE (PUSHBUTTON)
       SELECT CASE (MESSAGE%VALUE1)
         CASE(IDOK) 
            CALL WCURSORSHAPE(ID_CURSORIDFVALUE)
            CALL MSPINSPECTOR_GETXY()

         CASE (IDHELP)
          ! CALL UTL_GETHELP('4.4.3.3','MMO.IGO.IE.Search')
         CASE (IDCANCEL)
            CALL MSPINSPECTOR_CLOSE()
       END SELECT
   END SELECT
 END SELECT

 END SUBROUTINE MSPINSPECTOR_MAIN

 !###======================================================================
 SUBROUTINE MSPINSPECTOR_TAB1(ITYPE,MESSAGE)
 !###======================================================================
 IMPLICIT NONE
 TYPE(WIN_MESSAGE),INTENT(INOUT) :: MESSAGE
 INTEGER,INTENT(IN) :: ITYPE

 SELECT CASE (ITYPE)

  !## case field changed
  CASE (FIELDCHANGED)
    SELECT CASE (MESSAGE%VALUE1)
      CASE (IDF_RADIO1,IDF_RADIO2,IDF_STRING1)
        CALL MSPINSPECTOR_TAB1_FIELDS()
        CALL MSPINSPECTOR_FILL_FOLDERLIST()
    END SELECT

  !## pushbutton
  CASE (PUSHBUTTON)
      
   SELECT CASE (MESSAGE%VALUE1)
    CASE (ID_OPEN)
     IF(.NOT.MSPINSPECTOR_OPENFILES())CALL MSPINSPECTOR_DEALLOCATE()
    CASE (ID_OPEN2)
       ROOT=TRIM(PREFVAL(1))//'\MODEL\'
       CALL WSELECTDIR(DIRCHANGE,ROOT,'Select Model Result Directory')
       IF(WINFODIALOG(4).EQ.1)THEN
        CALL WDIALOGSELECT(ID_DMSPANALYSER_TAB1)
        CALL WDIALOGPUTSTRING(IDF_STRING1,TRIM(ROOT))
        CALL MSPINSPECTOR_FILL_FOLDERLIST()
       ENDIF
 
    END SELECT
 END SELECT

 END SUBROUTINE MSPINSPECTOR_TAB1

 !###======================================================================
 SUBROUTINE MSPINSPECTOR_TAB2(ITYPE,MESSAGE)
 !###======================================================================
 IMPLICIT NONE
 TYPE(WIN_MESSAGE),INTENT(INOUT) :: MESSAGE
 INTEGER,INTENT(IN) :: ITYPE

 SELECT CASE (ITYPE)

  !## case field changed
  CASE (FIELDCHANGED)
   CALL MSPINSPECTOR_TAB2_FIELDS()

  !## pushbutton
  CASE (PUSHBUTTON)
   SELECT CASE (MESSAGE%VALUE1)
   END SELECT
 END SELECT

 END SUBROUTINE MSPINSPECTOR_TAB2

  !###======================================================================
 SUBROUTINE MSPINSPECTOR_TAB3(ITYPE,MESSAGE)
 !###======================================================================
 IMPLICIT NONE
 TYPE(WIN_MESSAGE),INTENT(INOUT) :: MESSAGE
 INTEGER,INTENT(IN) :: ITYPE

 SELECT CASE (ITYPE)

  !## case field changed
  CASE (FIELDCHANGED)
   CALL MSPINSPECTOR_TAB3_FIELDS()

  !## pushbutton
  CASE (PUSHBUTTON)
   SELECT CASE (MESSAGE%VALUE1)
     CASE(IDOK1)
      ! moet nog een subroutine  MSPINSPECTOR_GRAPH komen
      CALL WDIALOGLOAD(ID_DMSPANALYSER_GRAPH,ID_DMSPANALYSER_GRAPH); CALL WDIALOGSHOW(-1,-1,0,2)
   END SELECT
 END SELECT

 END SUBROUTINE MSPINSPECTOR_TAB3

  !###======================================================================
 SUBROUTINE MSPINSPECTOR_TAB4(ITYPE,MESSAGE)
 !###======================================================================
 IMPLICIT NONE
 TYPE(WIN_MESSAGE),INTENT(INOUT) :: MESSAGE
 INTEGER,INTENT(IN) :: ITYPE

 SELECT CASE (ITYPE)

  !## case field changed
  CASE (FIELDCHANGED)
   CALL MSPINSPECTOR_TAB4_FIELDS()

  !## pushbutton
  CASE (PUSHBUTTON)
   SELECT CASE (MESSAGE%VALUE1)
   END SELECT
 END SELECT

 END SUBROUTINE MSPINSPECTOR_TAB4

  !###======================================================================
 SUBROUTINE MSPINSPECTOR_TAB5(ITYPE,MESSAGE)
 !###======================================================================
 IMPLICIT NONE
 TYPE(WIN_MESSAGE),INTENT(INOUT) :: MESSAGE
 INTEGER,INTENT(IN) :: ITYPE

 INTEGER(KIND=8) :: IDATE
 INTEGER :: IY,IM,ID,IHR,IMT,ISC

 
 ! initieel vullen van scherm vooraf?
 !CALL MSPINSPECTOR_TAB5_PUTPARAMLIST()

 SELECT CASE (ITYPE)

  !## case field changed
  CASE (FIELDCHANGED)
    CALL MSPINSPECTOR_TAB5_FIELDS()   
    
    SELECT CASE (MESSAGE%VALUE1)
      CASE (ID_OPEN1,ID_OPEN2)   
         ! load en save van settings file

      CASE (IDF_MENU1,IDF_MENU2)
        CALL MSPINSPECTOR_TAB5_PUTPARAMLIST()   ! of liever anders, hergebruik van onderstaande 2 subroutines (Staan al uitgecom. in deze code)
   !  CASE (IDF_MENU1)
    !    CALL MODEL1FILLSAVINGS()
   !  CASE (IDF_MENU2)
   !    CALL MODEL1GETSAVINGS()

        
        !! Vullen, lezen van tijdserie moet naar aparte subroutines (zoals bij andere knoppen)
      !CASE (IDF_INTEGER1, IDF_INTEGER2, IDF_INTEGER3, IDF_INTEGER4, IDF_INTEGER5, &
      !      IDF_INTEGER11,IDF_INTEGER12,IDF_INTEGER13,IDF_INTEGER14,IDF_INTEGER15, &
      !      IDF_MENU5,IDF_MENU6,IDF_RADIO1,IDF_RADIO2)
      !
      !       CALL WDIALOGSELECT(ID_DMSPANALYSER_TAB5)
      !       !CALL WDIALOGPUTSTRING(IDF_RADIO1,'Use ALL available dates ('//TRIM(ITOS(SUM(NFILES)))//'-files)')
      !       CALL ITIMETOGDATE(20191011121314,IY,IM,ID,IHR,IMT,ISC)
      !       !CALL ITIMETOGDATE(MINDATETIME,IY,IM,ID,IHR,IMT,ISC)
      !       !CALL WDIALOGPUTMENU(IDF_MENU5,CDATE,12,IM)
      !       CALL WDIALOGPUTINTEGER(IDF_INTEGER1,ID)
      !       CALL WDIALOGPUTINTEGER(IDF_INTEGER2,IY)
      !       CALL WDIALOGPUTINTEGER(IDF_INTEGER3,IHR)
      !       CALL WDIALOGPUTINTEGER(IDF_INTEGER4,IMT)
      !       CALL WDIALOGPUTINTEGER(IDF_INTEGER5,ISC)
      !       CALL ITIMETOGDATE(20200102030405,IY,IM,ID,IHR,IMT,ISC)
      !       !CALL ITIMETOGDATE(MAXDATETIME,IY,IM,ID,IHR,IMT,ISC)
      !       !CALL WDIALOGPUTMENU(IDF_MENU6,CDATE,12,IM)
      !       CALL WDIALOGPUTINTEGER(IDF_INTEGER11,ID)
      !       CALL WDIALOGPUTINTEGER(IDF_INTEGER12,IY)
      !       CALL WDIALOGPUTINTEGER(IDF_INTEGER13,IHR)
      !       CALL WDIALOGPUTINTEGER(IDF_INTEGER14,IMT)
      !       CALL WDIALOGPUTINTEGER(IDF_INTEGER15,ISC)
 
        !CALL MSINPECTOR_TIMEFIELD()
      CASE (IDF_MENU3,IDF_MENU4)
         ! format voorkeuren

    END SELECT
      
  !## pushbutton
  CASE (PUSHBUTTON)
   SELECT CASE (MESSAGE%VALUE1)
   END SELECT
 END SELECT

 END SUBROUTINE MSPINSPECTOR_TAB5

 !###======================================================================
 SUBROUTINE MSPINSPECTOR_FILL_FOLDERLIST()
 !###======================================================================
 IMPLICIT NONE
 INTEGER :: N,I
 !CHARACTER(LEN=256) :: MODELROOT

 CALL WDIALOGSELECT(ID_DMSPANALYSER_TAB1)
 CALL WDIALOGGETRADIOBUTTON(IDF_RADIO1,I)
 IF(I.EQ.1)THEN
  CALL WDIALOGGETSTRING(IDF_STRING1,ROOT)
 ELSE
  ROOT=TRIM(PREFVAL(1))//'\MODEL'
 ENDIF

 N=1; CALL UTL_IMODFILLMENU(IDF_MENU1,TRIM(ROOT),'*','D',N,0,0)! 1)   !

 END SUBROUTINE MSPINSPECTOR_FILL_FOLDERLIST

 !###======================================================================
 SUBROUTINE MSPINSPECTOR_TAB5_PUTPARAMLIST()
 !###======================================================================
 IMPLICIT NONE
 INTEGER :: N,I
 INTEGER, PARAMETER                   :: NFRUIT = 4
 CHARACTER(LEN=7), DIMENSION(NFRUIT)  :: FRUIT = &
           (/'Apples ','Oranges','Pears  ','Bananas'/)
 
 CALL WDIALOGSELECT(ID_DMSPANALYSER_TAB5)
 !CALL WDIALOGGETMENU(IDF_MENU1,i)
 i=4
 !CALL WDIALOGCLEARFIELD(IDF_MENU2)
 !CALL WDIALOGFIELDSTATE(IDF_MENU2,1)
 select case (i)
  case (1)
!   CALL WDIALOGPUTMENU(IDF_MENU2,areasvat%label,size(areasvat%label),areasvat%iact)
  end select
 END SUBROUTINE MSPINSPECTOR_TAB5_PUTPARAMLIST

 !!###======================================================================
 !SUBROUTINE MODEL1FILLSAVINGS()
 !!###======================================================================
 !IMPLICIT NONE
 !INTEGER :: I,J
 !INTEGER,ALLOCATABLE,DIMENSION(:) :: ILIST
 !CHARACTER(LEN=10),DIMENSION(:),ALLOCATABLE :: CLAY
 !
 !!## maximum number of layers
 !CALL WDIALOGSELECT(ID_DMDLTAB2)
 !CALL WDIALOGGETMENU(IDF_MENU3,NLAY)
 !IF(NLAY.LE.0)RETURN
 ! 
 !!## selected item to be saved
 !CALL WDIALOGSELECT(ID_DMDLTAB3)
 !CALL WDIALOGGETMENU(IDF_MENU1,I)
 !!## error occured in runfile
 !IF(I.LE.0)RETURN
 !
 !I=MDL_IPOS(I)
 !
 !IF(IAMDL(I).LE.0)THEN
 ! CALL WDIALOGCLEARFIELD(IDF_MENU2)
 ! CALL WDIALOGPUTSTRING(IDF_LABEL9,'Not active')
 ! CALL WDIALOGFIELDSTATE(IDF_MENU2,2)
 !ELSE
 ! !## nlay
 ! IF(ALLOCATED(CLAY))DEALLOCATE(CLAY)
 ! ALLOCATE(CLAY(NLAY))
 ! DO J=1,NLAY; WRITE(CLAY(J),'(I10)') J; END DO
 ! IF(ALLOCATED(ILIST))DEALLOCATE(ILIST); ALLOCATE(ILIST(NLAY)); ILIST=0
 ! DO J=1,MIN(NLAY,NLMDL(I))
 !  IF(ILMDL(I,J).EQ.0)THEN
 !   ILIST=1
 !  ELSEIF(ILMDL(I,J).GT.0.AND.ILMDL(I,J).LE.NLAY)THEN
 !   ILIST(ILMDL(I,J))=1
 !  ENDIF
 ! END DO
 ! CALL WDIALOGPUTSTRING(IDF_LABEL9,'Selected Layers')
 ! CALL WDIALOGFIELDSTATE(IDF_MENU2,1)
 ! CALL WDIALOGPUTMENU(IDF_MENU2,CLAY,NLAY,ILIST)
 ! IF(ALLOCATED(ILIST))DEALLOCATE(ILIST); IF(ALLOCATED(CLAY))DEALLOCATE(CLAY)
 !ENDIF
 !
 !END SUBROUTINE MODEL1FILLSAVINGS
 !
 !!###======================================================================
 !SUBROUTINE MODEL1GETSAVINGS()
 !!###======================================================================
 !IMPLICIT NONE
 !INTEGER :: I,J,K
 !INTEGER,ALLOCATABLE,DIMENSION(:) :: ILIST
 !
 !CALL WDIALOGSELECT(ID_DMDLTAB2)
 !CALL WDIALOGGETMENU(IDF_MENU3,NLAY)
 !
 !CALL WDIALOGSELECT(ID_DMDLTAB3)
 !CALL WDIALOGGETMENU(IDF_MENU1,I)
 !I=MDL_IPOS(I)
 !
 !IF(ALLOCATED(ILIST))DEALLOCATE(ILIST)
 !ALLOCATE(ILIST(NLAY))
 !ILIST=0
 !CALL WDIALOGGETMENU(IDF_MENU2,ILIST)
 !NLMDL(I)=0
 !K=0
 !DO J=1,NLAY
 ! IF(ILIST(J).EQ.1)THEN
 !  K=K+1
 !  NLMDL(I)  =NLMDL(I)+1
 !  ILMDL(I,K)=J
 ! ENDIF
 !END DO
 !
 !IF(ALLOCATED(ILIST))DEALLOCATE(ILIST)
 !
 !END SUBROUTINE MODEL1GETSAVINGS

 
 !###======================================================================
 LOGICAL FUNCTION MSPINSPECTOR_OPENFILES()
 !###======================================================================
 IMPLICIT NONE
 INTEGER :: IU, I
 LOGICAL :: LEX

 MSPINSPECTOR_OPENFILES=.FALSE.

 !## get foldername
 CALL WDIALOGSELECT(ID_DMSPANALYSER_TAB1)
 CALL WDIALOGGETMENU(IDF_MENU1,i,CVALUE=MNAME)
 
 CALL MSPINSPECTOR_DEALLOCATE();

 !## open files
 IF(.NOT.MSPINSPECTOR_OPENFILES_DXC(IU))THEN
  INQUIRE(UNIT=IU,OPENED=LEX); IF(LEX)CLOSE(IU)
  CALL WMESSAGEBOX(OKONLY,EXCLAMATIONICON,COMMONOK,'iMOD cannot open file '//CHAR(13)//TRIM(ROOT)//'\'//TRIM(MNAME)//'\MF2005_TMP\'//TRIM(MNAME)//'.DXC','Error'); RETURN
 ENDIF
 IF(.NOT.MSPINSPECTOR_OPENFILES_MOD2SVAT(IU))THEN
  INQUIRE(UNIT=IU,OPENED=LEX); IF(LEX)CLOSE(IU)
  CALL WMESSAGEBOX(OKONLY,EXCLAMATIONICON,COMMONOK,'iMOD cannot open file '//CHAR(13)//TRIM(ROOT)//'\'//TRIM(MNAME)//'\MOD2SVAT.INP','Error'); RETURN
 ENDIF
 IF(.NOT.MSPINSPECTOR_OPENFILES_IDF2SVAT(IU))THEN
  INQUIRE(UNIT=IU,OPENED=LEX); IF(LEX)CLOSE(IU)
  CALL WMESSAGEBOX(OKONLY,EXCLAMATIONICON,COMMONOK,'iMOD cannot open file '//CHAR(13)//TRIM(ROOT)//'\'//TRIM(MNAME)//'\IDF_SVAT.INP','Error'); RETURN
 ENDIF
 IF(.NOT.MSPINSPECTOR_OPENFILES_PARASIM(IU))THEN
  INQUIRE(UNIT=IU,OPENED=LEX); IF(LEX)CLOSE(IU)
  CALL WMESSAGEBOX(OKONLY,EXCLAMATIONICON,COMMONOK,'iMOD cannot open file '//CHAR(13)//TRIM(ROOT)//'\'//TRIM(MNAME)//'\PARA_SIM.INP','Error'); RETURN
 ENDIF
 IF(.NOT.MSPINSPECTOR_OPENFILES_AREASVAT(IU))THEN
  INQUIRE(UNIT=IU,OPENED=LEX); IF(LEX)CLOSE(IU)
  CALL WMESSAGEBOX(OKONLY,EXCLAMATIONICON,COMMONOK,'iMOD cannot open file '//CHAR(13)//TRIM(ROOT)//'\'//TRIM(MNAME)//'\AREA_SVAT.INP','Error'); RETURN
 ENDIF

 !## activate tabs
 CALL WDIALOGSELECT(ID_DMSPANALYSER)
 CALL WDIALOGFIELDSTATE(IDOK,1)
 CALL WDIALOGTABSTATE(IDF_TAB1,ID_DMSPANALYSER_TAB2,1)
 CALL WDIALOGTABSTATE(IDF_TAB1,ID_DMSPANALYSER_TAB3,1)
 CALL WDIALOGTABSTATE(IDF_TAB1,ID_DMSPANALYSER_TAB4,1)
 CALL WDIALOGTABSTATE(IDF_TAB1,ID_DMSPANALYSER_TAB5,1)

 MSPINSPECTOR_OPENFILES=.TRUE.

 END FUNCTION MSPINSPECTOR_OPENFILES

 !###======================================================================
 LOGICAL FUNCTION MSPINSPECTOR_OPENFILES_DXC(IU)
 !###======================================================================
 IMPLICIT NONE
 INTEGER,INTENT(OUT) :: IU
 INTEGER :: I,IOS

 MSPINSPECTOR_OPENFILES_DXC=.FALSE.

 !## allocate memory - mainly number of svats
 IU=UTL_GETUNIT(); OPEN(IU,FILE=TRIM(ROOT)//'\'//TRIM(MNAME)//'\MF2005_TMP\'//TRIM(MNAME)//'.DXC',STATUS='OLD',ACTION='READ',IOSTAT=IOS)
 IF(IOS.NE.0)RETURN

 READ(IU,*,IOSTAT=IOS) DXC%MXID; IF(IOS.NE.0)RETURN
 READ(IU,*,IOSTAT=IOS) DXC%MXID; IF(IOS.NE.0)RETURN
 ALLOCATE(DXC%INFO(DXC%MXID),STAT=IOS); IF(IOS.NE.0)RETURN
 ALLOCATE(DXC%LABEL(DXC%MXID),STAT=IOS); IF(IOS.NE.0)RETURN
 DO I=1,DXC%MXID
  READ(IU,*,IOSTAT=IOS) DXC%INFO(I)%ILAY,DXC%INFO(I)%IROW,DXC%INFO(I)%ICOL,DXC%INFO(I)%ID
  IF(IOS.NE.0)RETURN
 ENDDO
 CLOSE(IU)

 ALLOCATE(DXC%LABEL(4))
 DXC%LABEL(1)='Layer-Number'
 DXC%LABEL(2)='Row-Number'
 DXC%LABEL(3)='Column-Number'
 DXC%LABEL(4)='Unique-ID'

 MSPINSPECTOR_OPENFILES_DXC=.TRUE.

 END FUNCTION MSPINSPECTOR_OPENFILES_DXC

 !###======================================================================
 LOGICAL FUNCTION MSPINSPECTOR_OPENFILES_PARASIM(IU)
 !###======================================================================
 IMPLICIT NONE
 INTEGER,INTENT(OUT) :: IU
 INTEGER :: IOS

 MSPINSPECTOR_OPENFILES_PARASIM=.FALSE.

 !## netwerk inlezen ... paramsim.inp
 IU=UTL_GETUNIT(); OPEN(IU,FILE=TRIM(ROOT)//'\'//TRIM(MNAME)//'\PARA_SIM.INP',STATUS='OLD',ACTION='READ',IOSTAT=IOS)
 IF(IOS.NE.0)RETURN

 CALL IDFNULLIFY(MSPIDF)
 DO
  READ(IU,'(A)',IOSTAT=IOS) LINE; IF(IOS.NE.0)EXIT
  IF(INDEX(UTL_CAP(LINE,'U'),'IDF_XMIN').GT.0)READ(LINE(INDEX(LINE,'=',.TRUE.)+1:),*) MSPIDF%XMIN
  IF(INDEX(UTL_CAP(LINE,'U'),'IDF_YMIN').GT.0)READ(LINE(INDEX(LINE,'=',.TRUE.)+1:),*) MSPIDF%YMIN
  IF(INDEX(UTL_CAP(LINE,'U'),'IDF_DX').GT.0)  READ(LINE(INDEX(LINE,'=',.TRUE.)+1:),*) MSPIDF%DX
  IF(INDEX(UTL_CAP(LINE,'U'),'IDF_DY').GT.0)  READ(LINE(INDEX(LINE,'=',.TRUE.)+1:),*) MSPIDF%DY
  IF(INDEX(UTL_CAP(LINE,'U'),'IDF_NCOL').GT.0)READ(LINE(INDEX(LINE,'=',.TRUE.)+1:),*) MSPIDF%NCOL
  IF(INDEX(UTL_CAP(LINE,'U'),'IDF_NROW').GT.0)READ(LINE(INDEX(LINE,'=',.TRUE.)+1:),*) MSPIDF%NROW
 ENDDO
 CLOSE(IU)

 MSPIDF%XMAX=MSPIDF%XMIN+MSPIDF%DX*MSPIDF%NCOL
 MSPIDF%YMAX=MSPIDF%YMIN+MSPIDF%DY*MSPIDF%NROW
 MSPIDF%NODATA=HUGE(1.0D0)
 IF(.NOT.IDFALLOCATEX(MSPIDF))RETURN; MSPIDF%X=0.0D0

 MSPINSPECTOR_OPENFILES_PARASIM=.TRUE.

 END FUNCTION MSPINSPECTOR_OPENFILES_PARASIM

 !###======================================================================
 LOGICAL FUNCTION MSPINSPECTOR_OPENFILES_MOD2SVAT(IU)
 !###======================================================================
 IMPLICIT NONE
 INTEGER,INTENT(OUT) :: IU
 INTEGER :: I,N,IOS

 MSPINSPECTOR_OPENFILES_MOD2SVAT=.FALSE.

 !## allocate memory - mainly number of svats
 IU=UTL_GETUNIT(); OPEN(IU,FILE=TRIM(ROOT)//'\'//TRIM(MNAME)//'\MOD2SVAT.INP',STATUS='OLD',ACTION='READ',IOSTAT=IOS)
 IF(IOS.NE.0)RETURN

 ALLOCATE(MODSVAT%INFO(1),STAT=IOS); IF(IOS.NE.0)RETURN
 DO I=1,2
  MODSVAT%MXID=0; N=1
  DO
   READ(IU,'(I10,2X,I10,I5)',IOSTAT=IOS) MODSVAT%INFO(N)%UNID,MODSVAT%INFO(N)%NUND,MODSVAT%INFO(N)%LYBE
   IF(IOS.NE.0)EXIT; MODSVAT%MXID=MODSVAT%MXID+1
   IF(I.EQ.2)THEN; N=N+1; IF(N.GT.MODSVAT%MXID)EXIT; ENDIF
  ENDDO
  IF(I.EQ.1)THEN; DEALLOCATE(MODSVAT%INFO); ALLOCATE(MODSVAT%INFO(MODSVAT%MXID),STAT=IOS); IF(IOS.NE.0)RETURN; ENDIF
  REWIND(IU)
 ENDDO
 CLOSE(IU)

 ALLOCATE(MODSVAT%LABEL(3))
 MODSVAT%LABEL(1)='Unique-ID'
 MODSVAT%LABEL(2)='SVAT-ID'
 MODSVAT%LABEL(3)='Layer'

 MSPINSPECTOR_OPENFILES_MOD2SVAT=.TRUE.

 END FUNCTION MSPINSPECTOR_OPENFILES_MOD2SVAT

 !###======================================================================
 LOGICAL FUNCTION MSPINSPECTOR_OPENFILES_IDF2SVAT(IU)
 !###======================================================================
 IMPLICIT NONE
 INTEGER,INTENT(OUT) :: IU
 INTEGER :: I,N,IOS

 MSPINSPECTOR_OPENFILES_IDF2SVAT=.FALSE.

 !## allocate memory - mainly number of svats
 IU=UTL_GETUNIT(); OPEN(IU,FILE=TRIM(ROOT)//'\'//TRIM(MNAME)//'\IDF_SVAT.INP',STATUS='OLD',ACTION='READ',IOSTAT=IOS)
 IF(IOS.NE.0)RETURN

 ALLOCATE(IDFSVAT%INFO(1),STAT=IOS); IF(IOS.NE.0)RETURN
 DO I=1,2
  IDFSVAT%MXID=0; N=1
  DO
   READ(IU,'(3I10)',IOSTAT=IOS) IDFSVAT%INFO(N)%NUND,IDFSVAT%INFO(N)%IROW,IDFSVAT%INFO(N)%ICOL !,IDFSVAT(N)%X,IDFSVAT(N)%Y
   IF(IOS.NE.0)EXIT; IDFSVAT%MXID=IDFSVAT%MXID+1
   IF(I.EQ.2)THEN; N=N+1; IF(N.GT.IDFSVAT%MXID)EXIT; ENDIF
  ENDDO
  IF(I.EQ.1)THEN; DEALLOCATE(IDFSVAT%INFO); ALLOCATE(IDFSVAT%INFO(IDFSVAT%MXID),STAT=IOS); IF(IOS.NE.0)RETURN; ENDIF
  REWIND(IU)
 ENDDO
 CLOSE(IU)

 ALLOCATE(IDFSVAT%LABEL(3))
 IDFSVAT%LABEL(1)='SVAT-ID'
 IDFSVAT%LABEL(2)='Row-Number'
 IDFSVAT%LABEL(3)='Column-Number'

 MSPINSPECTOR_OPENFILES_IDF2SVAT=.TRUE.

 END FUNCTION MSPINSPECTOR_OPENFILES_IDF2SVAT

 !###======================================================================
 LOGICAL FUNCTION MSPINSPECTOR_OPENFILES_AREASVAT(IU)
 !###======================================================================
 IMPLICIT NONE
 INTEGER,INTENT(OUT) :: IU
 INTEGER :: I,IOS,N

 MSPINSPECTOR_OPENFILES_AREASVAT=.FALSE.

 !## allocate memory - mainly number of svats
 IU=UTL_GETUNIT(); OPEN(IU,FILE=TRIM(ROOT)//'\'//TRIM(MNAME)//'\AREA_SVAT.INP',STATUS='OLD',ACTION='READ',IOSTAT=IOS)
 IF(IOS.NE.0)RETURN

 ALLOCATE(AREASVAT%INFO(1),STAT=IOS); IF(IOS.NE.0)RETURN
 DO I=1,2
  AREASVAT%MXID=0; N=1
  DO
   READ(IU,'(I10,F10.1,F8.3,8X,I6,16X,I6,F8.3,I10,2F8.3)',IOSTAT=IOS) AREASVAT%INFO(N)%NUND,AREASVAT%INFO(N)%ARND, &
     AREASVAT%INFO(N)%SURF,AREASVAT%INFO(N)%SOIL,AREASVAT%INFO(N)%LUSE,AREASVAT%INFO(N)%RZ,AREASVAT%INFO(N)%METE
   IF(IOS.NE.0)EXIT; AREASVAT%MXID=AREASVAT%MXID+1
   IF(I.EQ.2)THEN; N=N+1; IF(N.GT.AREASVAT%MXID)EXIT; ENDIF
  ENDDO
  IF(I.EQ.1)THEN; DEALLOCATE(AREASVAT%INFO); ALLOCATE(AREASVAT%INFO(AREASVAT%MXID),STAT=IOS); IF(IOS.NE.0)RETURN; ENDIF
  REWIND(IU)
 ENDDO
 CLOSE(IU)

 ALLOCATE(AREASVAT%LABEL(7))
 AREASVAT%LABEL(1)='SVAT-ID'
 AREASVAT%LABEL(2)='Area'
 AREASVAT%LABEL(3)='Surface-Elevation'
 AREASVAT%LABEL(4)='Soil-Type'
 AREASVAT%LABEL(5)='Land-Use'
 AREASVAT%LABEL(6)='Root-Zone'
 AREASVAT%LABEL(7)='Meteo-Station'

 MSPINSPECTOR_OPENFILES_AREASVAT=.TRUE.

 END FUNCTION MSPINSPECTOR_OPENFILES_AREASVAT

 !###======================================================================
 SUBROUTINE MSPINSPECTOR_PLOTLOC() !X,Y,ICODE)
 !###======================================================================
 IMPLICIT NONE
! INTEGER,INTENT(IN) :: ICODE
! REAL(KIND=DP_KIND),INTENT(IN) :: X,Y
! INTEGER :: I,IROW,ICOL,N
 !
 !!## remove all rectangles
 !IF(ICODE.EQ.0)THEN
 ! DO I=1,N; CALL UTL_PLOTLOCATIONIDF(IDF(I),IPOSIDF(1,I),IPOSIDF(2,I)); ENDDO
 !ELSE
 ! DO I=1,N
 !  IF(IDF(I)%XMIN.LE.X.AND.IDF(I)%XMAX.GE.X.AND. &
 !     IDF(I)%YMIN.LE.Y.AND.IDF(I)%YMAX.GE.Y)THEN
 !   CALL IGRCOLOURN(UTL_INVERSECOLOUR(ICOLORIDF(I)))
 !   CALL IDFIROWICOL(IDF(I),IROW,ICOL,X,Y)
 !   IF(IROW.NE.IPOSIDF(1,I).OR.ICOL.NE.IPOSIDF(2,I))THEN
 !    !## remove it, previous one
 !    CALL UTL_PLOTLOCATIONIDF(IDF(I),IPOSIDF(1,I),IPOSIDF(2,I))
 !    !## plot new one
 !    IF(ICODE.EQ.1)CALL UTL_PLOTLOCATIONIDF(IDF(I),IROW,ICOL)
 !    IPOSIDF(1,I)=IROW
 !    IPOSIDF(2,I)=ICOL
 !   ENDIF
 !  ENDIF
 ! ENDDO
 !ENDIF

 END SUBROUTINE MSPINSPECTOR_PLOTLOC

 !###======================================================================
 SUBROUTINE MSPINSPECTOR_GETXY()
 !###======================================================================
 IMPLICIT NONE
 TYPE(WIN_MESSAGE) :: MESSAGE
 INTEGER :: ITYPE,I,J,IPLOT,IROW,ICOL,KSHAPE,IDOWN, &
            IR1,IR2,IC1,IC2,NPOL,N,MAXNIDF,IOPT
 REAL(KIND=DP_KIND) :: XC1,YC1,XC2,XC3,YC2,YC3,IDFVAL,IDFSUM,XCHECK,YCHECK,MOUSEX,MOUSEY
 LOGICAL :: LEX

! !  FR lijst uit imod manager halen?
! !CALL IDFGETVALUE_FIELDS(0)

! ! FR schermpje voor waarden openen?
! !CALL WDIALOGLOAD(ID_DIDFINFO,ID_DIDFINFO)
! !MAXNIDF=WINFOGRID(IDF_GRID1,GRIDROWSMAX)

! ! FR alle IDF's openen? 
! NIDFS=0
! DO IPLOT=1,MXMPLOT
!  IF(MP(IPLOT)%ISEL.AND.(MP(IPLOT)%IPLOT.EQ.1.OR.MP(IPLOT)%IPLOT.EQ.5))THEN
!   IF(MP(IPLOT)%IPLOT.EQ.5)THEN
!    IF(READMDF(MP(IPLOT)%IDFNAME,N))THEN
!     NIDFS=NIDFS+N
!    ENDIF
!   ELSE
!    NIDFS=NIDFS+1
!   ENDIF
!  ENDIF
! ENDDO
!
! IF(NIDFS.GT.MAXNIDF.OR.NIDFS.LE.0)THEN
!  CALL IDFGETVALUE_CLOSE()
!  IF(NIDFS.GT.MAXNIDF)CALL WMESSAGEBOX(OKONLY,EXCLAMATIONICON,COMMONOK,'There is a maximum of '//TRIM(ITOS(MAXNIDF))// &
!   ' you can select simultaneously.'//CHAR(13)//'Currenty '//TRIM(ITOS(NIDFS))//' IDF files are selected.','Error')
!  IF(NIDFS.LE.0)CALL WMESSAGEBOX(OKONLY,EXCLAMATIONICON,COMMONOK,'No IDFs selected.','Error')
!  RETURN
! ENDIF
!
!   
! CALL IDFGETVALUE_OPENFILES()
!
! CALL WINDOWSELECT(0)
! IF(WMENUGETSTATE(ID_IDFSHAPEVALUEPOINTS,2).EQ.1)   KSHAPE=ID_POINT
! IF(WMENUGETSTATE(ID_IDFSHAPEVALUERECTANGLE,2).EQ.1)KSHAPE=ID_RECTANGLE
! IF(WMENUGETSTATE(ID_IDFSHAPEVALUEPOLYGON,2).EQ.1)  KSHAPE=ID_POLYGON
! IF(WMENUGETSTATE(ID_IDFSHAPEVALUECIRCLE,2).EQ.1)   KSHAPE=ID_CIRCLE
!
! IF(WMENUGETSTATE(ID_IDFGETVALUE_NONE,2).EQ.1)      ISHOW=0
! IF(WMENUGETSTATE(ID_IDFGETVALUE_FIRST,2).EQ.1)     ISHOW=1
! IF(WMENUGETSTATE(ID_IDFGETVALUE_ALL,2).EQ.1)       ISHOW=2
!
! SELECT CASE (KSHAPE)
!  CASE (ID_POINT)
!   CALL WCURSORSHAPE(ID_CURSORIDFVALUE)
!  CASE (ID_CIRCLE)
!   CALL WCURSORSHAPE(ID_CURSORCIRCLE)
!  CASE (ID_RECTANGLE)
!  CALL WCURSORSHAPE(ID_CURSORRECTANGLE)
!  CASE (ID_POLYGON)
!   ALLOCATE(XPOL(MAXPOL),YPOL(MAXPOL))
!   NPOL=0
!   CALL WCURSORSHAPE(ID_CURSORPOLYGON)
! END SELECT
!
 
 CALL WDIALOGSELECT(ID_DMSPANALYSER_TAB2)
 i=779
 CALL WGRIDPUTCELLINTEGER(IDF_GRID1,2,1,MODSVAT%INFO(i)%UNID)
 CALL WGRIDPUTCELLINTEGER(IDF_GRID1,3,1,MODSVAT%INFO(i)%NUND)
 CALL WGRIDPUTCELLINTEGER(IDF_GRID1,4,1,MODSVAT%INFO(i)%LYBE)
 

 CALL WDIALOGSELECT(ID_DMSPANALYSER_TAB4)
 CALL WGRIDROWS(IDF_GRID3,5)

 DO I=1,4
   DO J=1,3
     CALL WGRIDPUTCELLINTEGER(IDF_GRID3,i,j,i*10+j)
   END DO 
 END DO
 
!
! CALL WDIALOGSHOW(-0,65,0,2)
!
! IF(KSHAPE.NE.ID_POINT)THEN
!  CALL IGRPLOTMODE(MODEXOR)
!  CALL IGRCOLOURN(WRGB(255,255,255))
!  CALL IGRFILLPATTERN(HATCHED,MEDIUM,DIAGUP)
!  CALL IGRLINETYPE(SOLIDLINE)
!  IDOWN=0
!  LEX  =.FALSE.
!  XC1  =0.0D0
!  YC1  =0.0D0
! ELSE
!  IDOWN=1
! ENDIF
! XC2=0.0D0
! YC2=0.0D0
! 
! !## get settings for data type options
! CALL WDIALOGFIELDOPTIONS(IDF_INTEGER2,3,1)
! CALL WDIALOGRANGEINTEGER(IDF_INTEGER2,1,7)
! CALL WDIALOGPUTINTEGER(IDF_INTEGER2,DECPLACES)
! CALL WDIALOGPUTOPTION(IDF_MENU1,IFORM)
! 
! !## initialize indices
! IROW=0; ICOL=0
! 
! DO
!  CALL WMESSAGE(ITYPE,MESSAGE)
!
!  !## shift mouse coordinates
!  MOUSEX=DBLE(MESSAGE%GX)+OFFSETX
!  MOUSEY=DBLE(MESSAGE%GY)+OFFSETY
!
!  SELECT CASE (ITYPE)
!
!   CASE (MENUSELECT)
!    CALL IDFGETVALUE_FIELDS(1)
!    !## reopen files since they were closed after drawing!
!    CALL IDFGETVALUE_OPENFILES()
!    CALL IDFGETVALUE_FIELDS(0)
!    !## reset cursor
!    CALL WCURSORSHAPE(ID_CURSORIDFVALUE)
!    XC2=0.0D0
!    YC2=0.0D0
!   
!   !## case field changed
!   CASE (FIELDCHANGED)
!    SELECT CASE (MESSAGE%VALUE1)
!     CASE (IDF_INTEGER2,IDF_MENU1)
!      DO I=1,NIDFS
!       !## get value for current irow/icol per idf
!       IF(IROW.GT.IDF(I)%NROW.OR.IROW.LE.0.OR.ICOL.GT.IDF(I)%NCOL.OR.ICOL.LE.0)THEN
!        CALL WGRIDPUTCELLSTRING(IDF_GRID1,2,I,'')
!       ELSE
!        IDFVAL=IDFGETVAL(IDF(I),IROW,ICOL)
!        CALL IDFGETVALUE_SETPLACES(I,IDFVAL,IDF(I)%NODATA)
!       ENDIF
!      ENDDO
!    END SELECT
!    
!   !## mouse-move
!   CASE (MOUSEMOVE)
!
!    CALL WINDOWSELECT(0)
!    CALL WINDOWOUTSTATUSBAR(1,'x = '//TRIM(RTOS(MOUSEX,'F',3))//' m; y = '//TRIM(RTOS(MOUSEY,'F',3))//' m')
!    
!    IF(IDOWN.EQ.1)THEN
!     CALL WDIALOGSELECT(ID_DIDFINFO)
!     CALL WDIALOGPUTSTRING(IDF_GROUP1,'Current Location x ='//TRIM(RTOS(MOUSEX,'F',3))// &
!                                       ' m; y ='//TRIM(RTOS(MOUSEY,'F',3))//' m')
!    ENDIF
!    
!    XC2=MOUSEX 
!    YC2=MOUSEY 
!
!    !## plot new one (and remove previous one(s))
!    IF(KSHAPE.EQ.ID_POINT)THEN
!     IF(IDOWN.EQ.1)CALL IDFGETVALUE_PLOTLOC(XC2,YC2,1)
!    ELSE
!     CALL IDFGETVALUE_PLOTLOC(XC2,YC2,1)
!    ENDIF
!
!    !## first point set!
!    SELECT CASE (KSHAPE)
!
!     CASE (ID_RECTANGLE)
!
!      IF(IDOWN.EQ.1)THEN
!       CALL UTL_PLOT1BITMAP()
!       IF(LEX)CALL DBL_IGRRECTANGLE(XC1,YC1,XC3,YC3,IOFFSET=1)
!       LEX=.FALSE.
!       IF(XC1.NE.XC2.AND.YC1.NE.YC2)LEX=.TRUE.
!       IF(LEX)CALL DBL_IGRRECTANGLE(XC1,YC1,XC2,YC2,IOFFSET=1)
!       CALL UTL_PLOT2BITMAP()
!
!       CALL WDIALOGSELECT(ID_DIDFINFO)
!       DO I=1,NIDFS
!        !## get min/max irow/icol current idf
!        CALL IDFIROWICOL(IDF(I),IR2,IC1,MIN(XC1,XC2),MIN(YC1,YC2))
!        CALL IDFIROWICOL(IDF(I),IR1,IC2,MAX(XC1,XC2),MAX(YC1,YC2))
!        CALL WGRIDPUTCELLSTRING(IDF_GRID1,3,NIDFS,'C'//TRIM(ITOS(IC1))//'-'//TRIM(ITOS(IC2))// &
!                                                 ';R'//TRIM(ITOS(IR1))//'-'//TRIM(ITOS(IR2)))
!        IDFSUM=0.0D0
!        N     =0
!        DO IROW=MAX(1,IR1),MIN(IR2,IDF(I)%NROW)
!         DO ICOL=MAX(1,IC1),MIN(IC2,IDF(I)%NCOL)
!          IDFVAL=IDFGETVAL(IDF(I),IROW,ICOL,IUNITS(I))
!          IF(IDFVAL.NE.IDF(I)%NODATA)THEN
!           N     =N+1
!           IDFSUM=IDFSUM+IDFVAL
!          ENDIF
!         ENDDO
!        END DO
!        IF(N.GT.0)IDFSUM=IDFSUM/REAL(N,8)
!!        CALL IDFGETVALUE_COLOURCELL(IDF_GRID1,2,I,IDFSUM)
!        CALL IDFGETVALUE_SETPLACES(I,IDFSUM,IDF(I)%NODATA)
!       END DO
!      ENDIF
!
!      XC3=XC2
!      YC3=YC2
!
!     CASE (ID_POLYGON)
!
!      IF(NPOL.GT.0)THEN
!       CALL UTL_PLOT1BITMAP()
!       IF(LEX)THEN
!        XPOL(NPOL+1)=XC3
!        YPOL(NPOL+1)=YC3
!        CALL DBL_IGRPOLYGONCOMPLEX(XPOL,YPOL,NPOL+1,IOFFSET=1)
!       ENDIF
!       LEX=.TRUE.
!       XPOL(NPOL+1)=XC2
!       YPOL(NPOL+1)=YC2
!       CALL DBL_IGRPOLYGONCOMPLEX(XPOL,YPOL,NPOL+1,IOFFSET=1)
!       CALL UTL_PLOT2BITMAP()
!
!       CALL WDIALOGSELECT(ID_DIDFINFO)
!       DO I=1,NIDFS
!        !## get min/max irow/icol current idf
!        CALL IDFIROWICOL(IDF(I),IR2,IC1,MINVAL(XPOL(1:NPOL+1)),MINVAL(YPOL(1:NPOL+1)))
!        CALL IDFIROWICOL(IDF(I),IR1,IC2,MAXVAL(XPOL(1:NPOL+1)),MAXVAL(YPOL(1:NPOL+1)))
!        CALL WGRIDPUTCELLSTRING(IDF_GRID1,3,NIDFS,'C'//TRIM(ITOS(IC1))//'-'//TRIM(ITOS(IC2))// &
!                                                 ';R'//TRIM(ITOS(IR1))//'-'//TRIM(ITOS(IR2)))
!        IDFSUM=0.0D0
!        N     =0
!        DO IROW=MAX(1,IR1),MIN(IR2,IDF(I)%NROW)
!         DO ICOL=MAX(1,IC1),MIN(IC2,IDF(I)%NCOL)
!          CALL IDFGETLOC(IDF(I),IROW,ICOL,XCHECK,YCHECK)
!          IF(DBL_IGRINSIDEPOLYGON(XCHECK,YCHECK,XPOL,YPOL,NPOL+1).EQ.1)THEN
!           IDFVAL=IDFGETVAL(IDF(I),IROW,ICOL,IUNITS(I))
!           IF(IDFVAL.NE.IDF(I)%NODATA)THEN
!            N     =N+1
!            IDFSUM=IDFSUM+IDFVAL
!           ENDIF
!          ENDIF
!         ENDDO
!        END DO
!        IF(N.GT.0)IDFSUM=IDFSUM/REAL(N,8)
!!        CALL IDFGETVALUE_COLOURCELL(IDF_GRID1,2,I,IDFSUM)
!        CALL IDFGETVALUE_SETPLACES(I,IDFSUM,IDF(I)%NODATA)
!       END DO
!       XC3=XC2
!       YC3=YC2
!      ENDIF
!
!     CASE (ID_POINT)
!      
!      IF(IDOWN.EQ.1)THEN
!       CALL WDIALOGSELECT(ID_DIDFINFO)
!       DO I=1,NIDFS
!        !## get irow/icol current idf
!        CALL IDFIROWICOL(IDF(I),IROW,ICOL,MOUSEX,MOUSEY)
!        !## print location
!        IF(IROW.GT.IDF(I)%NROW.OR.IROW.LE.0.OR.ICOL.GT.IDF(I)%NCOL.OR.ICOL.LE.0)THEN
!         CALL WGRIDPUTCELLSTRING(IDF_GRID1,3,I,'Outside Domain')
!         CALL WGRIDCLEARCELL(IDF_GRID1,2,I)
!        ELSE
!         CALL WGRIDPUTCELLSTRING(IDF_GRID1,3,I,'C'//TRIM(ITOS(ICOL))//';R'//TRIM(ITOS(IROW)))
!         !## get grid parameter ieq (equidim vs. var)
!         IDFVAL=IDFGETVAL(IDF(I),IROW,ICOL,IUNITS(I))
!         CALL IDFGETVALUE_SETPLACES(I,IDFVAL,IDF(I)%NODATA)
!        ENDIF
!       END DO
!      ENDIF
!
!    END SELECT
!    
!   CASE (PUSHBUTTON)
!    SELECT CASE (MESSAGE%VALUE1)
!     CASE (IDHELP)
!      CALL UTL_GETHELP('2','GettingStarted') 
!     CASE (IDCANCEL)
!      EXIT
!    END SELECT
!
!   CASE (MOUSEBUTDOWN)
!    SELECT CASE (KSHAPE)
!
!     CASE (ID_POINT)
!      SELECT CASE (MESSAGE%VALUE1)
!       CASE (RIGHTBUTTON)
!        EXIT
!       CASE (LEFTBUTTON)
!        IDOWN=ABS(IDOWN-1)
!      END SELECT
!     CASE (ID_RECTANGLE)
!      IF(IDOWN.EQ.0)THEN
!       XC1=XC2
!       YC1=YC2
!       IDOWN=1
!      ELSE
!       CALL UTL_PLOT1BITMAP()
!       IF(LEX)CALL DBL_IGRRECTANGLE(XC1,YC1,XC3,YC3)
!       CALL UTL_PLOT2BITMAP()
!       EXIT
!      ENDIF
!
!     CASE (ID_POLYGON)
!      SELECT CASE (MESSAGE%VALUE1)
!       CASE (1)  !## left button
!        NPOL=NPOL+1
!        XPOL(NPOL)=XC2
!        YPOL(NPOL)=YC2
!
!       CASE (3)  !## right button
!        IF(NPOL.GT.0)THEN
!         CALL UTL_PLOT1BITMAP()
!         IF(LEX)CALL DBL_IGRPOLYGONCOMPLEX(XPOL,YPOL,NPOL+1)
!         CALL UTL_PLOT2BITMAP()
!        ENDIF
!        EXIT
!      END SELECT
!
!    END SELECT
!
!   !## bitmap scrolled, renew top-left pixel coordinates
!   CASE (BITMAPSCROLLED)
!    MPW%IX=MESSAGE%VALUE1
!    MPW%IY=MESSAGE%VALUE2
!
!   CASE (EXPOSE)
!     IF(WMENUGETSTATE(ID_PLOTLEGEND,2).EQ.1)CALL LEGPLOT_PLOTUPDATE()
!     CALL DBL_IGRUNITS(MPW%XMIN,MPW%YMIN,MPW%XMAX,MPW%YMAX,IOFFSET=1)
!     CALL WDIALOGSELECT(ID_DIDFINFO)
!
!  END SELECT
! END DO
!
! !## remove everything
! CALL IDFGETVALUE_PLOTLOC(XC2,YC2,0)
!
! CALL WCURSORSHAPE(CURARROW)
! IF(KSHAPE.NE.ID_POINT)THEN
!  CALL IGRPLOTMODE(MODECOPY)
!  CALL IGRFILLPATTERN(OUTLINE)
!  CALL IGRLINETYPE(SOLIDLINE)
! ENDIF
!
! !## close files
! CALL IDFGETVALUE_CLOSE()
!
! IF(ALLOCATED(XPOL))DEALLOCATE(XPOL)
! IF(ALLOCATED(YPOL))DEALLOCATE(YPOL)

 END SUBROUTINE MSPINSPECTOR_GETXY
 
 !###======================================================================
 SUBROUTINE MSPINSPECTOR_MAIN_FIELDS()
 !###======================================================================
 IMPLICIT NONE

 END SUBROUTINE MSPINSPECTOR_MAIN_FIELDS

 !###======================================================================
 SUBROUTINE MSPINSPECTOR_TAB1_FIELDS()
 !###======================================================================
 IMPLICIT NONE

 INTEGER :: I

 CALL WDIALOGSELECT(ID_DMSPANALYSER_TAB1)
 CALL WDIALOGGETRADIOBUTTON(IDF_RADIO1,I)
 CALL WDIALOGFIELDSTATE(IDF_STRING1,I)
 CALL WDIALOGFIELDSTATE(ID_OPEN2,I)

 END SUBROUTINE MSPINSPECTOR_TAB1_FIELDS

 !###======================================================================
 SUBROUTINE MSPINSPECTOR_TAB2_FIELDS()
 !###======================================================================
 IMPLICIT NONE

 END SUBROUTINE MSPINSPECTOR_TAB2_FIELDS

 !###======================================================================
 SUBROUTINE MSPINSPECTOR_TAB3_FIELDS()
 !###======================================================================
 IMPLICIT NONE

 END SUBROUTINE MSPINSPECTOR_TAB3_FIELDS

 !###======================================================================
 SUBROUTINE MSPINSPECTOR_TAB4_FIELDS()
 !###======================================================================
 IMPLICIT NONE

 END SUBROUTINE MSPINSPECTOR_TAB4_FIELDS

 !###======================================================================
 SUBROUTINE MSPINSPECTOR_TAB5_FIELDS()
 !###======================================================================
 IMPLICIT NONE

 INTEGER :: I

 CALL WDIALOGSELECT(ID_DMSPANALYSER_TAB5)
 CALL WDIALOGGETRADIOBUTTON(IDF_RADIO1,I)
 CALL WDIALOGFIELDSTATE(ID_OPEN2,I)
   
 CALL WDIALOGFIELDSTATE(IDF_LABEL1,abs(i-1))
 CALL WDIALOGFIELDSTATE(IDF_LABEL2,abs(i-1))
 CALL WDIALOGFIELDSTATE(IDF_MENU5,abs(i-1))
 CALL WDIALOGFIELDSTATE(IDF_MENU6,abs(i-1))
 CALL WDIALOGFIELDSTATE(IDF_INTEGER1,abs(i-1))
 CALL WDIALOGFIELDSTATE(IDF_INTEGER2,abs(i-1))
 CALL WDIALOGFIELDSTATE(IDF_INTEGER3,abs(i-1))
 CALL WDIALOGFIELDSTATE(IDF_INTEGER4,abs(i-1))
 CALL WDIALOGFIELDSTATE(IDF_INTEGER5,abs(i-1))
 CALL WDIALOGFIELDSTATE(IDF_INTEGER11,abs(i-1))
 CALL WDIALOGFIELDSTATE(IDF_INTEGER12,abs(i-1))
 CALL WDIALOGFIELDSTATE(IDF_INTEGER13,abs(i-1))
 CALL WDIALOGFIELDSTATE(IDF_INTEGER14,abs(i-1))
 CALL WDIALOGFIELDSTATE(IDF_INTEGER15,abs(i-1))

 END SUBROUTINE MSPINSPECTOR_TAB5_FIELDS

!###======================================================================
 SUBROUTINE MSPINSPECTOR_INIT()
 !###======================================================================
 IMPLICIT NONE

 CALL WINDOWSELECT(0)
 IF(WMENUGETSTATE(ID_MSPANALYSER,2).EQ.1)THEN
  CALL MSPINSPECTOR_CLOSE(); RETURN
 ENDIF

 CALL MAIN_UTL_INACTMODULE(ID_MSPANALYSER)

 !## other module not closed, no approvement given to start this functionality
 IF(IDIAGERROR.EQ.1)RETURN

 CALL WMENUSETSTATE(ID_MSPANALYSER,2,1)

 CALL WDIALOGLOAD(ID_DMSPANALYSER,ID_DMSPANALYSER); CALL WDIALOGSHOW(-1,-1,0,2)
 CALL WDIALOGSELECT(ID_DMSPANALYSER_TAB1)
 CALL WDIALOGPUTIMAGE(ID_OPEN2,ID_ICONOPEN)
 CALL WDIALOGFIELDOPTIONS(IDF_STRING1,EDITFIELDCHANGED,ENABLED)

 !## fill front tab
 CALL MSPINSPECTOR_TAB1_FIELDS()
 CALL MSPINSPECTOR_FILL_FOLDERLIST()

 !## initial outgrey tabs
 CALL WDIALOGSELECT(ID_DMSPANALYSER)
 CALL WDIALOGFIELDSTATE(IDOK,0)
 CALL WDIALOGTABSTATE(IDF_TAB1,ID_DMSPANALYSER_TAB2,0)
 CALL WDIALOGTABSTATE(IDF_TAB1,ID_DMSPANALYSER_TAB3,0)
 CALL WDIALOGTABSTATE(IDF_TAB1,ID_DMSPANALYSER_TAB4,0)
 CALL WDIALOGTABSTATE(IDF_TAB1,ID_DMSPANALYSER_TAB5,0)

 !## fill tabs 2 
 CALL WDIALOGSELECT(ID_DMSPANALYSER_TAB2)
    CALL WGRIDPUTCELLSTRING(IDF_GRID1,1,1,"Rural")
    CALL WGRIDPUTCELLSTRING(IDF_GRID1,1,2,"Irrigation")
    CALL WGRIDPUTCELLSTRING(IDF_GRID1,1,3,"Urban")
    CALL WGRIDPUTCELLSTRING(IDF_GRID1,1,4,"Nopp")
 
    CALL WGRIDPUTCELLSTRING(IDF_GRID3,1,1,"SVAT_ID")
    CALL WGRIDPUTCELLSTRING(IDF_GRID3,1,2,"Mouse")

 !## fill tabs 4
 CALL WDIALOGSELECT(ID_DMSPANALYSER_TAB4)
 CALL WDIALOGPUTIMAGE(IDF_PICTURE1,ID_ICONIRRIGATION1,1)
 CALL WDIALOGPUTIMAGE(IDF_PICTURE2,ID_ICONIRRIGATION2,1)
 
 !## fill tabs 5
 CALL WDIALOGSELECT(ID_DMSPANALYSER_TAB5)
 CALL WDIALOGPUTIMAGE(ID_OPEN1,ID_ICONOPEN,1)
 CALL WDIALOGPUTIMAGE(ID_OPEN2,ID_ICONSAVEAS,1)

 END SUBROUTINE MSPINSPECTOR_INIT

END MODULE MOD_MSPINSPECTOR
